# 后端圈问答全集 v1.0

## 声明 

**本文档所有权属于 后端圈 和 simviso 所有**

![1564415636555](后端圈问答全集.assets/1564415636555.png)

![1564417307973](后端圈问答全集.assets/1564417307973.png)



## 目录

[TOC]



## **周报 No.52**

### 1**.**反应式编程的状态保存与传递

>  **Java**    [2018-12-25]



[**北京-后端-张帆**]  在反应式编程中，如果涉及到了状态保存与传递，应该如何处理呢?

![image.png](后端圈问答全集.assets/1546694049814-6ee3c565-7c65-45d5-9e0b-0a9c74ecb3da.png)



➤ 问题解答



[**北京-后端-张帆**] 反应式里 Mono<T> 是个 code publisher，如果想要在一个观察过程结束（也就是去获得响应的过程）后再次消费，可以再观察一遍 Mono<T> ，这样就不存在状态保存与传递。

**[上海-后端-知秋]** 可以通过 Reactor 中的 Context 来实现。Context 在 Rxjava 中没有的，也就是 Reactor 专门提供给后端开发来应对这种情况的，因为在响应式调度的情况下，ThreadLocal 已经显得很鸡肋，而且很容易泄漏信息，所以响应式编程是禁用 ThreadLocal 的。



### **2.**业务中如何使用分布式事务来保证数据一致性

> **Java**   [2018-12-25]



[**北京-java-西希家**][**西安-java-夏夏xi**] 业务中如何使用分布式事务来保证数据一致性？



➤ 问题解答



[**杭州-后端-梁桂钊**] 分布式事务可以分成强一致性和最终一致性两种方案。对于强一致性，可以了解下「二阶段提交协议」、「三阶段提交协议」。但是，强一致性存在一些问题，因此生产环境中更多的是利用最终一致性的方案。对于，TCC 和 saga 可以查阅一下相关材料。这里，想分享一下可靠消息投递的方案。


![image.png](后端圈问答全集.assets/1546695049532-603c4f20-c676-41ad-b1a7-806ff9f0f988.png)



消息队列发生消息后，可能消费者宕机而无法消费。绝大多数消息中间件对于这种情况，例如 RabbitMQ、RocketMQ 等引入了 ACK 机制。注意的是，默认的情况下，采用自动应答，这种方式中消息队列会发送消息后立即从消息队列中删除该消息。所以，为了确保消息的可靠投递，我们通过手动 ACK 方式，如果消费者因宕机等原因没有发送 ACK，消息队列会将消息重新发送，保证消息的可靠性。从业务服务处理完相关业务后通过手动 ACK 通知消息队列，消息队列才从消息队列中删除该持久化消息。那么，消息队列如果一直重试失败而无法投递，就会出现消息主动丢弃的情况，我们需要如何解决呢？主业务服务将要发送的消息持久化到本地数据库。从业务服务消费成功后，它也会向消息队列发送一个通知消息，此时它是一个消息的生产者。消费者接收到消息后，最终把本地的持久化消息标志状态为“完成”状态。说到这里，我们应该可以理解到使用“正反向消息机制”确保了消息队列可靠事件投递。当然，补偿机制也是必不可少的。定时任务会从数据库扫描在一定时间内未完成的消息并重新投递。



> 「研习小组」在探讨过程中，探讨到 RPC 的同异步方式、超时控制、TCC框架的设计等。篇幅有限，暂不展开。



### **3.**怎么理解双重检验锁

> **Java**   [2018-12-24]



**[北京-打杂-火材]**  怎么理解双重检验锁（Double Check）？



➤ 问题解答



**[西安-java-健]** 缓存也用到双重锁校验，比如判断缓存是否存在， ` if( user == null )`  如果空，去查数据库，然后准备赋值的时候可能已经被更新过了，因此在赋值之前就需要再检查下`if( user == null )`。

**[杭州-后端-梁桂钊**][长沙-后端-陈同学]**[北京-java-犀利豆]单例模式中经常看到，但是实际生产中也经常使用。**



```
Cache<Object, AtomicReference<?>> cache = cacheMap.get(method);
if (cache == null) {
  synchronized (cacheMap) {
    cache = cacheMap.get(method);
  }
}
```



### **4.并发请求在5000左右的系统该如何设计**

> **架构**   [2018-12-28]



[**上海-后端-阿杰**] 一个并发请求在 5000 左右的系统需要如何设计？



➤ 相关讨论



**[杭州-后端-梁桂钊**][北京-java-犀利豆]** 本质上，这个问题探讨的是高并发系统怎么设计？这个问题比较范，我们暂时先不探讨业务复杂度和技术复杂度，纯粹的从技术层面来探讨问题。很多时候，数据存储是一个比较大的瓶颈，因此数据库层面需要支持分库分表，其次是读写分离。然后呢，通过引入缓存来减少数据库的压力，并且提高查询性能。

**[杭州-后端-梁桂钊][西安-java-夏夏xi][北京-java-犀利豆]**从架构层面，必须要集群和负载均衡。例如，我们项目中经常通过 nginx + tomcat 来实现。

[**上海-scala-面包**] [**深圳-Java-阿飞**] 采用 MQ 进行解耦和销峰填谷，起到限流的作用。

**[杭州-后端-梁桂钊**]**在高并发系统中，可用性（稳定性）也很重要。一般情况下，容量规划、自动伸缩，以及熔断+降级+限流+隔离都是需要考虑的。



### **5.关于dubbo异常处理**

>  **Dubbo**    [2018-12-29]

[**福州-Java-峰**] 关于 dubbo 异常处理，「阿里巴巴 Java 开发手册」建议 RPC 使用 Result 进行封装，只返回错误码和简短错误信息。而 「dubbo 官网最佳实践」建议携带异常，可以查看更多信息。各位在工作中是怎么实践的？

> 「阿里巴巴 Java 开发手册」：跨应用 RPC 调用优先考虑使用 isSuccess() 方法、“错误码”、“错误简短信息”。关于 RPC 方法返回方式使用 Result 方式的理由 : 1）使用抛异常返回方式，调用方如果没有捕获到，就会产生运行时错误。2）如果不加栈信息，只是 new 自定义异常，加入自己的理解的 error message，对于调用端解决问题的帮助不会太多。如果加了栈信息，在频繁调用出错的情况下，数据序列化和传输的性能损耗也是问题。
>
> 链接：https://book.douban.com/subject/27605355/



➤ 相关讨论



**[北京-java-犀利豆]** 我们的做法是自己封装了一组异常，其中，业务异常和运行时异常是分开的。对于，业务异常，我们用不是封装的 Result。对于，运行时异常，我们记录日志，然后返回一个统一的异常，不需要堆栈。自定义的业务异常直接抛出，代码运行时异常包装成一个统一的异常抛出，堆栈信息不包含在里面，通过日志输出定位问题时查看日志来确定。

**[杭州-后端-梁桂钊**]**我们的做法是遵守「阿里巴巴 Java 开发手册」，调用优先考虑使用 isSuccess() 方法、“错误码”、“错误简短信息”。

- 

```
public Result<XxxDTO> getXxx(String param) {
    try {
        // ...
        return Result.create(xxxDTO);
    } catch (XxxException e) {
        log.error("...", e);
        return Result.createErrorResult(e.getErrorCode(), e.getErrorInfo(), true);
    }
}
```



**[杭州-后端-梁桂钊]**分布式系统的日志查询，一般需要聚合查询，例如 ELK。此外，一个请求会涉及多个跨服务调要，而服务本身可能也会依赖其他服务，整个请求路径就构成了一个网状的调用链，而在整个调用链中一旦某个节点发生异常，整个调用链的稳定性就会受到影响 因此，分布式追踪功能必不可少，例如 SkyWalking。这里，特别推荐阅读：https://www.jianshu.com/p/e3d7c50651f6


![image.png](后端圈问答全集.assets/1546698720593-64857d6a-80ed-443d-8eb4-9c54ad148eba.png)



------

非常感谢「后端圈」小伙伴们的高质量技术交流，以及「研习小组」成员们的聚焦交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」与「研习小组」共同探讨，一起交流、探讨，打破认知的局限。（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**北京-后端-张帆** **（博客** **：Since1986** [https://since1986.github.io](https://since1986.github.io/)**）**
- ✅**上海-Java-知秋（博客 ：一叶知秋** [https://muyinchen.github.io](https://muyinchen.github.io/)**）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**北京-java-西希家**
- ✅**西安-java-夏夏xi**
- ✅**北京-补位-火柴**
- ✅**长沙-后端-陈同学**
- ✅**上海-scala-面包**
- ✅**深圳-Java-阿飞（公众号 ：阿飞的博客）**
- ✅**上海-后端-阿杰**
- ✅**福州-Java-峰**
- ✅**青南（书籍：《Python爬虫开发 从入门到实战》）**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## **周报 No.53（2019年）**

### **1.从600万个句子里移除符合要求的句子，最高效的办法是什么**

>  **实战**    [2019-01-02]



[**杭州-数据挖掘-青南**]  在Python里面，用1万个正则表达式从600万个句子里面移除所有符合要求的句子。请问最高效的办法是什么？

类似于敏感词句子剔除

```
C.M
M.*?P
```

这样的敏感词pattern有一万个。要从600万条句子里面把符合所有pattern的句子全部去掉，我现在用8个进程跑，半个小时还不到100万条。太慢了



➤ 问题解答



- [**harry**] 考虑下倒排索引

- [**杭州-数据挖掘-青南**]  倒排索引非常有效。现在76秒就能把整个流程走完，速度提高了100万倍。

------

### **2.关于InnDB事务恢复**

>  **MySQL**    [2019-01-03]  



[**杭州-java-菜鸟**] 有个问题想请教下大家 默认redolog每次事务提交从log buffer写入os缓冲区再刷入磁盘 假如在事务没有提交时发生宕机 那么inndb怎么根据redolog恢复未完成的事务



➤ 相关讨论



- [**harry**]

这个是可以配置的，有一个属性 sync on cimmit

![img](后端圈问答全集.assets/1546739588702-71699d91-d63e-4826-81ef-e3ebbb979b5c.png)

> @**harry** 我查了 0是每秒写入os buffer 并刷盘 1是每次提交写入并刷盘 2是每次提交写入 每秒刷盘，默认是1  我不太明白的是在1的情况下如果事务没有提交发生了宕机 之后哪来的redolog恢复未完成的事务？
>
> 
>
> @**杭州-java-菜鸟** 重试，我理解这时候会回滚，因为日志都是不完整的
>
> 
>
> @**harry** 我认为是崩溃恢复之后事务重做然后回滚  但是又不知道刚刚我说的那种情况redolog从哪来
>
> 
>
> @**杭州-java-菜鸟** 没提交就没有log啊
>
> 
>
> @**harry** 我看这个阿里云的资料上这样描述的 感觉应该是能恢复当时未提交事务然后再回滚的

> ![img](后端圈问答全集.assets/1546740699739-da691b24-799a-4ad4-9a97-7fa7c12dd51b.png)



- [**福州-Java-王波**] 没有提交的话，事务就没有成功，redo log还在缓冲区并没有刷新到磁盘，崩溃了应该就丢了，不会恢复了。崩溃恢复说的应该是已经提交了事务，有日志文件，但后台线程还没来得及修改真实数据块。这时候可以根据事务日志来恢复。

![img](后端圈问答全集.assets/1546740609366-e44006e9-bdf6-4065-a4f6-778f5e5b6052.png)

------

### **3.生成订单后要及时减少库存，这个业务场景该如何做设计**

>  **实战**    [2019-01-03]



[**北京-打杂-火柴**] 生成订单后要及时减少库存？比如说库存只有20件，现在A和B同时下单，都要下单11个，怎么做？

![img](后端圈问答全集.assets/1546741153438-85f3a56e-9534-4c2c-961f-0a82f65bc4e3.png)



➤ 相关讨论



- [**北京-后端-Ayo**] 你可以设定一个值，当库存只剩多少件的时候只能一件一件的买。

- [**深圳-Java-阿飞**] 系统先生成订单号，然后用这个订单号去减库存，减库存成功后展示给用户，准备付款，如果购物车够选了多件商品，有一些库存不够，是下不了单的，双十一就是这样的，所以，提示用户支付的订单，一定是有库存，这是肯定的

------

### **4.如何获得在运行时获得泛型的真实类型**

>  **Java**    [2019-01-04]  



[**北京-打杂-火柴**] 如下图，Java 泛型擦除，导致无法运行时获得真实类型，该如何更好的解决

![img](后端圈问答全集.assets/1546741631791-4af09834-fcf2-4b62-8e3e-f5ffbeb52bf4.png)



![img](后端圈问答全集.assets/1546741651412-82865c80-db3e-4e43-bb2e-3e13cee0952d.png)



➤ 问题解答



- [**北京-java-犀利豆**] 可参考我的博客文章「[最近遇到的几个问题集合](https://xilidou.com/2017/11/28/最近遇到的几个小题集合/)」

![img](后端圈问答全集.assets/1546741761263-b5dd4dd5-4e72-4ae8-8f0e-6e91da8d734a.png)

------

### **5.**关于异常表

>  **JVM**    [2019-01-04]



[**上海_java_小星**]

![img](后端圈问答全集.assets/1546742395561-677e10bd-33f6-4787-82e6-0038e14e4dae.png)

下图是根据上图这个代码生成的异常表信息

![img](后端圈问答全集.assets/1546742502312-26fe9e45-78b0-48fb-91d5-bbdf4774f56c.png)



异常表有4条记录，前三条我能理解。分别是：

\1. 如果try语句块中出现属于Exception或其子类的异常，则转到catch语句块处理。

\2. 如果try语句块中出现不属于Exception或其子类的异常，则转到finally语句块处理。

\3. 如果catch语句块中出现任何异常，则转到finally语句块处理。

这个第4条，我不太清楚，它是处理哪一种异常情况呢？我觉得第4条记录是多余的，这个例子是，深入理解jvm那本书的例子，可是书中提到的异常表只有前三条记录，但我编译出来有第4条，对于第4条，貌似是说在处理未声明异常时候，此时如果又抛出异常，就跳转到字节码17行的代码处理，我不太理解这个意思



![img](后端圈问答全集.assets/1546742521209-14a73b79-bf07-4dd2-8ee2-bd78d293d3c8.png)



17行指令-astore  4，是说把这个抛出的未声明异常的引用放到局部变量索引4的位置，貌似只有这一个动作，这个动作抛出异常，就跳到17行处，是这个意思吗？



➤ 相关讨论



- [**兰小伟-《TypeScript实战》**]

> astore 4是将栈顶元素写入本地变量表的索引为4的位置，栈顶元素是ireturn指令push到栈顶的
>
> 
>
> @兰小伟-《TypeScript实战》这个操作，jvm认为会抛异常？此时栈顶应该是那个异常对象的引用
>
> 
>
> @上海_java_小星 19那个指令是把int 的3push到栈顶，也就是说return执行后也要执行finally，17跳到19是起这个作用
>
> 
>
> @兰小伟-《TypeScript实战》应该不包含19，那个区间是左闭右开，异常表第4行，说得是指令17处，抛出异常的话，就跳转到17处再执行吧，这会循环吗
>
> 
>
> @上海_java_小星 保证return后会执行到finally

> @兰小伟-《TypeScript实战》那这样感觉怪怪的。如果真出现异常表第4条记录那样的情况，他不就是循环执行[17，19)那地方的代码了吗
>
> 
>
> @上海_java_小星 对，你是对的，我理解错了，17-19如果出现任何异常，就跳到17，这是个死循环
>
> 
>
> @兰小伟-《TypeScript实战》其实我有两个疑惑，一个就是上面的死循环的意义是什么；二就是[17，19)这个地方为什么还会抛异常
>
> 
>
> @上海_java_小星 死循环意思是保证返回值写入本地变量表一定会写成功；第二个问题比如数组越界啊，后面有个索引4

------

### **6.MySQL无法启动**

>  **MySQL**    [2019-01-05]



[**上海-Java-同生**] 下图这个异常该怎么解决

![img](后端圈问答全集.assets/1546743485221-84ea6ae2-9f75-4566-94f1-20a29b03439f.png)

之前都好着的，今天要用时。就这样了

![img](后端圈问答全集.assets/1546743519274-0554a06b-f788-420b-a635-4a265c77c485.png)



➤ 问题解答



- [**南京-后端-祁晓波**] 不用localhost啊，指定host，没指定server就是本机，mysql在localhost会特殊处理走socket，如果确定mysql是启动的，运行命令 -h [127.0.0.1](https://www.yuque.com/server_mind/answer/127.0.0.1) 试试看

------

### **关键字**



### **Redo Log、Undo Log**

> redo日志、undo日志：
>
> 
>
> 存储引擎也会为redo undo日志开辟内存缓存空间，log buffer。磁盘上的日志文件称为log file，是顺序追加的，性能非常高，注：磁盘的顺序写性能比内存的写性能差不了多少。
>
> 
>
> undo日志用于记录事务开始前的状态，用于事务失败时的回滚操作；redo日志记录事务执行后的状态，用来恢复未写入data file的已成功事务更新的数据。例如某一事务的事务序号为T1，其对数据X进行修改，设X的原值是5，修改后的值为15，那么Undo日志为<T1, X, 5>，Redo日志为<T1, X, 15>。



「[mysql事务、redo日志、undo日志、checkpoint详解](https://zhuanlan.zhihu.com/p/34650908)」



------

非常感谢「后端圈」小伙伴们的高质量技术交流。 这里，我使用「知识星球」沉淀高质量的答疑内容。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端群」与「知识星球」共同探讨，一起交流、探讨，打破认知的局限。



- ✅**杭州-数据挖掘-青南（书籍：《Python爬虫开发 从入门到实战》）**
- ✅**harry**
- ✅**杭州-java-菜鸟**
- ✅**福州-Java-王波**
- ✅**北京-打杂-火柴**
- ✅**北京-后端-Ayo**
- ✅**深圳-Java-阿飞（公众号 ：阿飞的博客）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**上海_java_小星**
- ✅**兰小伟-《TypeScript实战》（书籍：《TypeScript实战》）**
- ✅**上海-Java-同生**
- ✅**南京-后端-祁晓波（博客：后端之路** https://qixiaobo.site/**）**

## **周报 No.54（2019年）**

### **0.关于SelectionKey**

>  **Java**    [2019-01-06]



[**北京-打杂-火柴**] 下文中的 key 是做什么用的？代表的什么含义？文中只提到了key的生命周期 没提到他代表的意义和作用啊？表示的是状态，tcp这些请求的状态要我们自己控制，不是socket监控的，所以才需要主动register注册？既然如此，注册的意义是什么？ 就是有点不理解代码为什么要这么做？多路复用器 也要设置成不同的事件进行监听 对应的不通事件进行响应和通知?



![image.png](后端圈问答全集.assets/1547360557105-836c6d71-6502-45c1-ab6a-8e77f2d0202c.png)



![image.png](后端圈问答全集.assets/1547360570164-d261b892-d5bb-45f0-ba77-2cc9cdab42d6.png)



![image.png](后端圈问答全集.assets/1547360583311-c1e65277-7ffa-402f-a777-5bd8a29619b6.png)



➤ 问题解答



- [**北京-打杂-火柴**] Java的Selector调用操作系统层的Multiplexing IO(多路复用模型),本身只是个API调用。而多路复用是这个样子的: 

  ![image.png](后端圈问答全集.assets/1547360932054-9f826824-1be7-4578-b652-2a13dd48f0d6.png)

  I/O multiplexing 这里面的 multiplexing 指的其实是在单个线程通过记录跟踪每一个Sock(I/O流)的状态(对应空管塔里面的Fight progress strip槽)来同时管理多个I/O流.  

  而这段点代码`SelectionKey key = channel.register(selector, SelectionKey.OP_READ);` register()方法的第二个参数，这是一个”interest集合“，意思是在通过Selector监听Channel时对什么事件感兴趣.  

  可以监听四种不同类型的事件：

  Connect

  Accept

  Read

  Write

  

  通道触发了一个事件意思是该事件已经就绪。所以，某个channel成功连接到另一个服务器称为”连接就绪“。一个server socket channel准备好接收新进入的连接称为”接收就绪“。一个有数据可读的通道可以说是”读就绪“。等代写数据的通道可以说是”写就绪“。  只要ServerSocketChannel及SocketChannel向Selector注册了特定的事件，Selector就会监控这些事件是否发生。SelectableChannel的register()方法返回一个SelectionKey对象，该对象是用于跟踪这些被注册事件的句柄。在执行Selector的select()方法时，如果与SelectionKey相关的事件发生了，这个SelectionKey就被加入到selected-keys集合中，程序直接调用selected-keys集合的remove()方法，或者调用它的iterator的remove()方法，都可以从selected-keys集合中删除一个SelectionKey对象。

  

  通过调用某个SelectionKey的cancel()方法，关闭其通道，或者通过关闭其选择器来取消该Key之前，它一直保持有效。取消某个Key之后不会立即从Selector中移除它，相反，会将该Key添加到Selector的已取消key set，以便在下一次进行选择操作的时候移除它。所以简单来说,上面的那个selectionKey就是一种注册事件,而每一种事件对应着这个连接的一种状态,多路复用模型会检查每个连接所对应的状态,如果达到其中的一种状态,就会触发对应的事件处理逻辑。

------

### **1.关于长链接**

>  **TCP**    [2019-01-06]



[**北京-打杂-火柴**] 我这段代码如何改成长连接操作?这个心跳是怎么实现的？死循环开启多个线程，就是开启长连接？我倒觉得第二个靠谱一些，自己 setKeepAlived 还主动关闭了连接，毕竟心跳只是检测，长时间未连接，会主动关闭的。 但是另一个问题就是如果心跳通过死循环就能做到，这是我执行 telnet localhost 8080的结果：telnet发送一次后自然就停止了。是telnet命令的问题？只能维持一次请求，而不是一个连接？



![image.png](后端圈问答全集.assets/1547361499435-e6036399-e69f-4c3e-b838-24638de47325.png)



![image.png](后端圈问答全集.assets/1547361511970-778c5213-ce64-4d2c-83ab-d2e6708b1d79.png)



![image.png](后端圈问答全集.assets/1547361521868-d06ba06f-f4a5-438e-8950-88fd619f8a75.png)



![image.png](后端圈问答全集.assets/1547361536001-6aca584f-c5b4-4620-8d30-bc15523eb266.png)



➤ 问题解答



- [**北京-打杂-火柴**] 首选,我们必须弄清楚一个概念问题,就是TCP的长连接问题，具体请参考徐靖峰的文章 「[聊聊 TCP 长连接和心跳那些事](https://mp.weixin.qq.com/s?__biz=MzI0NzEyODIyOA==&mid=2247484251&idx=1&sn=c037f75bb6172fbad86f5e9c5ed22a77&chksm=e9b58a90dec203866bbe080b1ab795af4f19cae5815426fa40503e0ad01d3ec2a1aac94cb723&scene=0&xtrack=1#rd)」

![image.png](后端圈问答全集.assets/1547361733426-7abaa432-7449-4bf0-8e5b-273a57764e6c.png)



![image.png](后端圈问答全集.assets/1547361755110-cf59ffcf-882c-4581-9215-e0652cef265e.png)



![image.png](后端圈问答全集.assets/1547361767211-7dc1330d-972f-4a59-9292-9ebebb829822.png)



所以这个问题本身提问就存在一定问题，严格来讲，甚至不成立。Socket通信完全基于TCP处理的，而TCP不存在真正意义上的长连接

![image.png](后端圈问答全集.assets/1547361843680-628d9560-c229-45f8-a1ad-148ab598303a.png)

所以,如何实现该问题中所谓的”长连接”?只要每次请求，后台不进行主动即可关闭。而且这个demo如果测试只能使用telnet进行TCP连接，而长短连接都是在应用层协议上开启的，无法做出主动判断，只能后台自己进行相应的逻辑判断和处理，更何况TCP协议本身不存在长连接这一概念，只要维持活性即可。

------

### **2.关于锁升级**

>  **Java**    [2019-01-07]



[**南京-java-无瑕**] 对方法/代码块加 synchronized 关键字后，jvm会根据当前所处的单线程或者多线程环境来进行不同的加锁操作对吗?



![image.png](后端圈问答全集.assets/1547346605071-b79a987f-4641-4c75-9432-c282f6302c8e.png)



➤ 问题解答



- [**珠海-java-yellowb**] 可以参考 「[jvm从轻量级锁膨胀到重量级锁是在什么时候发生的？](https://www.zhihu.com/question/39009953)」和「[java偏向锁，轻量级锁与重量级锁为什么会相互膨胀?](https://www.zhihu.com/question/53826114)」

以下为第二篇问答的部分内容：

> 作者：EnjoyMoving
> 链接：https://www.zhihu.com/question/53826114/answer/236363126
> 来源：知乎
> 著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。
>
> 
>
> 偏向所锁，轻量级锁都是乐观锁，重量级锁是悲观锁。
>      一个对象刚开始实例化的时候，没有任何线程来访问它的时候。它是可偏向的，意味着，它现在认为只可能有一个线程来访问它，所以当第一个
> 线程来访问它的时候，它会偏向这个线程，此时，对象持有偏向锁。偏向第一个线程，这个线程在修改对象头成为偏向锁的时候使用CAS操作，并将
> 对象头中的ThreadID改成自己的ID，之后再次访问这个对象时，只需要对比ID，不需要再使用CAS在进行操作。
> 一旦有第二个线程访问这个对象，因为偏向锁不会主动释放，所以第二个线程可以看到对象时偏向状态，这时表明在这个对象上已经存在竞争了，检查原来持有该对象锁的线程是否依然存活，如果挂了，则可以将对象变为无锁状态，然后重新偏向新的线程，如果原来的线程依然存活，则马上执行那个线程的操作栈，检查该对象的使用情况，如果仍然需要持有偏向锁，则偏向锁升级为轻量级锁，（**偏向锁就是这个时候升级为轻量级锁的**）。如果不存在使用了，则可以将对象回复成无锁状态，然后重新偏向。
>        轻量级锁认为竞争存在，但是竞争的程度很轻，一般两个线程对于同一个锁的操作都会错开，或者说稍微等待一下（自旋），另一个线程就会释放锁。 但是当自旋超过一定的次数，或者一个线程在持有锁，一个在自旋，又有第三个来访时，轻量级锁膨胀为重量级锁，重量级锁使除了拥有锁的线程以外的线程都阻塞，防止CPU空转。
>
> 来源：[偏向锁，轻量级锁与重量级锁的区别与膨胀 - choukekai的博客 - CSDN博客](https://link.zhihu.com/?target=http%3A//blog.csdn.net/choukekai/article/details/63688332)

------

### **3. sleep是不是只是降低了CPU损耗，并不是完全不占用CPU资源**

>  **Java**    [2019-01-08]



[**北京-打杂-火柴**] 是不是可以这么理解： sleep只是降低CPU损耗，并不是不占用CPU资源？

![image.png](后端圈问答全集.assets/1547362202588-0e4ab77d-509b-408e-9126-739db45dab7c.png)



![image.png](后端圈问答全集.assets/1547362244789-bb1a0d33-ad0b-494e-b4fe-370f025b8e60.png)



➤ 相关讨论



- [**珠海-java-yellowb**] sleep应该是会把线程变成block状态，然后os会把它给调度出去不运行

![image.png](后端圈问答全集.assets/1547362298378-c739ee3e-0d35-47be-9064-f5c2f9f55f82.png)

- [**北京-打杂-火柴**] 从各种实验结果和搜集到的资料来看，sleep并不是不会占用CPU，只是降低CPU的功耗，具体情况还不清楚，依然存疑。至于网大多数面经提到的sleep是否占用CPU也是人云亦云，说法不一。

------

### **4.为什么tomcat中调用Catalina的方法都是通过反射调用的**

>  **Java**    [2019-01-08]



[**南京-java-无瑕**] 为什么tomcat中调用Catalina的方法都是通过反射调用的



➤ 问题解答



- [**兰小伟-《TypeScript实战》**] [**杭州-蛋炒饭-java**] 可参考 Bootstrap 类
- [**兰小伟-《TypeScript实战》**] [**南京-java-无瑕**] 应用程序级别依赖的类与Server自身依赖的类进行隔离。

![image.png](后端圈问答全集.assets/1547348010669-aed6b441-b19e-4cf6-ad08-47a2ad9ef760.png)

- [**兰小伟-《TypeScript实战》**] 如果两个类加载器之间没有父子关系，那么他们加载的类之间是完全隔离的。

------

### **5.关于Jackson的ObjectMapper**

>  **实战**    [2019-01-10]



[**西安-java-健**] Jackson的 objectMapper 是每次都需要生成呢，还是说本身就是单例呢，我这样写会不会有线程安全性问题：



![image.png](后端圈问答全集.assets/1547349673115-4ce9e4b6-5e06-49ab-adf0-ee4ce9590f4b.png)



我是这么个思路，因为jackson的配置应该是一开始就定义好了，后期不能再变，尤其在运行时候不能变。如果把jackson的配置放在yml文件里面，第一臃肿，第二就是误修改都不好。硬编码应该是最好的办法，然后我就把springboot jackson2HttpMessageCoverter 中ObjectMapper硬编码，最后我突然又想提出个Json工具类，全局配置应该统一，就这样做了。



➤ 问题解答



- [**北京-java-犀利豆**] [**杭州-蛋炒饭-java**] 是线程安全的，放心用 一个就够了
- [**珠海-java-yellowb**] 可参考：「[Should I declare Jackson's ObjectMapper as a static field?](https://stackoverflow.com/questions/3907929/should-i-declare-jacksons-objectmapper-as-a-static-field)」

![image.png](后端圈问答全集.assets/1547349894335-b05b1270-01e2-4b40-9e9c-5c5e69976fdc.png)

------

### **6.@Transactional对Redis事务起作用吗**

>  **Spring**    [2019-01-11]



[**北京-打杂-火柴**] @Transactional 对redis事务也好使吗? 博客千篇一律只给一个demo，有些不理解，是因为annotation只是个标记，在执行的时候，底层会判断是否方法含有这个annotation的标识再进行处理的？文档还是只提到了如何开启，没说这个事务能做到什么，我想知道的是，这个事务能做什么，比如说回滚？redis本身不支持回滚的，而且实现的都是伪原子性，只能保证transaction queue一次提交并执行，结果不进行保证



![image.png](后端圈问答全集.assets/1547350325395-5d250439-d71c-445d-9515-6f30607353ec.png)



➤ 相关讨论



- [**北京-java-犀利豆**] 一般用redisson的lua保证原子性
- [**杭州-java-乐乐**] 

- - redis的事务就是一次提交多个命令执行，中间有错误也不会回滚
  - 这个事务应该就是把方法里的所有redis操作缓存起来，一次批量提交到redis执行，方法执行完没有错误，就会提交，有错误就不会提交

![image.png](后端圈问答全集.assets/1547350485427-903a9224-a968-47ab-934d-79813630f1d9.png)

- - 这个注解目的应该是让操作更方便



------

### **7.关于存储类应用是否应该部署在容器环境的讨论**

>  **Docker**    [2019-01-11]



[**西安-java-健**] 探讨个问题，我个人觉得 Mysql  Redis  Es hive 这些涉及数据存储的应用，不应该通过 docker + 挂载磁盘方式的启动。  应该就安装在宿主机上。  这种想法不知道是不是有失偏颇。

我认为安装在宿主机上的理由是：

- 第一、挂载磁盘的方式可能出现未知BUG， 导致服务读取数据问题。 第二、例如mysql，redis，如果升级版本的话，也不应该直接通过新镜像关联旧的 bin.log 或者dump文件
- 再就是 使用docker是为了方便扩容和升级集群，mysql之类存储不会这样强行扩容。   如果给他们套层docker  感觉就是增加了复杂度和问题发生概率，带不来实际的好处



➤ 相关讨论



- [**北京-后端-可乐**] 看业务场景了吧，如果没有数据迁移，又不经常扩容，可能就没必要使用docker或者用了也不用挂载盘。如果不挂载，docker会将日志都存在镜像里，你的镜像会越来越大。而且docker是aufs文件系统，容器太大大概率会出问题
- [**杭州-java-乐乐**] 用了docker，就没必要用docker+挂载硬盘的方式了吧，可以用vol，数据库的数据都保存在vol中，备份没有问题，数据库升级也不需要关联binlog或dump，新的容器挂载数据vol就可以了吧

------

### **8.关于风控系统的设计**

>  **设计**    [2019-01-11]



[**北京-后端-哈哈**] 风控场景中，xx天限制xx条的限制规则如何设计，例如，一个月内一个支付账号支付超过3个用户，进行拦截？流水数据怎么处理，如何保证响应时间。(响应时间不能太慢，要不人家不愿接入)



➤ 相关讨论



- [**上海-scala-面包**] 就是个精简的订单表，然后SQL语句where里加上一个月，账号，支付账号，这三个去做count就好了哇。每天把一个月前的数据删掉或者放到历史表。
- [**杭州-后端-梁桂钊**] 

- - 这种风控场景，我们做过，某个时段最多多少笔。注意的是，这种，我们存数据库，但是你需要注意的是，并发场景是锁不住的，因为同时查的时候满足，但是并发场景可能同时触发风控。
  - 风控，可以分为风控预警、风控熔断，准确性是首要的，其次才是性能，前期可以考虑做一次QPS的测试和性能评估
  - 可以用数据库 count 冗余表

- [**珠海-java-yellowb**] 能不能用Flink来做？它支持在时间窗口上做聚合，问过一个在电商公司做过风控的同学，他们现在是基于redis zset来做的，之后打算切换到Flink 

  

  ![image.png](后端圈问答全集.assets/1547359593861-e42372aa-ae17-4492-99a1-ada35b910e86.png)

  

  「[滚动窗口](https://help.aliyun.com/document_detail/62511.html)」「[风控系统实时统计服务如何设计是最优的？](https://www.zhihu.com/question/276693634?utm_source=wechat_session&utm_medium=social)」

- [**研习小组讨论总结（总结人：上海-后端-spector）**]

风控预警：比如退款：触碰到熔断，导致资金出不了。

​	

强业务的业务控制，最主要的是准确性，可扩展，可配置，灵活性和可扩展性，基于数据库，分库分表，数据量不是特别多，并且有索引，查询性能不会差很多。还需要考虑并发问题（并发量特别高，大促时，比如正常是3，并发极端情况下有可能是5，这个是无解的，需要提前跟PD说声）其次才是性能，性能要求特别高，建立count的冗余表，每次累加把这个表加1次，要求更高的话，使用redis二次缓存，把数据库的压力平摊到redis



历史数据，比如按照季度，把历史数据分表，有声明周期的。

​	

风控有前置和后置

前置：业务为了节约性能，像金额，在多少范围内，把这个流程熔断掉，不让流程继续执行。如果有的东西没有必要继续流程，就可以前置掉。

后置：业务有自己的风控，业务自己做一个兜底

​	

业务风控，跟业务耦合特别紧，服务主业务链路的，可扩展、通用比较难，每个业务自己独特的。分库分表，使用shared jdbc，只要能路由到那个表，就不会存在什么问题。

​	

业务划分，比如黑名单是业务本身和风控，都有的，有功能模块，该抽时就抽，该堆功能就堆功能。

​	耗时是索引建立不合理，或者线程池满了，导致查询慢，其他的时候一般不会慢。前期可以不用考虑性能，等到性能慢时，说明业务已经很成熟了，可以重构了。

​	前期可以考虑做一次QPS的测试和性能评估，做一次压测。（考虑半年内的数据大小）看一下QPS的测试报告，做一个评估。

​	

查询两张表，比较慢



​	1、做风控主体，月退款额，月放款的数据，一个月的数据，抽象为一个监控的主体。

​	2、主体有很多属性，有很多收发条件、范围，根据垂直条件，配置很多触发点。【规则点，条件，转账，同城达到多少分（做一个评分，量化），符合某一个大的模型，每一个大模型里又有很多小模型，当满多少分就认为触发风控，可能其他的大模型还无法触发的到就已经触发风控了】

​	3、根据这些触发点，数据不符合要求的，通过邮件、短信，触发业务性的操作，做一些具体的行为。

​	前期都是数据准备阶段。设计成一个通用的，设计一个要监控的主体。融了一笔钱（主体），金额，还款日期（模型属性），跟业务是一个强耦合的，风控数据采集。

​	风控模型的准确性、实时性很强，只能集成到业务里做一个强耦合，跟业务做成一起，同步的操作。根据不同的业务场景，做权衡。

​	业务、平台的规则和历史数据，做一个判断，风险的一个校验平台。比如一个账号最多转账给3个用户，超过那么就禁止转账。

------

### **10.关于int 与 Integer** 

>  **Java**    [2019-01-12]



[**杭州-后端-梁桂钊**] int 与 Integer 有什么区别？怎么理解包装类的装箱与拆箱？那么，这个拆箱过程中需要注意什么问题呢？



➤ 相关讨论



- [**上海-后端-spector**]  int是原生类型，而Integer是封装类型，对int做了一层包装，这个大家都知道。通过代码编译一下来比较看看



 ![image.png](后端圈问答全集.assets/1547041486542-2819b328-c5ea-4098-9566-05f8373b591a.png)



通过javap -c Test反编译后：



![image.png](后端圈问答全集.assets/1547041562417-8d1fba83-b6fa-478a-aeeb-5cdc3e2c4cc4.png)



所以包装类的装箱与拆箱操作，均在编译阶段已经完成了，装箱调用valueOf()方法，而拆箱，则调用intValue()方法。



装箱源码解析



![image.png](后端圈问答全集.assets/1547041583719-96e56df4-6b31-48ba-b8e1-18769fa4bf8d.png)



valueOf调用了IntegerCache 内部类。当装箱的值**大于cache.low值并且小于cache.high值**时，直接从cache里获取已经初始化好的Integer对象，若是大于该范围，就直接实例化一个新对象出来。



IntegerCache内部类中的实现：



![image.png](后端圈问答全集.assets/1547041789948-46185a0f-821a-4623-bd41-66d4b989549f.png)



可以看出，cache里的high值最小为127，而能提供的最大值为2^31-130，这里默认最大值是127，并且这个值可以通过环境变量来指定：

1. 一个就是上图中的变量来指定最大值：-Djava.lang.Integer.IntegerCache.high=<size>
2. 另外通过jvm参数来设定自动装箱最大值：-XX:AutoBoxCacheMax=<size>



3)  当我们设定-Djava.lang.Integer.IntegerCache.high=128或者更大时



- 🔲![image.png](后端圈问答全集.assets/1547042044303-9918de6d-223e-4652-adac-15b969d7488f.png)



- 🔲2)如果不设置或者设置为最小的127，情况如下：
- 🔲

![image.png](后端圈问答全集.assets/1547042128501-4bac8c75-b401-4518-9108-552ed8ac562f.png)



比较可以看出，i1和i2是从缓存中获取的，而i3和i4是实例化出来的结果，对象的地址不一样导致结果不一样。



而当进行equals比较时，是内部强制拆箱做的比较，不是对象与对象的比较



![image.png](后端圈问答全集.assets/1547042243987-112c77d3-f3d9-4acc-92e6-b49d0487450e.png)



所以，拆箱时，需要注意Integer内部缓存的范围，超过这个范围，对象就不再从缓存中获取了，而是直接实例化一个新的Integer对象出来。

- [**研习小组讨论总结（总结人：上海-后端-spector）**]

为啥使用包装类，而不是使用基础数据类型。使用的时候，集合，map，如果是基础类型，就不支持，而必须是map。需要对象操作，包装类把对象给包装进来，比如序列化，基础数据类型是有默认值，而序列化需要null。



```
public static Bollean isSuccess(Article article){
    return null;
}

Integer[] arr = new Integer[]{1,2,3,4};
int[] arr = new int[]{1,2,3,4};
List<Integer> ints = Arrays.asList(arr);

//说明泛型不接受原生数据类型，对于封装类型，则可以转换，会认为Integer[]与Integer...是一样的，都是数组。
```

------

### **11.怎么处理线上出现了消息堆积的问题**

>  **实战**    [2019-01-12]



[**杭州-Java-阿涛啊**] 怎么处理线上出现了消息堆积的问题？



➤ 相关讨论



- [**研习小组讨论总结（总结人：上海-后端-spector）**]

思考过程：很多种场景。像大促，消息堆积是正常合理的，一段时间内是可以追平，熔断住了，然后提高消费能力。

消费能力太低，是不是网络抖动，消费者在部署，不能使用

消费能力太差了，代码有问题，那么处理代码问题

比如加机器，慢sql。

​	不是技术问题，而是业务问题，具体场景具体分析。

------

### **12.dto bo vo转化有没有什么好的解决办法**

>  **实战**    [2019-01-12]



[**北京-Java-犀利豆**]  web service dao 里面 dto bo vo转化。很麻烦。有没有什么好的解决办法？



➤ 相关讨论



- [**研习小组讨论总结（总结人：上海-后端-spector）**]

使用第三方库，声明式就可以解决mapstruct。

​	bo->vo 工厂方法，把具体的字段收敛到具体的方法里去，不要散落到各处。bean拷贝的性能开销特别小，可以忽略不计。

- [**研习小组讨论总结（总结人：上海-后端-strongant）**] 

- - 瓶颈在消费吞吐量的时候，增加消费的批次和频率可以改善性能；
  - 建议增加消费者线程。尽量 1 个消费者线程对应 1 个分区，从而发挥现有分区数下的最大并行度。

------

### **13.关于同步**

>  **Java**    [2019-01-12]



[**上海-Java-strongant**]  如果synchronized方法调用另一个非同步方法，那么非同步方法是否存在锁定？



➤ 相关讨论



- [**研习小组讨论总结（总结人：上海-后端-strongant）**]

> 如果线程 A 调用同步方法 M1 ，然后又调用非同步方法 M2，那么线程 B 仍然可以在不阻塞的情况下调用 M2 方法。
>
> 同步方法获取并释放调用它的对象的内部锁。 非同步方法不会尝试获取任何锁（除非在代码中明确完成）。
>
> 因此，如果需要确保 M1 方法与 M2 方法的互斥，不管 M1 是否同步，都应使 M2 方法保持同步。
>
> 
>
> 锁属于线程 ，而不属于方法（或更确切地说，属于其堆栈帧）。 如果 一个方法被 synchronized 修饰，则可以保证该线程在方法体开始之前拥有锁，在方法执行结束后释放锁。
>
> 另一个线程仍然可以调用第二个非同步方法。 任何线程都可以随时调用非同步方法。

------

非常感谢「后端圈」小伙伴们的高质量技术交流。 这里，我使用「知识星球」沉淀高质量的答疑内容。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端群」与「知识星球」共同探讨，一起交流、探讨，打破认知的局限。



- ✅**北京-打杂-火柴**
- ✅**南京-java-无瑕**
- ✅**珠海-java-yellowb**
- ✅**兰小伟-《TypeScript实战》（书籍：《TypeScript实战》）**
- ✅**杭州-蛋炒饭-java**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**西安-java-健**
- ✅**杭州-java-乐乐**
- ✅**北京-后端-可乐**
- ✅**北京-后端-哈哈**
- ✅**上海-scala-面包**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**
- ✅**上海-后端-spector**
- ✅**深圳-Java-阿飞（公众号 ：阿飞的博客）**
- ✅**杭州-Java-阿涛啊**
- ✅**上海-Java-strongant**

## **周报 No.55（2019年）**

### **1.Too many open files 问题**

>  **Linux**    [2019-01-14]  



[**北京-Go-小于**] Too many open files 问题常见原因和解决方案有哪些呢？



➤ 问题解答



- [**杭州-后端-梁桂钊**] linux配置下句柄。

- [**青南**]  Kafka遇到过，给服务器开了40多万个句柄。

- [**北京-java-犀利豆**]  一般是代码有Bug导致链接泄露，比如：流用完没有释放。如果不够用可以改系统配置。

- [**研习小组讨论总结（总结人：北京-后端-张帆**）]

> **1) What is ulimit in Linux?**
> The ulimit command allows you to control the user resource limits in the system such as process data size, process virtual memory, and process file size, number of process etc.
>
> **2) What happens when the settings in this command are not set up properly?**
> Various issues happen like native OutOfMemory, Too Many Open files error, dump files are not being generated completely etc.
>
> **3) How can you check current ulimit settings?**
> There are various ways to check the current settings:
>
> a) From the command prompt, issue
> $ ulimit -a

「[Resolve "Too Many Open files error" and "native OutOfMemory due to failed to create thread" issues in WebSphere Application Server running on Linux](https://www.ibm.com/developerworks/community/blogs/aimsupport/entry/resolve_too_many_open_files_error_and_native_outofmemory_due_to_failed_to_create_thread_issues_in_websphere_application_server_running_on_linux?lang=en)」

  

> 子进程允许打开的最大文件数不能超过父进程的阈值限制

「[一次「Too many open files」故障](https://huoding.com/2015/08/02/460)」



### **2.CAP理论**

>  **CAP**    [2019-01-14]  



[**广州-java-win7@loops**] CAP中的P，分区容错怎么理解？

> 编者注：Consistency（一致性）、 Availability（可用性）、Partition tolerance（分区容错性）



➤ 问题解答



- [**兰小伟-《TypeScript实战》**] 

C强调数据的正确性一致性，即我要么返回失败给你，要么我返回最新数据给你

A强调我绝对不会返回失败给你，我一定会返回数据给你，但是我不保证数据一定是最新的。

P强调我会一直为你服务，绝对不会挂掉。(就是我集群挂了2台，依然不影响我为你正常服务)。强调自己是打不死的小强，即程序的健壮性。



- [**研习小组讨论总结（总结人：strongant**）]

分区容错性指“the system continues to operate despite arbitrary message loss or failure of part of the system”，即分布式系统在遇到某节点或网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务。

比如现在的分布式系统中有某一个或者几个机器宕掉了，其他剩下的机器还能够正常运转满足系统需求，或者是机器之间有网络异常，将分布式系统分隔未独立的几个部分，各个部分还能维持分布式系统的运作，这样就具有好的分区容错性。



### **3.JVM 类的虚方法表**

>  **JVM**    [2019-01-18]  



[**上海-java-小星**] 类的虚方法表里放的是方法的直接地址，那对于那些父类的方法子类也没重写的方法，在子类的方法表里是怎么存的？是将父类那个方法的地址复制一份到子类方法表里？还是子类指向了父类的方法表？

截图来自《深入理解jvm》



![img](后端圈问答全集.assets/1547885523184-aaa4b9fc-e665-4e4e-9774-cb2756bcf033.png)



➤ 问题解答



- [**杭州java正荣**] 我认为是子类复制了一份父类方法表，同时两个类的数组中相同方法的索引也是一样的. 其实我觉得，只要知道子类与父类的相同方法在方法表中的索引值是一样就够了。

- [**兰小伟-《TypeScript实战》**] 

![img](后端圈问答全集.assets/1547886288678-31e43615-3910-4641-89fa-7b3e336e1765.png)

 **For a single inheritance hierarchy, you can re-use the integer method identifiers from the base class in each of the child classes so the child class dispatch table looks just like the parent class.**

![img](后端圈问答全集.assets/1547886552889-e7686218-8078-40df-87b9-912dea0b299f.png)



并不是每次都会去查表，你可以去了解一下 inline cache of method。

- [**上海-后端-知秋**] 回复@上海-java-小星 的问题：如果子类复制父类方法表，同一个方法地址就可能会拷贝多份，岂不是浪费空间？

回复：这个又占用不了多少空间，空间换时间就是，又不是对象，何必搞那么麻烦，消耗CPU资源按图索骥，直接把资源放锅里不是更好。兰大不是说了么，reuse，每个方法都是一个独立的管理，就是为方便继承管理。

------

非常感谢「后端圈」小伙伴们的高质量技术交流。 这里，我使用「知识星球」沉淀高质量的答疑内容。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端群」与「知识星球」共同探讨，一起交流、探讨，打破认知的局限。（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**上海-Java-知秋（博客 ：**[一叶知秋、](https://muyinchen.github.io/) 视频：Java编程方法论-响应式编-RxJava [bilibili](https://www.bilibili.com/video/av34537840) 、[油管](https://www.youtube.com/playlist?list=PL95Ey4rht798MMCusPzIW7VYD1xaKJVjc)**）**

- ✅**兰小伟 (书籍：《TypeScript实战》)**

- ✅**strongant**

- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**

- ✅**北京-后端-张帆（博客** **：Since1986** [https://since1986.github.io](https://since1986.github.io/)**）**

- ✅**青南（书籍：《Python爬虫开发 从入门到实战》）**

- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## **周报 No.56（2019年）**

### **1.ExampleMatcher.matching().withIgnorePaths 问题**

> **JPA**  [2019-01-21]  



[**武汉-Java-Mason**] ExampleMatcher.matching().withIgnorePaths(“lastname”) 忽略lastname属性路径是啥意思？

![image.png](后端圈问答全集.assets/1548254641450-63140db7-fec3-47a5-b966-e22aa886130c.png)



➤ 问题解答



- [**北京-后端-张帆**] findByExample 时，lastname属性不计入检索条件 比如你有一个 User 里面有 id firstname lastname 然后你构建了一个 Example 乎略掉了 lastname 这个属性，那么生成的语句里就不会带有 lastname。withIgnorePaths 会返回一个新的 ExampleMatcher 实例的，你下边 Example.of() 应该传这个新的实例。

![image.png](后端圈问答全集.assets/1548254754013-360bab1f-363f-4d41-a655-1447707e2fc0.png)





### **2.反编译的软件推荐**

> **编译**  [2019-01-21]  



[**福州-后端-BIN**] 哪个反编译的软件好用？



➤ 问题解答



- [**北京-后端-winner_0715**] jd,只用过这个
- [**北京-后端-ren**] [Luyten，Jadx](https://www.cnblogs.com/renyuanwei/p/9849889.html)，这两个比较好用
- [**杭州-java-蒋鑫燚**] luyten支持jdk9以上的



### **3.between 与 in 的分析**

> **Mysql**  [2019-01-21]  



[**长沙 java seven**] 发现好多博客里有这样一篇谣言

![image.png](后端圈问答全集.assets/1548255379864-ee47452f-d331-401a-87b2-d3b773cfb4d0.png)

![image.png](后端圈问答全集.assets/1548255353132-3ca62e51-a6f5-4e3c-8f6a-43c0b8604b39.png)



➤ 问题解答



- [西安-无业游民-小孩子] 其实理论上between的确比in好，between是一个区间，in是多个区间，in成本分析：

![image.png](后端圈问答全集.assets/1548255441052-4db25c01-9cbf-413d-9290-efacfaf26bfb.png)

![image.png](后端圈问答全集.assets/1548255455150-336a4a8c-6154-4c09-892b-34eb6a0797e1.png)

​        ![image.png](后端圈问答全集.assets/1548255534529-ad56c359-5fc0-4d25-9252-7f8028cd61c6.png)

​            ![image.png](后端圈问答全集.assets/1548255622273-1d044006-c222-4a3e-a706-423e71447b62.png)





### **4.类的虚拟方法表父子类引用关系探讨**

> **JVM**  [2019-01-21]  



[**上海_java_小星**] 类的虚方法表里放的是方法的直接地址，那对于那些父类的方法子类也没重写的方法，在子类的方法表里是怎么存的？是将父类那个方法的地址复制一份到子类方法表里？还是子类指向了父类的方法表？我看视频说是后者，但我看《深入理解jvm》图是这样画的

![image.png](后端圈问答全集.assets/1548255898633-ac406000-2790-469b-8262-4369bfbd65b7.png)



➤ 问题解答



- [**杭州Java正荣**] 我认为是子类复制了一份父类方法表，同时两个类的数组中相同方法的索引也是一样的，其实我觉得，只要知道子类与父类在相同方法在方法表中的索引值是一样就够了
- [**兰小伟-《TypeScript实战》]** uncorrectly. 并不是每次都会去查表，你可以去了解一下 **inline cache of method**

![image.png](后端圈问答全集.assets/1548255978944-5bea48cb-e928-4e87-936f-c51c75e52fea.png)

![image.png](后端圈问答全集.assets/1548256002169-27a6ef1a-5310-4426-8700-9ea5134fc858.png)

- [**上海-后端-知秋]** 这个又占用不了多少空间，空间换时间就是，何必搞那么麻烦，消耗CPU资源按图索骥，直接把资源放锅里不是更好。每个方法都是一个独立的管理，就是为方便继承管理。



### **5.mysql：on update current timestamp时间点问题**

> **Mysql**  [2019-01-22]  



[**北京-java-犀利豆**] mysql 时间设置的是 on update current timestamp, 那这个时间 是事务开始时间，还是语句执行时间，还是事务提交时间？



➤ 问题解答



- [**后端-武汉-星星**] 执行时间，应该是速度很快，基本同毫秒
- [**上海-后端-spector**] 刚刚开启一个事物测过了，不管什么时候提交，还是记录当时的执行时间
- [**北京-java-犀利豆**] 我写了一个demo ，update time 是sql 执行的时间



### **6.netty 堆外内存如何处理？**

> **Netty**  [2019-01-22]  



[**北京-打杂-火柴**]  包括之前看到的netty涉及到一些对ByteBuff的内容涉及到堆外内存，是否可以理解为：netty 很多的内存管理不是通过JVM gc堆处理的，而更多是像是JNI这种，直接交给操作系统，放在堆外处理？

![image.png](后端圈问答全集.assets/1548256559979-046fcdd9-d510-40ff-825e-c521bb1e118c.png)



➤ 问题解答



- [**珠海-java-yellowb**] 对，它自己在堆外申请一大块内存，自己做分配和释放，基于引用计数，需要程序员用显式调用API来加一或减一，netty并不自动做计数，它只是在减到为0时把内存块归还到pool里去
- [**兰小伟-《TypeScript实战》**] 可以这么理解，相当于再退化到C了



### **7.netty EventLoopGroup 问题**

> **Netty**  [2019-01-22]  



[**北京-打杂-火柴**]  netty 为何server端需要使用两个EventLoopGroup，而client 的只需要一个？还有为何要默认设置为 CPU双倍的线程，是因为默认为IO密集型 所以这么配置吗？



➤ 问题解答



- [**成都-后端Java-陈十一**] 这里定义了2个NioEventLoopGroup，实际上就是2个线程池，一个是用于监听客户端的连接，一个用户处理网络io，或者执行系统task等，[参考链接](https://blog.csdn.net/zxh87/article/details/73467873)。

用于接收客户端请求的线程池职责如下：

1）接收客户端tcp请求，初始化Channel参数。

2）将链路状态变更事件通知给ChannelPipeline。

用于处理io操作的Reactor线程池职责如下：

1）异步读取通信端的数据，发送读事件到ChannelPipeline;

2）异步发送消息到通信对端，调用ChannelPipeline的消息发送接口；

3）执行系统调用Task；

4）执行定时任务Task，例如链路空闲状态监测定时任务；

- [**珠海-java-yellowb**] 大概是因为一个boss eventloop用来accept socket, 连上后丢给某个worker 去监听可读可写事件吧



### **8.多线程局部变量安全性问题探讨**

> **多线程**  [2019-01-24]  



[**广州-java-win7@loops**]  单例模式，多线程的环境下，局部变量应该也是线程安全的吧？



➤ 问题解答



- [**北京-java后端-jijs2018**] 局部变量，不逃逸出去，永远是安全的
- [**harry**] 局部变量引用在栈里，是安全的，成员变量不安全。



------

非常感谢「后端圈」小伙伴们的高质量技术交流。 这里，我使用「知识星球」沉淀高质量的答疑内容。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端群」与「知识星球」共同探讨，一起交流、探讨，打破认知的局限。（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~



- ✅上海-后端-spector
- ✅**北京-后端-张帆（博客** **：Since1986** [https://since1986.github.io](https://since1986.github.io/)**）**
- ✅**西安-无业游民-小孩子（公众号 ：我们都是小青蛙）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅兰小伟 (书籍：《TypeScript实战》)
- ✅成都-后端Java-陈十一
- ✅北京-后端-winner_0715
- ✅北京-后端-ren
- ✅杭州-java-蒋鑫燚
- ✅杭州-Java-正荣
- ✅后端-武汉-星星
- ✅珠海-java-yellowb
- ✅北京-java后端-jijs2018
- ✅武汉-Java-Mason
- ✅福州-后端-BIN
- ✅长沙-java-seven
- ✅上海_java_小星
- ✅北京-打杂-火柴
- ✅广州-java-win7

## **周报 No.57（2019年）**

### **1.系统的控频限流监控问题**

> **限流**  [2019-02-01]  

[**南京-Java-林**] 针对有恶意请求刷数据的行为，怎么能做好系统的控频限流监控？



➤ 问题解答



- [**北京-java开发-黄大胖子**] 用账号ip请求频率限制
- [**宁波-java-金鑫**] 限制ip请求 
- [**上海-java-呆**]  这是我在极客上看到的，鉴权和限流的开源项目，你可以研究一下代码思路

- - https://github.com/wangzheng0822/ratelimiter4j
  - [微服务接口限流的设计与思考（附GitHub框架源码）](https://mp.weixin.qq.com/s?__biz=MzI4MTY5NTk4Ng==&mid=2247488993&idx=1&sn=4b9d5deedd0e626c456744f04b499bbb&source=41#wechat_redirect)



### **2. MySQL table_rows 的问题**

> **MySQL**  [2019-02-14]  



[**杭州-java-kugen**] table_rows 只能预估某个表有多少数据量，和实际数据量有偏差的



➤ 问题解答



- [**西安-无业游民-小孩子**]  ![image.png](后端圈问答全集.assets/1550723377723-8a88f2b1-bd46-40bc-86e8-db03a3f75497.png)



### **3. SpringBoot 配置 Redis 缓存**

> **redis**  [2019-02-15]  

[**北京-后端-Rain**] SpringBoot工程中做了redis缓存,怎么配置一下,让缓存的数据在过一定时间内清理掉?需要写定时任务吗? 我是这样写进去的

**![image.png](后端圈问答全集.assets/1550724748991-3f30f993-1530-4c82-8c77-1edeaebef120.png)**



➤ 问题解答

- [**北京-后端java-互联网**]  过期时间设置下

​      ![image.png](后端圈问答全集.assets/1550725013505-e267b003-d5ea-4b7d-be75-4ab4b0afaffe.png)



- [**北京-后端-yun**] 缓存的时候就要设置过期时间
- [**深圳-后端-杀手**]   可以这样

![image.png](后端圈问答全集.assets/1550724878219-9f863bc2-00da-4f4d-baeb-dad7e7aee126.png)





------

非常感谢「后端圈」小伙伴们的高质量技术交流。 这里，我使用「知识星球」沉淀高质量的答疑内容。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端群」与「知识星球」共同探讨，一起交流、探讨，打破认知的局限。（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~



- ✅北京-java开发-黄大胖子
- ✅ 宁波-java-金鑫
- ✅上海-java-呆
- ✅西安-无业游民-小孩子
- ✅北京-后端java-互联网
- ✅北京-后端-yun
- ✅深圳-后端-杀手



## **周报 No.58（2019年）**

### **1.现已有未分区的日志表,占用数据量交大,如何优化磁盘?**

Mysql [2019-02-18]  



[**北京-打杂-火柴**] 

大佬们 有一个问题 因为公司刚成立一年,早期开发某个项目的时候,这个项目当时没有使用elk这些管理日志,直接放入到mysql innodb表中,而且该日志表一直是写频繁,查询少,只有在出现问题情况的时候,才让业务人员登录系统进行查询.现在这个表,经过一年后,业务爆发增长,占用磁盘空间780GB,目前已经部分业务停止向该表写入数据了,但是用的是阿里云的服务器,光一个表780GB就要花费不少费用,所以初期目标是对该表执行delete+optimize table,删除掉不需要的数据.但是delete操作好办,但是optimize table会对全表产生共享锁,可能费时将近一天左右,无法写入数据,这个显然是不能接受的,所以弱弱的问一下大佬,这个该如何优化以节省磁盘空间.



补充:delete操作好办,但是optimize table费时太大了.前者操作可以 直接基于MVCC 保证行锁,不影响业务写入.后者直接锁表,有点难.要短时间内能操作完,不要长时间停滞,导致升级费时太久.



**[深圳-DBA-火箭]**

你可以设计一张新的分区表，把在线数据先写入新的表，然后再变更时间，把业务操作写入新的表，历史数据再慢慢迁移。等把需要的历史数据都迁移到新的分区表之后，直接把旧表备份后，drop掉就可以了



**[福州-后端-叶平平]**

我之前也碰到这个问题，跟业务方沟通清楚，暂停服务，把旧表重命名，不写入旧表的业务功能，创建一个先的表来替代。

当然这个操作要看你的业务是否保证 7*24了。我之前的业务可以找个短时间暂停的。

会有业务查询问题，统计等等都会有影响，历史数据只能后续追回来，主要还是看业务逻辑。其他更好的方案目前没有接触过。



### **2.@JsonFormat会修改spring boot  的application.yml配置文件?**

Spring boot [2019-02-20]  



**[西安-后端-Byron]**

请教下各位关于SpringBoot 时区的一个问题 描述：两个服务都已经在application.ym 中设置jackson.time-zone 为GMT+8 但是传输的时间字段使用@JsonFormat 来格式化Date， 结果就是 B服务使用RestTemplate Post到B服务数据时，时间少了8个小时 



**[西安-后端-Byron]**

解决：@JsonFormat 也设置time-zone，问题解决。



**[西安-后端-Byron]**

另一个问题:@JsonFormat 我看源码，JsonFormat的时区默认不是GMT+8，所以 难道@JsonFormat 的时区优先级 会高于在 application中设置time-zone .

问题确实是：@JsonFormat 会 覆盖 application配置的time-zone



### **3.CPU使用率过高,Young Gen的日志曲线后期频繁上下跳动,可以说明CPU使用率过高和GC有关系吗?**

JVM [2019-02-18]



**[紫鸿青衣]**

各位大佬，我这里有一个突发情况，在17点20的时候，CPU开始报警，提示使用率过高，当时的Young Gen的日志曲线是上图中的样子，这个图可以说明CPU使用率过高和gc有关系吗？

![微信图片_20190222122945.jpg](后端圈问答全集.assets/1550809876015-0fd72f43-c05f-4b51-ae3f-c54d742fe351.jpeg)

![微信图片_20190222123009.png](后端圈问答全集.assets/1550809885094-f2f8863a-ba96-45b9-93af-8f6d36d44ef8.png)

**[梁大]**

除了gc，还有其他异常情况吗



**[紫鸿青衣]**

还有就是发生了两次full gc,这个好像还是gc的，别的我暂时还没有发现



**[张帆]**

在这一段时间里记录了两次full gc 时间段大概十几分钟



**[qixiaobo]**

你这个应该gc占用cpu太多了吧 换言之业务线程没怎么干活了



**[张帆]**

这个配置的 1 个核的实例,我说的物理的内存,以前没问题 这几天做了个活动 流量峰值大概原来的1倍.

我们原来配的是一核,这个是不是会更加重了情况吧.现在改成两核了,这个服务原来估计的没这么大量 这几天公司做了做活动 app排名在app store上前20了 流量上来了1倍.



**[qixiaobo]**

可以观察一下比如线程创建是否有剧烈变多啊,看上去是gc线程干的活太多导致业务线程占不到啥cpu.



**[张帆]**

嗯 用土法调优三大件已经做出文件了 已经上传了分析网站了 明天去公司了再看看.

我们这个老年代倒是没有频繁 就是年轻代频繁了.



**[qixiaobo]**

年轻频繁也说明不需要晋升就被回收了.短时间创建了大量的大对象,还可以被回收.



--  后续 ing  ---------------------------------------------------------------------



**[张帆]**

刚才看了这两篇文章，讲的从栈快照中发现的两种程序运行的表现形式，从而定为可能的问题 感觉学习了 https://blog.fastthread.io/2016/02/22/thread-dump-analysis-pattern-repetitive-strain-injury-rsi/ https://blog.fastthread.io/2016/06/23/really-running/



**[犀利豆]**

我有一个问题啊 cpu高好像比内存泄露好排查很多.hop一下 jstack一下.

就是jstack 看看线程。就知道为啥cpu高了



**[qixiaobo]**

他是gc频繁吧 不是业务线程高吧 查看线程高我一般用这个指令.

curl -sLk 'https://raw.githubusercontent.com/superhj1987/awesome-scripts/master/java/bin/show-busy-java-threads' | bash

阿尔萨斯:https://github.com/superhj1987/awesome-scripts

![微信图片_20190222124328.png](后端圈问答全集.assets/1550810622291-bb20dee8-4dcb-466d-8be3-56f4e4b08ffb.png)



**[犀利豆]**

整理了一下 思路，遇到现实cpu高怎么办。

1、top 看pid  

2、top -H -p pid 看看哪个线程高。

3、高的线程 装换为16进制以后，

4、jstack pid|grep 16进制的线程

5、多来几次定位 出问题的代码



昨天排查线上问题，发现 jvm gc日志正常，堆内存正常。 怀疑是堆外内存有问题 就用了一下 那个阿尔萨斯。发现一切正常，确实很好用。



**[张帆]**

https://blog.fastthread.io/2016/03/07/thread-dump-analysis-pattern-ripple-effect/ 这篇也不错

https://blog.fastthread.io/2015/09/02/thread-dump-analysis-pattern-several-scavengers/

https://blog.fastthread.io/2015/11/20/thread-dump-analysis-pattern-leprechaun-trap/ 这篇文章讲了 Thread dump 里经常能看到的 Finalizer 线程的作用

## 周报 No.59（2019年）

### 1**.**需要 MySQL 字段数据大小写不敏感的业务场景

> 后端圈①
>
> **Java**   [2019-02-27] 



[**北京-java-黑暗泽**]  大家有没有遇到过需要 MySQL 字段数据大小写不敏感的业务场景?



➤ 问题解答



**[龙童幽灵]** 例如验证码，短信验证码和普通验证码是不一样的。

**[无锡-java-何大葱]** 设计规范字段要求小写，下划线分割，就是为了屏蔽不同操作系统数据库大小敏感不一致的问题。



### **2.**依赖第三方多个 jar 包 出现同路径同名的类 ClassLoad 优先问题

> 后端圈①
>
> **Java**   [2019-02-28]



**[杭州-java-zhl] J**ava 依赖第三方多个 jar 包 ，出现同路径同名的类 ClassLoad 优先使用哪个?



➤ 问题解答



**[深圳-Java-阿飞] [深圳-Java-eumji][北京-后端-犀利豆]遇到**这种情况建议在 Maven 中 exclude 掉，很可能本地运行没问题，上线就报错。

**[上海-Java-知秋]** jdk9+会提前检查这个错的。



### 3.多个服务，一个域名

> 后端圈②
>
> Nginx   [2019-02-27]



**[重庆-java-小强]**  服务器上有两个项目在跑，端口不一样，怎么把两个端口都解析到一个域名里面？



➤ 问题解答



**[太原-后端-赫先生]** 可以使用 nginx 进行反向代理。



### 4.mqtt 收到消息后，怎么立即推送到 websocket 客户端

> 后端圈④
>
> 方案设计   [2019-02-26]



**[深圳-后端-黄西]** mqtt 收到消息后，怎么立即推送到 websocket 客户端？我现在是将收到的消息放到队列中，然后在 websocket 后台代码死循环获取队列的值，死循环导致无法断开 websocket 连接？



➤ 相关讨论



**[广州-Java-荣杰]** 可以考虑通过事件或定时器。我上回做是监听 Redis 事件，只要有个地方触发推送消息就可以了。收到消息消费时候去调用 websocket 推送试试。只要不用死循环就可以了。



### 5.MySQL 里面如何线程安全地实现 query and update

> 后端圈④
>
> 方案设计   [2019-02-27]

**[青南]** MySQL 里面如何线程安全地实现 query and update？我有一个表里面记录了 100 条验证码，网站后端读取一条验证码，然后就把它设置为已读。如果先 select 再 update，就线程不安全，可能会出现两次请求读取同一条验证码的情况。但是如果用锁，会影响性能。



➤ 相关讨论



**[北京-java-犀利豆]** 我们之前用过一个黑科技就是直接 update，如果影响行数大于 1 就更新成功。

**[杭州-后端-Alrt]** 只用 MySQL 解决的话只能开启事务，然后 select for update。

**[青南]** 我发现 Django 可以用这个问题，参考地址：https://docs.djangoproject.com/en/1.11/ref/models/querysets/#select-for-update

**[西安-java-健]** 你先生成 1000 条入库，项目启动读到内存，每次验证从内存验证，验证通过发送 MQ，或者用多线程写库。只要在 Java 内存中， 而不是从库中判断逻辑，重复不重复其实都挺好判断的。**我总结了一个规律，凡事一个业务需要特别复杂高深技术去实现的时候，大部分情况是业务思路跑偏了。找对方向，基本没有复杂的代码。**



### 6.AOP 切的接口太多导致内存溢出

> 后端圈④
>
> Java   [2019-02-27]

**[厦门-java-zwj]** 有人遇到过 AOP 切的接口太多导致内存溢出，JVM 内存调到 4G 还是会溢出？



➤ 相关讨论



**[杭州-后端-梁桂钊]** 我猜可能是代码问题吧，我之前遇到过，有一个场景在 aop 调用中每次调用都 new 对象，导致流量高的时候内存溢出。

**[上海-后端-myths]** 可能是栈溢出，永久代调大就好了，类比较多有可能就是永久代不够，永久代放类的元信息吧，AOP 代理过的类都是一个新的类，这个新类的元信息就会扔到永久代，有可能会撑满。



### 7.SpringMVC controller 方法参数为什么不使用多个的 @RequestBody

> 后端圈（福州厦门圈）
>
> Java   [2019-02-27]

**[福州-后端-叶平平]** SpringMVC controller 方法参数为什么不使用多个的 @RequestBody，例如



```
add(@RequestBody Head head,@RequestBody Body body)
```



➤ 相关讨论



**[杭州-后端-梁桂钊]** 正解。这个问题就是 Spring @RequestBody 单体限制。一个方法只能用一个 @RequestBody，不然好像会报错，我记得，可以试一下。因为它将输入流的 body 作为一个整体进行转换，解析完成之后会关闭输入流。

**[福州-后端-叶平平]** Spring 多 @requestbody 支持，下午看到的解决办法。地址：https://github.com/chujianyun/Spring-MultiRequestBody 。

------

非常感谢「后端圈」小伙伴们的高质量技术交流，以及「研习小组」成员们的聚焦交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」与「研习小组」共同探讨，一起交流、探讨，打破认知的局限。（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅北京-java-犀利豆（公众号 ：犀利豆的技术空间）
- ✅西安-java-健
- ✅上海-后端-myths（博客：https://blog.mythsman.com/）
- ✅福州-后端-叶平平
- ✅上海-Java-知秋（博客 ：一叶知秋 [https://muyinchen.github.io](https://muyinchen.github.io/)）
- ✅深圳-Java-阿飞（公众号 ：阿飞的博客）
- ✅青南（书籍：《Python爬虫开发 从入门到实战》）
- ✅龙童幽灵
- ✅无锡-java-何大葱
- ✅深圳-Java-eumji
- ✅太原-后端-赫先生
- ✅广州-Java-荣杰
- ✅杭州-后端-Alrt
- ✅北京-java-黑暗泽
- ✅杭州-java-zhl
- ✅重庆-java-小强
- ✅深圳-后端-黄西
- ✅杭州-后端-梁桂钊（公众号 ：服务端思维）



## **周报 No.60（2019年）**

### 1**.** 说到杀进程，我也想问一个问题在执行kill- 9的时候，如果有大量数据进来，这些数据会丢失吗？

> 后端圈
>
> **Java**   [2019-03-04] 



[北京－Java－Mr.Xi] 说到杀进程，我也想问一个问题在执行kill- 9的时候，如果有大量数据进来，这些数据会丢失吗？



➤ 问题解答



**[北京-java-犀利豆]** kill-9 是直接杀掉进程，无论进程在干什么，肯定会引起数据丢失。可以使用kill 15 如果java程序写的正确，就会不接受新的请求，然后把手上的处理完，再关闭。至于java 如何优雅的退出 可以看看 java.lang.Runtime.addShutdownHook(Thread hook) 这个方法。



### **2.** 设计秒杀系统为什么使用消息队列

> 后端圈
>
> **设计**  [2019-03-05] 



**[北京-打杂-火柴]**很多博客为何设计秒杀系统都是用消息队列呢?使用消息队列的目的是什么?比如说某个商品我只卖100 份,那卖给对于商家而言都是一样的,根本不需要保证有序性,即便是前一百个人没有抢到,第二百个人抢到了也无所谓,用户不知道,商家也不关心,还是说用 mq 只是为了削峰填谷,避免短时间内并发量太高?如果是这个原因,除了使用消息队列,还有其他办法可以避免流量短期内突然暴增吗?



➤ 问题解答



**[北京-java-犀利豆]**所以还有一种思路就是每层调用都随机抛弃很多请求，真正落到核心服务的流量很少。第二种思路就是先把数据记下来，我再慢慢分析谁秒杀到了。



**[福州-SER-赤月]**我觉得在秒杀场景下，消息队列的作用，更多是把并行处理化为串行处理。既可以排队处理，避免超售，也可以保证有序。重点更多在于排队处理后可以避免超售，个人见解。



**[兰小伟-《TypeScript实战》]**就是削峰+异步化，控制超卖，那是业务问题，不是技术问题。



### 3. 为什么 private 方法无法添加事务管理？

> 后端圈
>
> **Java** [2019-03-08] 



**[广州-学生-后端]**为什么 private 方法无法添加事务管理



➤ 问题解答



**[上海-后端-知秋]**动态代理基于反射机制进行。



**[北京-java-犀利豆]**反射非要调用private也行啊。



**[上海-后端-知秋]**你方法都设定 private 难道是想让人来反射调用的？



**[北京-java-犀利豆]**同理 junit test 的方法也是 public 的。



**[上海-后端-知秋]**源码里非要调用也是需要给权限的。





### 4. 如何提高短信发送的效率，以及如何解决并发

> 后端圈
>
> **Java** [2019-03-08] 



[杭州-java-keven]![image.png](后端圈问答全集.assets/1552129803952-c6bbb963-d052-40ac-85f4-012be6923509.png)



➤ 问题解答



**[广州-java-win7@loops]**这个其实很简单，加多个冻结金额的概念，开始的时候就把预计要用到的钱冻结出去，这样另外一个任务就用不了了。 短信这个主要是批量，所以先把一批要用到的钱冻结。



**[杭州-java-keven]**嗯，先锁定,和扣库存一样的道理.



------

非常感谢「后端圈」小伙伴们的高质量技术交流，以及「研习小组」成员们的聚焦交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」与「研习小组」共同探讨，一起交流、探讨，打破认知的局限。（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅北京-java-犀利豆（公众号 ：犀利豆的技术空间）
- ✅上海-Java-知秋（博客 ：一叶知秋 [https://muyinchen.github.io](https://muyinchen.github.io/)）
- ✅杭州-java-keven
- ✅兰小伟-《TypeScript实战》
- ✅**福州-SER-赤月**
- ✅成都-JAVA后端-北极之北
- ✅广州-java-win7@loops
- ✅北京－Java－Mr.Xi

## **周报 No.61（2019年）**

### 1**.**  Vert.x 和 Reactor 的关系，以及 JDBC 的思考

> 后端圈①
>
> **反应式编程**   [2019-03-11] 



**[北京-java-犀利豆]** 我一直不太了解 Vert.x 和 Reactor 的关系，vertx 提供了 JDBC？



➤ 问题解答



**[上海-java-知秋]** Vert.x 提供了 JDBC 是个半成品，性能不咋滴。Spring 的 Reactor 是基于 jdk8+ 的实现，加入了大量的新功能，这个 RxJava 库是根本不具备的。从很多代码设计的层面，Reactor 做了很大的变动。数据库从来都不是瓶颈，现在的开发而言，真正可以落到数据库的操作的，还是比较少的，未来我们会越来越多基于基础服务层面的二次开发，更多还是网络型 io。假如非要基于关系型数据库，其实，MySQL 的性能上限，Spring MVC 已经可以成功驾驭了，不过现在已经做好响应式 JDBC 同样可以利用大内存的优势做到性能的大幅度提高，主要还是 Reactor 可以将长时间有订阅关系但是没有元素处理的这些任务所占据的工作线程释放出来，交给急需处理的任务来使用

**[兰小伟-《TypeScript实战》] R**eactor 反应式编程是一种编程模型，Vert.x 是该编程模型的具体实现。异步化编程，基于事件驱动的无锁化编程模型。学好 Vert.x，首先要理解透 Netty 的 Eventloop 概念以及 Reactor 设计模式。其他类似的反应式框架也一样。

**[上海-后端-sion]** Reactor 和 JDBC 是没有必然关系， 只是一般来说 Reactor 配合 no blocking 服用效果更好， 没有的话,自己可以 wrapper。



### 2. 数据加密方案推荐探讨

> 后端圈①
>
> 实战  [2019-03-11] 



**[广州-后端-柴码]** 有没什么数据加密方案推荐，我目前使用 RSA 加解密，发现效率有些低？



➤ 问题解答



**[北京-java-犀利豆]**非对称效率低，安全。对称效率高不安全。HTTPS 的思路就是使用非对称方式交换密钥，然后用对称方式传输数据。



### 3. 分布式锁主要实际应用在哪些地方

> 后端圈①
>
> 实战 [2019-03-16] 



**[广州-java-win7@loops]** 请教大家个问题，平时日常开发中，分布式锁用得多吗？主要实际应用在哪些地方？



➤ 问题解答



**[深圳-Java-Ryan]** 多，主要多个服务共享数据或者，多线程共享数据。多个实例共享数据，多个实例的定时任务之类。

**[上海-后端-知秋]** 看你具体需求，服务看做是线程，共享数据可以看成是 volatile 变量。

**[北京-后端-hxy]** 场景多了,比如:定时任务，共享变量，接口幂等，防止缓存击穿，



### 4. RocketMQ 消费堆积与CONSUME_FROM_LAST_OFFSET

> 后端圈②
>
> RocketMQ [2019-03-12] 



**[上海_java_呆]** 请问一下问题，RocketMQ 消费堆积，配置的消费策略是 CONSUME_FROM_LAST_OFFSET，为什么新消息必须等堆积消息都消费了才会被消费到?



➤ 问题解答



**[上海_java_呆]** 消息队列的消费是 FIFO 的，CONSUME_FROM_LAST_OFFSET 使用设置启动时的消费策略。



### 5. 介绍你做过最复杂的系统

> 后端圈②
>
> Java [2019-03-14] 



**[北京-后端-黄鹏飞]** 你系统的难点和亮点是啥?



➤ 问题解答



**[杭州-后端-梁桂钊]** 这个问题蛮好，可以探讨，说说你们自己的思考。比如，保障稳定性时如何做到业务无害性，如何立马定位问题，也是亮点啊！。。。这个很好啊，我觉得这个是很多人不具备的解决问题的能力。安利时间，系统的复杂性包括了技术复杂性和业务复杂性。参见：http://blog.720ui.com/2019/about_complex_system/

 

### 6. ES 按字段(数组类型)聚合

> 后端圈④
>
> 实战 [2019-03-11] 



**[北京-后端-kevin]** 请教下 ES 按字段(数组类型)聚合，返回的结果是被数组被打散的结果聚合，这个有什么好的办法解决吗？



➤ 问题解答



**[杭州-后端-梁桂钊] 。。。**



### 7. 集群、负载均衡、分布式的理解

> 后端圈④
>
> 分布式 [2019-03-12] 



**[成都-后端-陈十一]** 集群、负载均衡是技术，分布式是概念，包含前两个，这样理解有问题吗？



➤ 问题解答



**[上海-后端-brucezhang]** 分布式是指将不同的业务分布在不同的地方，集群指的是将几台服务器集中在一起，实现同一业务。在现有网络结构之上，负载均衡提供了一种廉价有效的方法扩展服务器带宽和增加吞吐量，加强网络数据处理能力，提高网络的灵活性和可用性。

**[北京-后端-G小调]** 集群:多台机器跑一套代码 分布式:多台机器合起来跑才是一套完整代码。



### 8. 怎么理解分布式和微服务，以及集群之间的关系

> 后端圈④
>
> Java [2019-03-12] 



**[杭州-后端-梁桂钊]** 怎么理解分布式和微服务，以及集群之间的关系？



➤ 问题解答



**[北京-java-犀利豆]** 微服务是实现分布式的一种手段。

**[广州-后端-陈树义]** 垂直分割和水平复制的关系吧。微服务是一种实现方式。

**[上海-后端-brucezhang]** 微服务是一种架构风格，和分布式类似，知识部署方式不一样。我理解的是微服务不一定部署在多台机器，也可以是同一台机器。

**[北京-后端-G小调]** 我觉得微服务就是应用拆分粒度更小，职责更单一聚焦，然后就是服务治理，再加容器。

**[杭州-后端-梁桂钊]** 随着业务的发展，我们势必会面临高访问流量，此时需要考虑服务器的负载能力，防止服务器过载而导致服务宕机不可用。因此，我们采取服务水平拆分。首先，我们引入集群和负载均衡来均分访问流量。其次，通过冗余机器来提高机器集群的负载能力。当我们将单体系统拆分成微服务（服务垂直拆分），我们也需要通过引入集群和负载均衡来提高每一个子服务系统的负载能力和容灾能力。事实上，很多单体系统已经具备了服务水平拆分（集群和负载均衡）的能力，而微服务的改造是一种服务垂直拆分方案。我们需要对业务梳理并模块拆分，保证拆分后的各个模块都是有价值的。服务水平拆分（集群和负载均衡）和微服务（服务垂直拆分）不是互斥关系，而是在高并发和分布式中的共存关系。

**[兰小伟-《TypeScript实战》]** 集群跟代码无关，集群是从 server 端来看待问题，指的是多台服务器通过网络互连聚集在一起共同对外提供服务。分布式是从 client 端看待问题，指的是客户端的请求是通过分发给不同机器来处理的，至于是不是同一套代码不是重点啊，你提供的功能是一致的就行啊，一个用 Java 写的，一个用 Python 写的也可以啊，只要两者提供的功能从 client 端来看表象一致就行了。补充一下，集群和分布式跟代码层面关系不大，需要考虑代码的无状态，才便于分布式。



### 9. 服务间调用会产生网络开销，为什么服务化系统性能会提高

> 后端圈④
>
> 分布式 [2019-03-12] 



**[成都-后端-陈十一]** 服务间调用会产生网络开销，为什么服务化改造之后 系统性能会提高？



➤ 问题解答



**[重庆-Java-crossoverJie]** 负载呀，以前一个服务可以处理 1000 并发，现在 10 个服务就翻倍了。

**[杭州-后端-小糖人]** 服务化就是加机器，服务化可以细粒度增加负载。
**[福州-java-龍]** 之前是订单、商品、认证耦合在一起，要加服务器要一起加，现在根据负载，或许只要加订单服务器就好了。而且微服务是强制解耦，有的时候耦合在一起会偷懒。

**[杭州-后端-梁桂钊]** 网络带宽只是冰山一角，单体应用能用的机器资源就那一些，传统的做法就是换更好的机器，是吧，为什么，就是因为它能提供更多的资源，比如cpu，内存等。如果集群，我就可以具有扩展能力，通过加机器来扩展负载能力。服务化，更多的考虑是独立自制和扩展的可能性。补充一下，微服务带来了很多不稳定性，所以我们要基于失败设计。



### 10. Tomcat 在高并发情况下，除了 IO 瓶颈，还有什么

> 后端圈④
>
> Tomcat [2019-03-14] 



**[广州-后端-学生]** 请问 Tomcat 在高并发情况下，除了 IO 瓶颈，还有什么？



➤ 问题解答

**[上海-java-知秋]** servlet 设计的瓶颈决定了它终究难以满足需求，有些 api 它就是同步的。 https://juejin.im/post/5c653140518825625e4abfc6 里面有nio一系列的东西。



### 11. 后端序列化时间探讨

> 后端圈⑤
>
> Java [2019-03-11] 



**[武汉-后端-小童]** 谁知道如何后端序列化时间的时候，只显示yyyy-MM-dd？



➤ 问题解答

**[上海-后端-钱杉杉]** 我用的是 fastJson，所以在数据序列化的时候，全局配置里这样处理一下就ok了。当然也可以局部处理，比如在实体上做 @JsonFormat。

![image.png](后端圈问答全集.assets/1552824796641-2d9ee39c-d1d7-4e1c-a064-60428f6836e5.png)

使用 jackson 的话，全局就这样配置一下。

![image.png](后端圈问答全集.assets/1552824802695-d3bca886-8471-46bc-ac70-63d9e35c20e2.png)

局部配置：

![image.png](后端圈问答全集.assets/1552824808229-d48aef86-08db-4fe5-bb72-82a43f2e7ed9.png)



### 12. 类怎么动态添加新的属性

> 后端圈(福州厦门圈)
>
> Java [2019-03-12] 



**[福州-后端-叶平平]** 类怎么动态添加新的属性？ 我的想法是有这 Dict 注解的属性，能动态创建一个原来属性+Dict 的属性。 刚开始的时候我想反射 Field.set("xxDict",value) 直接添加，发现不行。之后有想用CgLib 来动态代理，但是代理后的是新对象。而且属性上有 $cglib_prop_ 。就是数据字典 codeToName 的想法。现在实行了直接在原属性的值替换，但是这样很不友好，想在动态创建一个新属性来存放name的值。



➤ 问题解答

**[杭州-后端-梁桂钊]。。。** 



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**上海-Java-知秋（博客 ：一叶知秋** [**https://muyinchen.github.io**](https://muyinchen.github.io/)**）**
- ✅**兰小伟 (书籍：《TypeScript实战》)**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**上海-后端-钱杉杉**
- ✅**上海-后端-sion**
- ✅**成都-后端-陈十一**
- ✅**深圳-Java-Ryan**
- ✅**上海_java_呆**
- ✅**北京-后端-黄鹏飞**
- ✅**上海-后端-brucezhang**
- ✅**北京-后端-G小调**
- ✅**北京-后端-hxy**
- ✅**广州-后端-陈树义（公众号 ：Java技术精选）**
- ✅**重庆-Java-crossoverJie（公众号 ：crossoverJie）**
- ✅**杭州-后端-小糖人**
- ✅**福州-java-龍**
- ✅**福州-后端-叶平平**
- ✅**北京-后端-kevin**
- ✅**广州-后端-柴码**
- ✅**广州-java-win7@loops**
- ✅**武汉-后端-小童**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**



## **周报 No.62（2019年）**

### 1. 大 SQL 导致数据库服务不可用



> 后端圈① [2019-03-18]



**[北京-后端-hxy]** 大 SQL 导致数据库服务不可用，表现：线上大面积反馈无法保存了，个别应用警告内存飚高，刚刚发生的线上问题，分享给大家。处理方法：查看慢 SQL，联系 dba 查看数据库服务器的运行状况，dba 发现大 SQL，kill掉，服务正常。主要由于 MyBatis 条件 bug，导致查了全表。



➤ 问题解答



**[杭州-后端-小黑]** 这类问题一般是程序员写的时候没注意，条件没匹配上，导致了全表查询。

**[深圳-java-mike]** 如果是程序员的问题，可以写一个进行静态检查工具，入参是表结构和 xml 文件，就可以分析出 SQL 是否走索引了。开发和测试阶段不用 SQL 的执行计划分析,线上会有 druid 分析执行过的 SQL 报告。就用 druid 的 AST 进行词法分析，我们还加了一些其他的 SQL 规范，就解析了一起过规则列表。



### 2. Python 里面使用 elasticsearch-dsl 搜索 ES



> 后端圈① [2019-03-20]



**[杭州-数据挖掘-青南]** 请问有没有朋友在 Python 里面使用 elasticsearch-dsl 搜索 ES？



➤ 问题解答



**[上海-后端-墨菲]** 用 term 搜索，多层。

**[杭州-数据挖掘-青南]** 我发现了，还真的可以用 terms 来做。



### 3. 数据库跑批任务，分片取模实现，如果有机器挂了，怎么办



> 后端圈① [2019-03-23]



**[北京-后端-hxy]** 数据库跑批任务，分片取模实现，如果有机器挂了，怎么办？



➤ 问题解答



**[深圳-Java-阿飞]** 记录位置，重启后重试。



### 4. HTTP 1.1中好像并没有Patch请求方法？



> 后端圈④ [2019-03-18]



**[上海-后端-阿杰]** HTTP 1.1中好像并没有Patch请求方法，除了 doPatch 其他都有处理方法



➤ 问题解答



**[北京-java-犀利豆]** **[杭州-后端-梁桂钊]** @上海-后端-阿杰 是的，所以要做兼容，Spring 是支持的，主要在过滤器那层要处理下。



### 5. 如何正确的看源码



> 后端圈④ [2019-03-18]



**[上海-后端-阿杰]** 那如何正确的看源码，最近想看redis



➤ 问题解答



**[上海-后端-知秋]** 你首先要知道你要看的源码做了什么，是你的话该如何做，带着这种思考再去看，从顶层的设计开始，摸清整体节奏，也就拿到了骨架，然后再丰富细节，也就是代码细节。我自己的话 现在是培养出了语感，基本上看到代码大概就知道对方下一步该怎么设计，怎么实现，偏差很小。不管怎样，还是要多看，不要怕，语言是用来表达的，代码就是最好的教程，很多优秀的代码库都是抄的，这个我在解读 reactor-netty 库的时候，有将它和 Reactor 的代码设计做对比，很明显的设计抄袭，Springcloud function 这个组件，说实在的也是函数式技法的总结使用，这些技法在 reactor reactor-netty webflux 中都有大量的实现，所以 Spring 才给抽取出来。撸代码就和写文章一样一样的，写之前列大纲，设定所描述场景的内在联系，表达的中心思想，然后融入各种技巧，比如比喻，拟人等等，最后也就是通过这些赋予文章的灵魂。 还有一点，我是觉得，读源码少用debug，这个是面向过程的读法，最好是面向场景，才能更好的面向对象，面向设计。debug从来都是用来做调试的，并非是看源码的最优选择。我的源码解读系列，感兴趣的可以看看，虽然都是关于响应式这块的，以后的话，会加入大家感兴趣的。最后，感谢微信群「后端圈」提供的良好的学习讨论的环境。同时，有对 Java 响应式编程感兴趣的同学可以加 qq 群 523409180 一起讨论的。阅读地址：https://juejin.im/post/5c8fbd6b6fb9a070e7635f78



### 6. zk 可能一年不坏一次，挂的可能性微乎其微



> 后端圈④ [2019-03-19]



**[微笑]** 面试进爱问这些，zk 可能一年不坏一次，挂的可能性微乎其微？



➤ 问题解答



**[杭州-后端-梁桂钊]** 针对昨天的问题，我补充下，就是我们去实现业务不是要盯着正常的功能，我把这个功能实现了就好。而是要去基于失败设计，如果服务不可用要怎么去解决，微服务后，这种分布式脆弱性大大增加了。所以，不是说一年不出问题就万事大吉，而是如果这个灰犀牛出现了，我们怎么去应急，一般这种情况就是大故障，比如服务的可用性降低了，造成用户反弹，数据丢失了，甚至资损。



### 7. 树形结构业务查询设计探讨



> 后端圈④ [2019-03-20]



**[福州-java-龍]** 请教下，在一个树形结构上，要求能在父节点查询到，关联到子节点的资源，子节点包括间接子节点，且间接子节点可能会比较多，且资源列表还要支持排序、分页，大家是怎么实现的？例如，A部门有B子部门，B子部门有C1 C2两个项目，在C1 C2项目下，关联了小明、小李两个员工，在A部门上关联了老王员工，现要求查询A部门关联的员工，要能把上述三个员工都查出来，并根据入职日期等条件排序、分页？



➤ 问题解答



**[北京-java-犀利豆]** 存一个 path 字段，path 是 从 root 开始的，路径 id 查某个节点的子节点直接 like path%。



### 8. 队列中的任务达到 BlockingQueue 的临界值，真的会触发饱和策略吗



> 后端圈④ [2019-03-20]



**[北京-打杂-火柴]** 如果队列中的任务达到 BlockingQueue 的临界值，真的会触发饱和策略吗? 但是从判断是否是饱和策略的过程来看，怎么看都是池的大小，和任务没有任何关系啊？



➤ 问题解答



**[上海-后端-知秋]** 将线程比做人，人都在干活了，任务没人来做了，那等就是了。我之前有分享过线程与任务的关系，千万不要混在一起，白白增加理解难度，线程池就好比一个小组，线程就好比人，任务就好比需求。

**[西安-JAVA-夏夏夏夏夏]** 我记得是。饱和任务队列满了，再来任务应该会判断一下是否＞最大线程数，如果＜直接再启线程，如果＞则执行饱和策略，默认是抛异常。

**[重庆-Java-crossoverJie]** 这个有误解的还不少 Worker 执行的时候调用的是 runnable 的 run 方法而不是 start。是咯！juc 最大的难处就是大家喜欢概念混淆，把抽象的东西更加抽象，反而学不到里面的设计，也就没办法在实际的使用场景中有效选择。



### 9. mybatis-generator 生成 dao，自动修改的办法



> 后端圈④ [2019-03-21]



**[深圳-后端-小峰]** 请问下，用 mybatis-generator 生成 dao 及其对应的 xml 实现，数据表定义的create_time 字段和 update_time 字段如果想交给 DB 管理，需要在 xml 中一条条地改为 now()，有没有自动修改的办法，或者其他的生成方法？



➤ 问题解答



**[深圳-后端-杀手]** 用 aop，还有一种 MySQL 可以设置字段自动更新。

**[兰小伟-《TypeScript实战》]** AOP 可以做啊。

**[上海-java-小星]** 我一般在 MySQL 里定义 create_time 和 update_time 字段时候，给上默认值。



### 10. CPU核数*2+1 是根据什么计算出来的



> 后端圈④ [2019-03-22]



**[上海-java-达达]** 之前看 HikariCP 给过一个公式:CPU核数*2+1，不明白这个公式是根据什么计算出来的？



➤ 问题解答



**[北京-打杂-火柴]** io密集型



### 10. HashMap 初始化多少比较合适



> 后端圈⑤ [2019-03-18]



**[上海-后端-阿杰]** HashMap 初始化的时候应该注意什么？存 1000 个数据的时候，HashMap 初始化多少比较合适？



➤ 问题解答



**[杭州-后端-梁桂钊]** 如果是我，我会分场景分析。如果一开始明确数量，我会存 1000，是否预估出大概多少值怎么做，如果不确定，怎么做？建议阅读：[HashMap 动态扩容机制 | 梁桂钊的博客 : http://blog.720ui.com/2017/source_reading_map_dilatation/]

**[北京-java-梁培]** 负载因子 0.75，到 1000 个已经扩容了一次了吧。1000*0.75，也就说当存到 750 的时候就开始触发扩容了。记得应该是扩容一倍。存 1000 个，为了防止扩容，那应该最少初始化 1333.3333+1 个。



### 11. select count(*) 和使用 select count(1) 有啥区别？



> 后端圈⑤ [2019-03-19]



**[广州-Java后端-李同学]** 单表统计数据时，使用select count(*) 和使用select count(1)有啥区别？哪个效率高一点



➤ 问题解答



**[广州-Java后端-李同学]** MySQL 5.7 中，两者在不同存储引擎下优化是不一样的，官方文档对于 count 的解述，在INNODB引擎里，count（1）跟count（*）是一样的，在 MYISAM 下两者就有区别了。官网文章：https://dev.mysql.com/doc/refman/5.7/en/group-by-functions.html#function_count



### 12. 设计模式探讨



> 后端圈⑤ [2019-03-23]



**[杭州-Java-无雨开]** 有一个设计模式点想和大家讨论一下。比如我现在有 a,b,c 三个业务，在三个类中，业务处理过程大同小异。我现在是按照模板方法，建了一个父类 s,其他类都继承它，在 s 中编写 process 业务处理方法，按照业务流程执行的方式，其中调用一些差异性的东西使用抽象方法，让之类去实现。这样好处是大多数代码都集中在 s 类，流程也清晰。但不好的地是不够灵活，比如对于不同业务有不同的异常跳转流，需要提前 return，现在这样模板不是很好做，大家有什么好的建议吗？



➤ 问题解答



**[天津-开发组长-鲁鲁]** 把异常处理也放子类去，s 类只是做流程控制。

**[上海-后端-钱杉杉]** 因为模板是固定的，你这样 s 类就把模板给改乱了。切换成策略模式试试，其实他俩很相似，包装一下就成策略模式了，你可以把变化的流程交给子类去处理，s 类不固化流程，只要流程结果就行了。



### 13. Spring 的事务隔离机制和 MySQL 的事务隔离机制



> 后端圈⑤ [2019-03-24]



**[广州-Java后端-李同学]** Spring 的事务隔离机制和 MySQL 的事务隔离机制是两个相互独立的机制吗？或者换个说法，Spring 的事务隔离级别会覆盖 MySQL 的事务隔离级别吗？



➤ 问题解答



**[广州-java-乐]** Spring 的是 session 级别的事物隔离，MySQL是全局的。

**[上海-后端-彭帅]** Spring 的事务管理会映射到 MySQL 的事务管理，但是可以适配多种数据库，有自己的一层逻辑事务管理抽象如 begin transaction 等，提交给数据库执行的时候会转化为对应数据库的指令。阅读地址：https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-usagenotes-spring-config-transactional.html



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**上海-Java-知秋（博客 ：一叶知秋 https://muyinchen.github.io）**
- ✅**兰小伟-《TypeScript实战》（书籍：《TypeScript实战》）**
- ✅**杭州-数据挖掘-青南（书籍：《Python爬虫开发 从入门到实战》）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**深圳-Java-阿飞（公众号 ：阿飞的博客）**
- ✅**深圳-后端-杀手**
- ✅**天津-开发组长-鲁鲁**
- ✅**重庆-Java-crossoverJie**
- ✅**深圳-后端-小峰**
- ✅**深圳-java-mike**
- ✅**北京-打杂-火柴**
- ✅**广州-Java后端-李同学**
- ✅**上海-java-小星**
- ✅**广州-java-乐**
- ✅**杭州-后端-小黑**
- ✅**上海-后端-钱杉杉**
- ✅**上海-后端-彭帅**
- ✅**福州-java-龍**
- ✅**北京-后端-hxy**
- ✅**杭州-Java-无雨开**
- ✅**上海-后端-阿杰**
- ✅**北京-java-梁培**
- ✅**西安-JAVA-夏夏夏夏夏**
- ✅**上海-后端-墨菲**
- ✅**上海-java-达达**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## **周报 No.63（2019年）**

### 1**.**  Binlog update 事件，更新后，主库依然不变

> 后端圈①
>
> **MySQL**   [2019-03-26] 



**[北京-Java-Soez]** 接收到binlog的update事件(status 0 -> 1)，但是程序查主库依然是老状态(status = 0)。读写都在主库，这种情况有人遇到过吗？



➤ 问题解答



**[北京-java-犀利豆]** 我刚遇到一个case 是主从延迟的问题

**[南京-java-祁晓波]**

1、确定是否走的db；

2、如果有缓存，是否确定clear掉了；

3、mybatis缓存 这些是否都确定；

4、查询的库都确定是否正确；

5、是否是快照读，程序查询事务一直没提交？

6、如果有数据库权限，完全可以朝着长时间timeout的方向排查一下

**[南京-java-黄勇发]** MySQL行缓存，innodb_buffer。事务提交没有，如果是RR，程序查出来就是老值



### 2. MySQL时间范围查询方式

> 后端圈①
>
> MySQL  [2019-03-27] 



**[闵豪]** 数据库里时间的比较你们用between and多一点还是用>=,<=多一点啊？我个人感觉>=,<=这个会更合适一点



➤ 问题解答



**[深圳-Java-阿飞]** 大于小于

**[西安-Java-辰九]** 时间范围喜欢用between，其他喜欢用ge le



### 3. MyBatis无法使用MySQL内置函数问题

> 后端圈①
>
> MyBatis  [2019-03-27] 



**[帝都-大数据-strongant]** mybatis无法使用mysql的某些内置函数如concat，这个怎么解决？



➤ 问题解答



**[上海-Java-老三]** 不用concat 你就拼接

​    ![image.png](后端圈问答全集.assets/1554017275480-0e98e0a1-170d-4037-8e5a-1bdfe87b54e1.png)

​    ![image.png](后端圈问答全集.assets/1554017297860-a20655d9-a2a6-458b-98af-372d95523fde.png)

**[广州-JAVA-小叶]** 好像oracle不能 '%'aabb'%'才要用拼接函数



### 4. ES扩容服务器负载问题

> 后端圈①
>
> 实战  [2019-03-30] 



**[广州-java-win7@loops]** 请问ES扩容有人搞过吗？扩容的时候服务器负载高吗？对线上业务影响大吗？



➤ 问题解答



**[杭州-DBA 杨一]** IO 和带宽会受到一定的影响 ，通常会控制速率



### 5. 为什么Java编译器不直接编译成二进制文件？

> 后端圈②
>
> Java  [2019-03-28] 



**[王同勋]** 我们在服务器上运行的代码，为什么不直接使用编译器编译成二进制（就在这台机器上进行编译，排除class的跨环境的特点），而是要编译成class，使用解释器一行一行的解释执行，虽然有了JIT，但是还是觉得直接编译成二进制更好一点



➤ 问题解答



**[北京-java-犀利豆]** 为了一出编译 到处运行。还有一个是屏蔽操作系统的细节，专注写业务

**[北京-后端-菜鸟]** 垃圾回收，跨平台应该具有很多特性的



### 6. 字符串编码问题

> 后端圈②
>
> 实战  [2019-03-29] 



**[广州-Java-Thomas]** 如何判断一个字符串中有哪些字符是非utf-8编码呢？我目前遇到一个问题的就是一个中文字符串，后面加2个"??"就给报Could not read JSON: Invalid UTF-8 start byte 0x8f



➤ 问题解答



**[杭州-后盾-梁桂钊]** 很难，识别是否是utf8，或者其他编码，是基于概率学

**[长沙-后端-段十二]** 建立一个UTF8的中文字符库，将字符通过utf8编码解码，如果库里有该字符，判定为utf8编码，代价很大

**[北京-java-王泽宇]** 把数据库表设置成utf8，查询字符串的每个字符，如果报错就不是utf8

**[北京-java-犀利豆]** 需要配置一下Jackson



### 7. 网站被劫持应如何处理？

> 后端圈④
>
> 实战  [2019-03-25] 



**[合肥-java-freeter]** 网站被劫持了如何处理？



➤ 问题解答



**[杭州-后端-梁桂钊]** 运营商劫持的吧？先联系运营商，后面升级下。

**[北京-java-犀利豆] [上海-后端-知秋]** 改成https



### 8. API接口防止被随意调用

> 后端圈④
>
> 实战  [2019-03-25] 



**[济南-后端-释怀]** 有没有什么办法可以做到禁止接口让别人随便调用呀



➤ 问题解答



**[上海-后端-知秋]** 那你玩跳板机咯，通过对外暴露接口，传入自己设定的字典里的组合，然后解码获取真实接口并在后台调用得到对应结果，你这个字典不对外暴露，对方瞎调用是得不到什么结果的。这种需求，只需要权限控制就可以了



### 9. 数据序列化时应考量哪些指标呢？

> 后端圈④
>
> 实战  [2019-03-29] 



**[珠海-java-yellowb]** 关于在RPC或使用消息队列时，对于数据body是选文本形式（json）还是二进制形式（Protobuf、Thrift...），大家是怎么考量的？主要考量哪些方面和指标？



➤ 问题解答



**[北京-java-犀利豆]** 一般不用json。考虑一下序列化反序列化的速度，还有序列化以后流的大小，跨语言的兼容性。我们用thrift 毕竟Facebook背书

**[福州-java-龍]** 这边有项目用Protobuf 毕竟有google背书



### 10. Spring与MySQL事物隔离机制的关系是怎样的？

> 后端圈⑤
>
> 实战  [2019-03-24] 



**[广州-Java后端-李同学]** spring的事务隔离机制和mysql的事务隔离机制是两个相互独立的机制吗？或者换个说法，spring的事务隔离级别会覆盖mysql的事务隔离级别吗？



➤ 问题解答



**[广州-java-乐]** Spring的是session级别的事物隔离，mysql是全局的

**[上海-后端-彭帅]** Spring的事务管理会映射到mysql的事务管理，但是可以适配多种数据库，有自己的一层逻辑事务管理抽象如begin transaction等，提交给数据库执行的时候会转化为对应数据库的指令： 详见[官方参考文档](https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-usagenotes-spring-config-transactional.html)



### 11. 微服务之间通过消息处理的话，事物应该如何做呢？

> 后端圈⑤
>
> 实战  [2019-03-24] 



**[西安-Java-Pano]** 微服务之间调用全用消息订阅的话， 事务这边该怎么做？



➤ 问题解答



**[天津-开发组长-鲁鲁]** 消息本地 或消息中间件支持事务

**[杭州-后端-梁桂钊]** 两个注意点，一个参考下rocketmq这种事务机制，保证本地执行完一定发消息，另外还有一点就是还有双向确认ack机制。



### 12. 如何通过消息实现分布式事物呢？

> 后端圈⑤
>
> 实战  [2019-03-27] 



**[成都-Java-October]** 用消息实现分布式事务？边该怎么做？



➤ 问题解答



**[杭州-后端-梁桂钊]** 消息队列发生消息后，可能消费者宕机而无法消费。绝大多数消息中间件对于这种情况，例如 RabbitMQ、RocketMQ 等引入了 ACK 机制。注意的是，默认的情况下，采用自动应答，这种方式中消息队列会发送消息后立即从消息队列中删除该消息。所以，为了确保消息的可靠投递，我们通过手动 ACK 方式，如果消费者因宕机等原因没有发送 ACK，消息队列会将消息重新发送，保证消息的可靠性。从业务服务处理完相关业务后通过手动 ACK 通知消息队列，消息队列才从消息队列中删除该持久化消息。那么，消息队列如果一直重试失败而无法投递，就会出现消息主动丢弃的情况，我们需要如何解决呢？主业务服务将要发送的消息持久化到本地数据库。从业务服务消费成功后，它也会向消息队列发送一个通知消息，此时它是一个消息的生产者。消费者接收到消息后，最终把本地的持久化消息标志状态为“完成”状态。说到这里，我们应该可以理解到使用“正反向消息机制”确保了消息队列可靠事件投递。当然，补偿机制也是必不可少的。定时任务会从数据库扫描在一定时间内未完成的消息并重新投递。

**[成都-Java-October]** 设计一个消息表，先写表，然后定时任务去做重发。要做幂等。这个表，如果用在关系型数据库，量大。这个表也能追溯系统数据变化。

**[上海-后端-钱杉杉]** 发送方如果发送成功后，可以删掉，也可以用状态标识

**[成都-Java-October]** 删掉的话，就没办法能追溯整个系统的数据变化。 不删除的话，通过状态标识，能追溯，但就是量大。

**[杭州-后端-梁桂钊]** 做一个通用组建比如，监控binlog，把统一收敛到一个溯源平台去记录。数据大，可以通过hbase，或者时序数据库



### 13. dubbo启动时调用生产者为null的问题

> 后端圈⑤
>
> Dubbo  [2019-03-27] 



**[上海-后端-兰峰]** dubbo消费者先启动，生产者没有启动，如果这时候在启动生产者，调用消费中，请求生产者的接口时，为Null，我查了dubbo的文档，里面也有人提这个问题，现在还没有找到解决方案做？



➤ 问题解答



**[杭州-后端-梁桂钊]** Dubbo 会在启动时检查依赖的服务是否可用，不可用时会抛出异常，默认check=true，你的Spring容器是懒加载的，请关闭check，否则服务临时不可用时，会抛出异常，拿到null引用



### 14. MySQL唯一索引优化问题

> 后端圈⑤
>
> MySQL  [2019-03-28] 



**[广州-JAVA-clkbkb]** mysql unique key 是否和index 一样起到查询优化的效果？



➤ 问题解答



**[杭州-后端-梁桂钊]** 可以



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**上海-Java-知秋（博客 ：一叶知秋** [**https://muyinchen.github.io**](https://muyinchen.github.io/)**）**
- ✅**兰小伟 (书籍：《TypeScript实战》)**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**南京-java-祁晓波**
- ✅**上海-后端-钱杉杉**
- ✅**北京-Java-Soez**
- ✅**南京-java-黄勇发**
- ✅**杭州-DBA 杨一**
- ✅**深圳-Java-阿飞**
- ✅**西安-Java-辰九**
- ✅**帝都-大数据-strongant**
- ✅**上海-Java-老三**
- ✅**广州-JAVA-小叶**
- ✅**北京-后端-菜鸟**
- ✅**广州-Java-Thomas**
- ✅**长沙-后端-段十二**
- ✅**北京-java-王泽宇**
- ✅**合肥-java-freeter**
- ✅**济南-后端-释怀**
- ✅**珠海-java-yellowb**
- ✅**福州-java-龍**
- ✅**广州-Java后端-李同学**
- ✅**广州-java-乐**
- ✅**西安-Java-Pano**
- ✅**天津-开发组长-鲁鲁**
- ✅**成都-Java-October**
- ✅**上海-后端-兰峰**
- ✅**广州-JAVA-clkbkb**
- ✅**广州-java-win7@loops**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## **周报 No.64（2019年）**

### 1.  同限定名类强转异常问题

> 后端圈④  [2019-04-08] 



**[北京-java-中中]** 遇到一个诡异的ClassCastException，通过memcachedClient.get(key)从memcache中取到的值和接收的值是同一个类，且实现了Serializable接口，指定了序列化ID，但是却出现强转异常



➤ 问题解答



**[珠海-java-yellob]** 我以前遇到过的一个诡异的ClassCastException是同一个class如果分别由两个不同的classloader加载的话，那么是不能互相赋值的。同名同类加载器才认为是同一个类，猜测应该是安全的考虑吧。

**[北京-后端-sjh]** 我以前json序列化的时候碰到过范型丢失的情况，添加了TypeReference以后没问题。

**[北京-后端-张帆]** 同事遇到过这个情况，原因是用不同的类加载器加载的，因此不认定是同一个类，即便限定名相同，也并不是一个类，Java里好像认定是同一个类必须类加载器实例相同并且限定名相同。



经 **北京-java-中中** 最后核查，确认为 由不同类加载器加载导致。一个类的加载器是webclassloader，一个是urlclassloader，好像一个用的是tomcat的加载器，一个是jvm的加载器，通过把jar包都放在了项目web的lib下解决了该问题。



### 2.  Map.entrySet 元素泛型问题

> 后端圈④  [2019-04-10] 



**[北京-打杂-火柴]** entrySet返回的不就是一个Map.Entry吗？为何会说类型不一致?


![image.png](后端圈问答全集.assets/1555066219403-079fd51d-2fef-4529-875d-a5ec4010d462.png)



➤ 问题解答



**[北京-后端-张帆]** 感觉因为for-each等效于iterator循环，要是你不加泛型那么iterator的next()是返回Object，而不是Map.Entry。

IDEA字节码工具位于：View -> Bytecode


![image.png](后端圈问答全集.assets/1555066363050-b48db125-34e6-4ce4-8636-4426662bc190.png)





### 3.  Redis key 丢失问题

> 后端圈④  [2019-04-10] 



**[北京-打杂-哈哈]** 我们线上服务连续2天，同一个3年有效期的 hash key丢失，showlog也没看到删除。今天目前还没丢失，真诡异，但是 升级4G 升 8G 也就是第二天又发生了。



➤ 问题解答



**[福建-王波-Java]** 一个就是时间设置错了，一个就是淘汰了。可以看看那个key活多久，如果在存活时间内被删除了，一个就是哪里代码有问题被手动删除，还有一个就是内存不够触发了自动删除。



### 4.  表做垂直拆分

> 后端圈①  [2019-04-10] 



**[闵豪]** 大家对订单主表做垂直拆分，大部分系统中的sql都和这张表有关联，拆出去字段后肯定要改大量的sql,有什么建议能尽量少的影响减少拆分之后的影响？



➤ 问题解答



**[杭州-后端-小聂]** 如果真的要垂直拆分，应该有一个过度期，实现双写，然后业务方再改sql。不过不建议啊，可能初期的时候，设计的不周全，导致后期出现这种情况。



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**北京-后端-张帆（博客** **：Since1986** [https://since1986.github.io](https://since1986.github.io/)**）**
- ✅珠海-java-yellob
- ✅北京-后端-sjh
- ✅福建-王波-Java
- ✅杭州-后端-小聂
- ✅北京-java-中中
- ✅北京-打杂-火柴
- ✅北京-打杂-哈哈
- ✅闵豪

## **周报 No.65（2019年）**

### **1.关于分表**

> 后端圈④  [2019-04-16] 



**[重庆-Java-crossoverJie]** 分享了一篇关于分表实践的文章 「[一次分表踩坑实践的探讨](https://mp.weixin.qq.com/s/2txWBSZDr6A-pjue5g4X5Q)」

>  **临时方案**
>
> 由于需求紧、人手缺的情况下，整个处理的过程分为几个阶段。
>
> 
>
> 第一阶段应该是去年底，当时运维反应 `MySQL` 所在的主机内存占用很高，整体负载也居高不下，导致整个 MySQL 的吞吐量明显降低（写入、查询数据都明显减慢）。
>
> 
>
> 为此我们找出了数据量最大的几张表，发现大部分数据量在7/8000W 左右，少数的已经突破一亿。
>
> 
>
> 通过业务层面进行分析发现，这些数据多数都是用户产生的一些**日志型数据**，而且这些数据在业务上并不是强相关的，甚至两三个月前的数据其实已经不需要实时查询了。
>
> 
>
> 因为接近年底，尽可能的不想去动应用，考虑是否可以在运维层面缓解压力；主要的目的就是把单表的数据量降低。
>
> 
>
> 原本是想把两个月之前的数据直接迁移出来放到备份表中，但在准备实施的过程中发现一个大坑。
>
> 
>
> 表中没有一个可以排序的索引，导致我们无法快速的筛选出一部分数据！这真是一个深坑，为后面的一些优化埋了个地雷；即便是加索引也需要花几个小时（具体多久没敢在生产测试）。
>
> 
>
> 如果我们强行按照时间进行筛选，可能查询出 4000W 的数据就得花上好几个小时；这显然是行不通的。
>
> 于是我们便想到了一个大胆的想法：这部分数据是否可以直接不要了？
>
> 
>
> 这可能是最有效及最快的方式了，和产品沟通后得知这部分数据真的只是日志型的数据，即便是报表出不来今后补上也是可以的。
>
> 
>
> 于是我们就简单粗暴的做了以下事情：
>
> - 修改原有表的表名，比如加上( `_190416bak`)。
> - 再新建一张和原有表名称相同的表。
>
> 
>
> 这样新的数据就写到了新表，同时业务上也是使用的这个数据量较小的新表。
>
> 虽说过程不太优雅，但至少是解决了问题同时也给我们做技术改造预留了时间。



➤ 相关讨论



**[杭州-后端-梁桂钊]** 

写得好，我补充一下，上亿的数据加索引用不了几个小时，几分钟就可以了，即使出现表锁，但是日志表还是可以接受的。另外，日志表采取mysql分析可能也是过渡方案，后面真的要做一些报表，可能性能上需要考虑下。



**[北京-后端-望重]** 

几个小时不需要，不过几分钟好像也不止。但是确实不像想象的费时——前提是像作者说的，直接改名去折腾，总体策略还是挺赞成的，具体场景具体分析吧。 mysql上亿没试过，oracle不慢，不过在线表的话，因为冲突问题就慢了。



**[深圳-Java-阿飞]** 

取决于服务器性能，如果是32核&64G这种云主机顶配，应该不会超过10分钟。



**[北京-java-犀利豆]** 

主要是io吧。之前加过大索引特别怕，和dba沟通了以后，dba说ssd的硬盘。不会很慢。

------

### **2.关于同步非阻塞**

> 后端圈④  [2019-04-16] 



**[北京-后端-乔志勇] 同步非阻塞 io 是针对客户端还是服务端来说的？**



➤ 问题解答



**[兰小伟-《TypeScript实战》]**
同步异步是针对Server端而言，阻塞or非阻塞指的是Client端而言。



异步同步指的是服务提供者提供服务的方式，是立马服务，还是先接待，慢慢做，做完了，再通知你，客户无法立马得到服务。同步是 你要啥，当场就拿给你，异步是 你要啥，我记下了，我慢慢做，做好了，我通知你。

比如，饭店里一般都是异步的，你下单后，是先给你个号，做好了再通知你（通知有好几种方式，我放到你指定的位置，你自己去拿，一种是我通知你做好了，你自己过来拿，一种是自己主动不停的问：做好了吗？），不是立马为你服务。



阻塞非阻塞说的是服务需求者在得到服务反馈之前需不需要等待。



Reactor模型

一个Accptor线程，专门用来负责与Client建立连接，你可以类比到饭店门外的揽客的服务员，专门拉客进去消费的。

一个或多个EventLoop，用来负责接待顾客，你可以类比到饭店里服务接待顾客下单的服务员，你点菜，她会记录下来，然后把下单请求记录到系统，系统再把订单分派给厨师去异步处理。处理线程：就是真正干活的，类比饭店里的厨师。(***{**江苏-互联网-零度}*** *Reactor模型很多，可以是单线程模型、可以是多线程模型，也可以是主从多线程模型。)*单线程模型就是同时只有一个厨师干活，干完了，下一个订单再派个厨师上来接着干。



**[dandy-深圳]** **[*江苏-互联网-零度*]** 

redis底层就是用epoll实现，所以它是同步io，为什么说是非阻塞是因为创建fd的时候，就设置为非阻塞模式，内核通知就绪的fd时候，才去处理



可参考「[NIO相关基础篇三](http://www.jiangxinlingdu.com/thought/2017/12/26/nio3.html)」「[Scalable IO in Java](http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf)」
![image.png](后端圈问答全集.assets/1555675171626-bef741a9-2908-4b1a-91d8-a966a5058419.png)

**[上海_java_小星]** 可参考 「[Scalable IO in Java](http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf)」「[Reactor](https://www.yuque.com/lianggzone-coreuser/rpx746/twgd3p/edit)

[An Object Behavioral Pattern for Demultiplexing and Dispatching Handles for Synchronous Events](https://pdfs.semanticscholar.org/5b2d/55303860cbaafc911c08a51f38c5c8f9580f.pdf?_ga=2.207892688.373785767.1555675706-213900980.1555675706)」

------

### **3.“阻塞”的本质是什么**

> 后端圈④  [2019-04-16] 



**[珠海-java-yellowb]** “阻塞”的本质是什么呢？或者阻塞的根本原因是什么呢？个人理解对于socket read来说，是因为内核socket read buffer还没有数据进来，所以要“阻塞”等待数据到来。不知道这个理解对不对？



➤ 问题解答



**[*江苏-互联网-零度*]**  

1 等待数据准备 (Waiting for the data to be ready)

2 将数据从内核拷贝到进程中 (Copying the data from the kernel to the process)

可参考「[NIO相关基础篇三](http://www.jiangxinlingdu.com/thought/2017/12/26/nio3.html)」

![image.png](后端圈问答全集.assets/1555675495842-e92cdb0d-d2f1-400d-81e4-b8aaf268b57f.png)

------

### **4.如何发现Redis热点Key**

> 后端圈④  [2019-04-17] 



**[成都-后端-北极之北]** 大家是怎么来发现redis的热点key的呢，除了在业务层来做统计，redis本身有没有提供一些插件来统计呢？



➤ 问题解答



**[珠海-java-yellowb]**

**![image.png](后端圈问答全集.assets/1555678156502-60c59ca3-ae64-43bf-83a9-230304756cbf.png)**

**![image.png](后端圈问答全集.assets/1555678166260-fc53c035-7752-47be-a623-d3475b7778d3.png)**



>  [[Feature\] redis can support a HOTKEYS command like SLOWLOG which record top N hot keys in memory，N is configurable ](https://github.com/antirez/redis/issues/4554)[#4554](https://github.com/antirez/redis/issues/4554)

**{西安-java-健}** *hotkeys会不会像keys一样，在大数据量时候造成堵塞了?*

看源码里的注释可能会


![image.png](后端圈问答全集.assets/1555678298097-aabc8f53-9acb-4b4c-9fc5-a0ab59cc4d04.png)



------

### **5.多租户与数据权限的区别是什么**

> 后端圈⑤  [2019-04-17] 



**[北京-后端~顾小白]** 大家对多租户都是怎么理解的，他和数据权限的实质区别



➤ 问题解答



**[杭州-后端-梁桂钊]**
看怎么实现，如果是私有化那么就没有数据权限一说。如果是一个产品中根据租户隔离，那么我们就需要数据隔离，这个时候数据权限很重要，需要鉴权。比如，我的业务中租户就是商家，那么这种情况，角色，权限，数据都是隔离的。

------

### **6.关于Spring的事件监听**

> 后端圈④  [2019-04-20] 



**[合肥-后端–kewen]** 我利用spring 的事件监听机制监听容器启动完成事件，然后在onApplicationEvent方法中启动netty websocket服务，但目前有个问题netty websocket服务可以启动并进行正常访问，但我的spring boot http服务不能访问了，有遇到的吗？


![image.png](后端圈问答全集.assets/1555898010452-64a3937e-04c6-4ef0-8eee-db0937c5f729.png)



➤ 问题解答



**[杭州-后端-hexsmith]**

你把监听事件改一下，改成[ApplicationReadyEvent](https://www.jianshu.com/p/1864f8277a1d)

------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**重庆-Java-crossoverJie（公众号 ：**crossoverJie**）**
- ✅**杭州-后端-梁桂钊（公众号 ：**服务端思维**）**
- ✅**北京-后端-望重**
- ✅**深圳-Java-阿飞（公众号 ：阿飞的博客）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**北京-后端-乔志勇**
- ✅**兰小伟-《TypeScript实战》（书籍：《TypeScript实战》）**
- ✅**dandy-深圳**
- ✅***江苏-互联网-零度*（公众号 ：匠心零度）**
- ✅**上海_java_小星**
- ✅**珠海-java-yellowb**
- ✅**成都-后端-北极之北**
- ✅**西安-java-健**
- ✅**北京-后端~顾小白**
- ✅**合肥-后端–kewen**
- ✅**杭州-后端-hexsmith**

## **周报 No.66（2019年）**

### **1.**如何保持mysql和redis中数据的一致性？



**[北京-后端-望重]**  如何保持mysql和redis中数据的一致性？



➤ 问题解答

**[北京-后端-望重]** https://www.zhihu.com/question/319817091/answer/653985863  



**[福州-SRE-赤月]** 那么在分布式条件下就要牺牲A。比如访问一个Cache，Cache知道自己的数据不是最新的，就要和DB去Sync



**[北京-后端-望重]**就是有几种策略，redis定时失效，或者更新数据库时候删除redis，常见这2种策略吧

所以要一致，直接单点到db，但是失去了高可用和高性能，总归是看业务的选择



**[北京-java-犀利豆]** https://coolshell.cn/articles/17416.html 

------

### **2.Spring Cloud 的Feign**



**[北京-后端-火柴]** @FeignClient 调用其他服务 为什么偶尔会莫名其妙的返回一个 LinkedHashMap类型?



➤ 问题解答

**[北京-后端-火柴]** 

**![image.png](后端圈问答全集.assets/1557059909017-d9b2919d-e18d-4846-b297-112c13537ca4.png)**

**![image.png](后端圈问答全集.assets/1557059920798-33e83db3-fcd5-4b61-901a-af90ea5335d4.png)**

需要自己控制泛型,进行处理.

https://blog.csdn.net/qq_20746277/article/details/80923207

------

### **3.JPA与动态SQL关系**



**[北京-java-water]** .请问JPA适合写复杂sql么？比如动态sql，我感觉支持的不是很好  



➤ 问题解答



**[福州-java-龍]**  调研的时候有个，不过save实现的比较无语，save之就调用刷新索引接口进行索引强制刷新

jpa不是银弹，解决简单的查询就好了 我的想法

复杂点的，可以用findbyexample 或则Specification 处理



**[北京-java-water]** 但感觉Specification还是有一点不方便，我想像mybatis那样写动态sql能实现么?



**[杭州-Java-Jeffpan]**  不可以，JPA 的设计思想就是面向 Domain 来的，不是为了解决查询问题而生



**[上海-后端-知秋]**  搞不定的地方就写sql，不要被过于被概念束缚,又不是不支持

------

### **4.业务理解和分析能力**



**[北京-后端-火柴]** 如何提高自己的业务理解能力?自己业务理解能力太弱了



➤ 问题解答



**[杭州-Java-独玄]**业务流程图，uml ,理解上下游,如果刚进去可以找同事review下自己画得怎样 



**[北京-后端-望重]** 慢慢思考呗，我也觉得一开始做新业务比较难入手，这时候从上到下，或者从一个模块开始画，懂的画，这样一个个分支就慢慢挖掘开了



**[上海-后端-知秋]**从整体到局部，你做保险就要对保险这个行业的产品套路多了解，而不应该仅仅是停留在代码层面,行业之间看似差别很大，其实本质上大同小异   



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**北京-后端-火柴**
- ✅**北京-后端-望重**
- ✅**上海-Java-知秋（博客 ：一叶知秋** [**https://muyinchen.github.io**](https://muyinchen.github.io/)**）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**福州-SRE-赤月**
- ✅**北京-java-water**
- ✅**福州-java-龍**
- ✅**杭州-Java-Jeffpan**
- ✅**杭州-Java-独玄**

## **周报 No.67（2019年）**

### 1. 微服务的多系统调用



> 后端圈① [2019-05-09]



**[福州-服务端-蒋峰]** 问个问题，如果 A 系统要用到 B 系统的数据，是 B 系统推送过去 A 系统，A 系统冗余保存一份好，还是 A 系统每次都调用 B 系统的接口去获取好啊。数据不会变了的。如果除了 A 之外，还有 C、D 系统要用到 B 系统的数据呢？



➤ 问题解答



**[广州-java-win7@loops]**

方式1、接口去业务库读取

方式2、数据库冗余数据

方式3、数据冗余到专门的中间库读（数据仓库），接口去数据仓库读，不直接去业务库读。



**[福州-服务端-蒋峰]** 我是打算用共享内核模式去做。不同的限界上下文通过一个公共的服务去获取基础数据。这个概念出自领域驱动设计方法，https://www.jianshu.com/p/3af5f7c0ec7c



**[杭州-后端-董鹏]** 这种一般还是 a 系统调用 b 系统接口吧，毕竟是两个系统两个领域，一次网络调用也没有太大开销，至于读主库还是从库可以通过b系统的接口来控制。



**[杭州-后端-Viggox]** 如果是那种需要调其他接口调万年不变数据的情形，可以考虑设计一个类似于配置中心的系统，初始化时配置中心调用 rpc 拉取指定数据并存储，订阅 provider 的增量变更，然后消费方只需要从配置中心集中获取数据就可以了。



**[无锡-java-何大葱]** 数据不会变的情况可以走消息队列或者集中式缓存。



### 2. RocketMQ 多次发送未消费



> 后端圈① [2019-05-10]



**[Snake]** 我的 RocketMQ 发一个消息，一个客户端会拉三次，消费三次，为啥？



➤ 问题解答



**[上海-后端-田守枝]** 不保证 exactly once 语义，即不保证只消费一次，需要业务自己做幂等。RocketMQ 发送方的默认重试次数刚好是 3 次。发送一条消息时，超时时间内，如果失败了，会自动重试。第一次发送，加上 2 次重试，总共是 3 次。3 秒内，如果第一次发送失败，则进行重试，最多重试 2 次。如果 3 秒内成功了，不会抛出异常。所以虽然看起来调用了一次，实际上可能不止一次。每次重试可能是发送到不同的 broker，比较难查，如果是线上业务，一直有数据发送的话，更不容易确定。如果只是自己搭建个 broker，写个 demo 玩的话，可以通过 console，看一下发送一条消息，有几个 partition 的 offset 增加了。正常只会有一个 partition 的 offset 增加 1，这个时候说明，只发送了一次，生产者没有重复发送。以为默认大家都说的使用 consumer group。使用 consumer group 的情况下，消费者判断消息是否重复发送，可以根据 UNIQ_KEY 来判断，如果消息内容相同，UNIQ_KEY 不同，则说明可能是重复发送了。



**[南京-后端-零度]** 这种问题排查就排除法就行了，先看看 broker 这个数据到底有几份，看看是 p 问题还是 c 问题，还根据情况查一会就查出来了。



### 3. 如何解决消息重复发送的问题



> 后端圈① [2019-05-11]



**[上海-Java-老三]** 那么问题来了，如何解决消息重复发送的问题？



➤ 问题解答



**[杭州-后端-董鹏]** 消息重复的问题，没办法解决的，只要在网络传输，中间件解决不了，可以在消费端存储消息 id 来去重。



**[上海-后端-sion]** producer 到 broker 为了保证不丢，那么需要重复发送等应答，这样就可能出现重复，同时 consumer 从 broker 获取消息，为了不丢失 也需要等应答或重新获取，也可能会重复。一般来说，是需要在 consumer 端的业务逻辑里去重。



### 4. RocketMQ 是否可以支持自定义时间



> 后端圈① [2019-05-12]



**[杭州-后端-梁桂钊]** RocketMQ 是否可以支持自定义时间？



➤ 问题解答



**[杭州-后端-梁桂钊]** 忘记是谁之前问的 RocketMQ 是否可以支持自定义时间，我正好看了下，阿里云的 RocketMQ 是支持使用定时消息的，msg.setStartDeliverTime 参数可设置40天内的任何时刻（单位毫秒），超过40天消息发送将失败。当然，开源版是不支持的。



### 5. jib 构建超时



> 后端圈② [2019-05-09]



**[大南京-大后端-Tayl0r]**  请问下 jib 构建时，base 镜像太大导致 Read timed out？



➤ 问题解答



**[上海-Java-老三]** setting 设置大点吧。



**[大南京-大后端-Tayl0r]** 搞定！新增了 jib.httpTimeout=0 参数。



### 6. netty自动分配端口号



> 后端圈② [2019-05-10]



**[北京－Java－Mr.Xi]** netty自动分配端口号，怎么搞？



➤ 问题解答



**[合肥-后端–kewen]** 利用事件监听，那个绑定方法本身是个异步方法，这样我们就可以通过事件监听的方式进行处理。



### 7. 验证规则的实现



> 后端圈⑤ [2019-05-07]



**[重庆-后端-谭鹏]** 验证一个 word 文档的内容填写是否规范，通过预定的 5000 条文字规则去跑这一篇文档(就是说每一条数据进来都需要通过这 5000 条数据进行验证，如果不规范，要返回为什么不规范的原因)，各位有什么好的建议呀？或者相关的库？因为我们现在有一个基础版本的，规则校验都是通过大量的遍历判断，来做的，对规则的频繁变更和学习行为不能满足。



➤ 问题解答



**[杭州-后端-梁桂钊]** 规则不多，基于模版方法模式固化流程，然后实现类就是一个个规则策略。如果规则很多，优先考虑规则引擎。



**[重庆-后端-谭鹏]** 使用规则引擎就不需要我们在业务代码中循环遍历去做规则匹配了，大大简化了业务代码，现在我们只需要关心，如何制定规则。



### 8. offer 操作为什么是非阻塞的



> 后端圈⑤ [2019-05-09]



**[西安-后端-刘欢]** 我看的是翟陆续的《java并发编程之美》，offer 操作为什么是非阻塞的？



![img](后端圈问答全集.assets/1557641522184-7e4f0ae5-a688-4195-a7d3-547acf288194.png)



➤ 问题解答



**[上海-后端-知秋]** 觉得写并发文章作者没必要犯如此低级的错误。



**[上海-java-阿飞]** 我觉得是在队列满时put阻塞、offer操作满时返回false，作者想表达这个意思。



**[西安-后端-刘欢]** 加 ReentrantLock 锁时一定是阻塞吧？



**[上海-后端-知秋]** 这个理由不成立的。不满的时候可能会阻塞的。



**[上海-java-阿飞]** 具体来讲是条件上不满足才阻塞，不满也阻塞也是的。



**[上海-后端-知秋]** 除非提前返回 future 的这种方法，你可以认为是非阻塞，把阻塞操作放在子线程中进行。



**[西安-后端-刘欢]** 对应 put 方法满了的时候 wait 这个阻塞可以理解。



**[上海-后端-知秋]**  请理解好方法非阻塞这个概念，这也是为什么会设定 future 以及 nio 中 selector 这些角色的存在。



**[西安-后端-刘欢]** offer阻塞，但是在队列满的时候，直接返回失败，put 也是阻塞，但是满的时候会等待，在队列有空位时再加入列尾。



**[上海-后端-知秋]** put 结合了 condition 锁的用法。即是重入锁和 condition 锁搭配实现类似协程效果，保留了当前锁程度的状态。



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**上海-Java-知秋（博客 ：一叶知秋 https://muyinchen.github.io）**
- ✅**杭州-后端-董鹏（公众号 ：内核小王子）**
- ✅**南京-后端-零度（公众号 ：匠心零度）**
- ✅**上海-后端-田守枝（公众号 ：田守枝的技术博客）**
- ✅**上海-Java-老三**
- ✅**重庆-后端-谭鹏**
- ✅**合肥-后端–kewen**
- ✅**西安-后端-刘欢**
- ✅**杭州-后端-Viggox**
- ✅**Snake**
- ✅**北京－Java－Mr.Xi**
- ✅**上海-后端-sion**
- ✅**无锡-java-何大葱**
- ✅**大南京-大后端-Tayl0r**
- ✅**广州-java-win7@loops**  
- ✅**宁波-java-金鑫**
- ✅**福州-服务端-蒋峰**
- ✅**上海-java-阿飞**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## **周报 No.68（2019年）**

### 1. 好的表单校验插件

> 后端圈① [2019-05-14]



**[西安-java-心程]** 谁有好的表单校验插件，推荐一个。引入js 就可以用的那种



➤ 问题解答



**[杭州-后端-梁桂钊]** 纯前端校验有风险吧

**[上海-Java-老三]** 风险系数很大, 前后端双重校验才是完美。一些判空，格式，范围之类的，前端做掉也很好，前端检验就是给普通用户看的，提高体验。

**[上海-后端-知秋]** 后端检验是为了安全。

**[北京-后端-张帆]** 可以用 “front end validation” 去搜一下，我看结果里有个 parsleyjs 排名比较靠前你可以参考，个人觉得前端验证去做前端的事（交互）后端验证做后端的事（保证数据安全一致），后段的验证大可以抛异常自己知道就好了，可以给前段提供专门用于验证的API，和主逻辑分离开，麻烦一点但是灵活。



### 2. 增强 RestTemplate

> 后端圈① [2019-05-14]



**[上海-后端-宝宝]** 现在我想在调用 RestTemplate 封装的 get，post 等方法，可以在调用方法前后打印时间戳，我要怎么通过aop去增强这个 RestTemplate？



➤ 问题解答



**[厦门-java-無式]** resttemplate interceptor

**[上海-Java-carl]** 自己写个代理类，代理一个 RestTemplate 不就行了。

**[上海-Java-老三]** aop 的 before 能满足你。aop 的 pointcut 是 resttamplate 全路径的限定啊。



### 3. redis 的 setnx 实现的分布式锁

> 后端圈① [2019-05-15]



**[北京-后端-hxy]** 各位大佬，redis 的 setnx 是怎么实现的分布式锁？



➤ 问题解答



**[上海-Java-老三]** set not exist 在一条线程完成的动作。

**[杭州-java-菜鸟]** 可以去看下 redission 的原理

**[北京-java-犀利豆]** 我理解就是 Redis 是单线程。一次命令自然是原子的。可以阅读：https://xilidou.com/tags/redis/

**[Jack]** redisson 底层不是通过 setnx 处理，因为考虑到重入问题，底层是 hash 实现。



### 4. insert into 在数据量很大的情况下会丢数据吗

> 后端圈① [2019-05-16]



**[深圳-后端-忍者]** 大佬们，insert into 在数据量很大的情况下会丢数据吗？



➤ 问题解答



**[杭州-后端-梁桂钊]** 我记得 MySQL 对 SQL 语句大小有限制，可以调整 max_allowed_packet 来调整。



### 5. 设置数据库连接池的核心连接数

> 后端圈① [2019-05-17]



**[上海-后端-宝宝]** 大家好，linux 的 backlog 是 128。那我设置数据库连接池的核心连接数是 200，会不会不合理？我理解是数据库连接池的 connection 是 tcp 连接，握手成功的都会保存到 accept queue 里。我觉得我理解错了，但是不知道错在哪。



➤ 问题解答



**[上海-JAVA-涤生]** 没有关系，backlog 配置的大小只是缓冲。 Accept之后会从 queue 删掉。

**[上海-后端-sion]** backlog 是 tcp 栈里把新连接交给上层应用处理时，在排队等待处理的新进连接，仅仅只是处理新连接的排队。连接池 200。如果你担心，那应该担心最大文件数问题。嗯，accept 后就逃出升天了，不受 tcp backlog限制。



### 6. 经常对数据进行 update 操作

> 后端圈① [2019-05-18]



**[广州-java-森明]** 我有一个库存表，要经常对数据进行update操作？有可能几个线程都是 update 同一行数据，有没有什么优化思路？



➤ 问题解答



**[深圳-Java-eumji]** 多线程 update 同一行，我觉得最好避免。

**[福州-Java-王波]** 考虑异步吗，丢到消息队列去做。

**[广州-后端-CJ]** 发货为什么会并发修改，这种并发会很大？

**[广州-java-森明]** 多线程去跑发货，发货减库存。

**[福州-Java-王波]** 修改应该是修改单个货物的库存，单个货物有这么大发货量。

**[广州-后端-CJ]** 可以先申请一批，发完货统一扣减数量，而不是一个一个扣减。

**[北京-后端-hxy]** 你这有点像秒杀啊。

**[广州-java-森明]** 但是又存在仓库入库加库存的问题。

**[深圳-Java-eumji]** 其实还是的看你对库存的精确度有没有什么限制。都通过mq消费了，应该相对来说竞争没那么激烈。

**[杭州-java-阿涛啊]** 是一个商品多次发货，导致多次更新了同一个商品的对应的库存记录么？

**[广州-java-森明]** 我想了一下，用银行记流水的方式貌似不错。



### 7. 导出csv文件的样式化

> 后端圈② [2019-05-14]



**[北京－Java－Mr.Xi]** 导出 csv 文件里面有重复的内容，怎么把重复的内容进行合并单元格？



➤ 问题解答



**[杭州-后端-梁桂钊]** csv貌似不能处理样式吧

**[广州-JAVA-蝴蝶落于指尖]** csv本质只是文本而已，没有样式的。

**[北京-Java-小信]** 处理数据的,为啥不是事先处理好了,等到导出 csv 的时候再处理...

**[广州-后端-anker]** 选 xls了。csv 没有格式一说。



### 8. 各个服务之间关于异常需要传递吗？

> 后端圈② [2019-05-15]



**[杭州-后端-ZMM]** 请教一下，各个服务之间关于异常需要传递吗？比如 a 调用 b，b 出了问题，异常应该传递给 a 吗，还是自己处理？



➤ 问题解答



**[杭州-后端-梁桂钊]** 我的建议是转换成状态码。

**[杭州-java开发-forever]** 转换成状态码，调用者看到异常状态码，降级或者限流。

**[南京-JAVA-曹炜]** 用 dubbo 是直接传递，用 sc 就得通过状态了。如果是 dubbo，更加接近与本地方法的模式，保留异常，通过强类型去传递，你自己 controller 里调用 service 方法总不至于 service 方法无异常声明，通过返回值的状态码去识别吧。统一耦合异常，让正常逻辑和异常逻辑隔离，统一有个异常收集点去返回错误信息。如果是sc，你想保留异常都困难，得调用者去封装。

**[杭州-后端-ZMM]** 这样可以由服务提供者来处理信息，不然由调用来处理的话不合理。



### 9. 视图在项目里面的使用

> 后端圈② [2019-05-15]



**[武汉-java-千年]** 请问大佬们一个问题。视图项目里面用的多么？



➤ 问题解答



**[广州-后端-anker]** 最好不用，如果视图性能有问题，那么后面的查询性能都有问题。

**[深圳-Java-深秋]** 视图只是将数据简单化吧。真正的速度还得看 sql 执行效率，除非你的视图有缓存功能。

**[武汉-java-千年]** 那如果我新建了一个视图。如果在对视图里查询的表数据进行修改，那么视图还有意义么？

**[南京-JAVA-曹炜]** 会同步的，视图不局限于数据库里的视图，只是查询和操作分离的一种手段。同步也可以自己玩。

**[武汉-java-千年]** 谢谢大佬们，我就是今天想着为啥不把慢的查询都建立视图，然后直接查。因为感觉视图不就是为了避免重复查询，节约时间么。

**[南京-JAVA-曹炜]** 有几种情况下，可以考虑视图：数据量大，查询性能慢，可以考虑通过 es 构建视图；数据来源的表太多，组装起来比较复杂，或者是查询条件分散在多张表里。视图是为了应对查询，不是为了数据简单化，相反，会复杂化。还有一层含义就是 cqrs 里的操作和读取分离，分离的好处就是不让查询的复杂度污染业务逻辑。

**[深圳-Java-深秋]** 你把复杂的查询组合成一个视图不就操作简单了，如果你的查询过于庞大，复杂可以整成一个视图。

**[长沙-后端-陈同学]** 视图一用，就停不下来，各种查询都想偷懒用视图。如果存在跨库查询，最后会把整个db的依赖搞的错综复杂。如果要克隆新环境，就存在执行顺序的问题。



### 10. 任务分派系统设计

> 后端圈④ [2019-05-14]



**[珠海-java-yellowb]** 现在想设计一个任务分派系统，当前有n个客服P1Pn，任务种类T1Tm，假设我已经通过统计等方式知道了每一个客服做每一种任务需要的时间（比如P4这个客服->做T8这个任务 = 60s）,那么应该如何设计这个系统，使得整个客服团队完成任务的效率最高？（可能考虑单个任务的平均完成时间 or 一天整个团队完成的任务量）。简单假设1个客服不会同时做2个或以上的任务，任务是流式源源不断地进入系统的？



➤ 问题解答



**[To0R𓃰]** 是指派还是系统分配，那你需要定义的东西还挺多。比如优先级，任务级别，客服级别等。

**[Tomy_Rich]** 效率高，是不是说就意味着，如果A团队处理T任务比B团队快的话，那么以后就会将所有的T任务交给A来处理。感觉你这个目前最主要的是算法，不是设计。

**[王波]** 加权轮训，能者多劳的意思。

**[上海-后端-知秋]** 这些细节可以留待以后做业务优化，先实现主要的，能用上才是正道。前期没必要给自己加需求，要敏捷开发干嘛，你可以做成一期二期三期任务不就好了。

**[珠海-java-yellowb]** 先从一个最小可用的 demo 做起，就算做出来了，也不打算立刻就替换掉人工分派，估计只是会小范围试用或只是给出分配建议，分配还是人工，然后用这些人工分配记录再做分析优化模型。



### 11. oracle 并发执行 for update 语句遇到阻塞问题

> 后端圈④ [2019-05-14]



**[广州-后端-张乘辉]** 各位有没有遇到过 oracle 并发执行 for update 语句遇到阻塞问题？



> 后端圈④ [2019-05-14]



**[广州-后端-张乘辉]** 按道理，一条 sql 语句 commit 或 rollback 了会释放数据库资源。autocommit 可以在三个地方设置，第一层框架层 mybatis，第二层数据库连接池，第三层数据库，而我看过一些 Spring 的事务管理器以及 Spring 整合 Mybatis 的 jdbc 事务管理器，发现数据库连接池的 autocommit 设置会覆盖掉框架层 mybatis 的 autocommit 设置，而 mybatis 的 autocommit 默认为 false，mybatis 的底层源码 commit 方法，会首先判断 connection 对象是否已提交，如果提交了就不再重复提交。从上面的分析得出，如果我们用了 mybatis，默认情况下执行一条 sql 都会帮我们 commit，也即是如果不加 spring 的事务，每条 sql 都是一个事务。基于上面的分析我试过了 mysql 数据的 autocommit 为 true 和 false 的并发执行，发现并不会阻塞，都会提交。oracle 数据库 autocommit 默认为 false，我试过了并发执行，发现 sql 如果在同一个 connection 对象（ID相同）执行，不会阻塞，如果并发执行时，有两个 connection（ID不同）对象，就会发生阻塞。按道理，mybatis执行每条sql都会自动帮我们commit了，也就是执行完for update语句之后就会释放，不存在阻塞。但现在就出现了mysql不会阻塞，而oracle会发生阻塞。基于上面的实战分析，我有将for update语句外面包装一层spring事务，这种情况下发现oracle并不会阻塞。按道理说，如果不加spring事务，mybatis会为每条sql commit，如果数据库连接池的autocommit=true，那么也就是连接对象帮我们提交了，mybatis不会重复提交。spring整个mybatis下的SpringManagedTransaction事务管理器。不加spring事务，mybatis同样会commit。虽然for update平时很少用，但是公司有些地方用，按照常识来说，我们一般都会将for update丢到spring事务里面，先for update锁住资源，然后执行一些涉及事务的操作，最后才通过spring事务提交commit，而我们公司有些人忘记将for update语句丢到spring事务了，导致了并发时发生阻塞，按照我的常规理解，这应该是for update语句此时不生效，应为执行完立马被mybatis给commit掉了，此时发生并发脏数据才是正常。然后我用mysql来测试，发现如我想的一毛一样，这时候for update不会有锁住资源，执行完就被commit释放掉了。是不是因为oracle并不会马上commit？导致了如果出现两个connection对象时会发生阻塞。

**[广州-后端-张乘辉]** 由for update引发的血案 : http://mp.weixin.qq.com/s?__biz=MzU3MjQ1ODcwNQ==&mid=2247483878&idx=1&sn=468f284550961e28a2f036b5e88e88f8&chksm=fcd1d258cba65b4e86100016bf6595682f1df06f56b304c0b21b16039c6d9a824a53e167bc2b&mpshare=1&scene=1&srcid=#rd

**[广州-后端-张乘辉]** 关于前天 for update 遇到阻塞的问题，我自己总结了一波，分析了应用层相关的源码之后，也对比了 MySQL，大概总结出是因为，连接池 autocommit=true 设置对 oracle for update 语句无效，不会显示发出 commit 命令，反复跟公司 DBA 调试查日志得出。欢迎大佬们一起讨论。



### 12. 内网各个 service 之间的调用

> 后端圈④ [2019-05-16]



**[珠海-java-yellowb]** 各位大佬，一般公司内网各个 service 之间的调用，API是走 restful json 的形式，还是用 protobuf 之类的东西序列化成二进制再传输？



➤ 问题解答



**[杭州-后端-梁桂钊]** 其实都可以，就看公司内部的规范了，有的是全栈 restful api，有的内部 rpc，对外 http。pb，多用于性能要求高的，比如我们之前做直播业务，就是用 pb 传输。

**[北京-后端-望重]** 内部调用看性能要求吧，不过反过来说，大部分公司的需求，json格式没啥问题。

**[北京-java-西希家]** 我们内部就是 rpc，对外 https。

**[上海-后端-知秋]** 性能这个东西是多方面的，木桶效应。比如 web 服务，当下最大的瓶颈还是在于传统的 servlet 服务器，对系统资源的利用和 netty 服务器确实差了很多。jdk 版本同样是，未来大家全面走向 jdk11 时就会发现，新版本比 jdk8 快很多。这个是平台因素，自己项目的代码质量，也是一个很重要的方面。很多时候并不是性能高我们就选择它，这就好比编程语言的选择一样，为什么 JAVA 这么流行，就在于我们用起来很舒服，有 jvm 的存在，开发者的一个原则就是选择自己最熟悉的，驾驭的住的，不要盲目追新，自己平时可以多玩一些新事物，提前准备。



### 13. 流程调度一般用什么引擎

> 后端圈④ [2019-05-16]



**[北京-后端-望重]** 也抛个话题：大家流程调度一般用什么引擎？《大数据平台基础架构指南》这本书提到的开源流程引擎我觉得都偏简单了。。可能还不如 Easy Scheduler 来的方便。我自己的经历，其实一般都是自研流程引擎的。话题是：目前开源软件中，哪些流程引擎功能上比较强？



➤ 问题解答



**[广州_java_wen头]** 流程引擎功能这个要针对居然业务吧.

**[北京-后端-望重]** 流程引擎这块我觉得算是挺常见的需求，算是和分布式任务调度结合起来吧，目前分布式任务调度我知道有3个，阿里一个，elastic-job xxl-job，应该实现都挺好了。但是流程引擎我看了下，大多比较粗糙。。我们国产的Easy Scheduler感觉还算是最好的？



### 14. 如何提高设计思想

> 后端圈④ [2019-05-20]



**[上海-java-小石头]** 能问问大佬，如何提高设计思想这方面的东西吗



➤ 问题解答



**[北京-后端-望重]** 这个没有捷径，只有把该看的书都看了，在项目中积累经验呗。而且所谓设计思想，在现实工作中很难直观的说明一个人设计水平高。填多了也有心得了，另外碰到坑可以多查查资料，看看其他人是怎么解决的，其实就是多看看其他的思路，太阳底下没新鲜事，看多了，你会发现，其实大牛的思路总体是差不多的。就是所谓的最佳实践。。



### 15. hibernate 的外键配置

> 后端圈⑤ [2019-05-15]



**[西安-后端-刘欢]** 我现在有个需求将一张大表分为一个主表，三个从表，使用 hibernate 的懒加载。为什么一定要 id 相同才能查找成功，是不是需要添加外键约束？



➤ 问题解答



**[广州-后端java-阿涩]** 对于单项配置，如果从表里面没有与主表关联的 id，你那样配置应该就会报。No row with the given identifier exists。配置加 not-found=ignore，实体上加 @NotFound(action=NotFoundAction.IGNORE) ？看有没有用。



### 16. jvm 怎么知道不会回收 spring 中的 bean

> 后端圈⑤ [2019-05-17]



**[厦门-java-张3]** jvm 怎么知道不会回收 spring 中的 bean



➤ 问题解答



**[上海-后端-知秋]** Spring 自我管理的 bean 是放在一个容器中管理的，你可以认为是一个 list 或者 map，剩下的没有强引用的，该被咔嚓就会被咔嚓掉的。

**[杭州-后端-梁桂钊]** spring 的对象放在 map 中，强引用 ，这样创建的对象存在 map 中和 GC Roots 对象相连，所以不会被回收。



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**上海-Java-知秋（博客 ：一叶知秋 https://muyinchen.github.io）**
- ✅**上海-JAVA-涤生（公众号 ：涤生的博客）**
- ✅**广州-后端-张乘辉**
- ✅**北京-后端-望重**
- ✅**北京-后端-张帆 （博客 ：Since1986 https://since1986.github.io）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**长沙-后端-陈同学（博客 ：码代码的陈同学 https://chenyongjun.vip/）**
- ✅**上海-后端-sion**
- ✅**福州-Java-王波**
- ✅**上海-后端-宝宝**
- ✅**花程阳**
- ✅**广州-后端-CJ**
- ✅**杭州-java-阿涛啊**
- ✅**北京－Java－Mr.Xi**
- ✅**上海-java-小石头**
- ✅**深圳-Java-年年**
- ✅**广州-后台-hone**
- ✅**杭州-java-菜鸟**
- ✅**广州-java-森明**
- ✅**北京-打杂-火柴**
- ✅**深圳-后端-忍者**
- ✅**杭州-java开发-forever**
- ✅**深圳-Java-eumji**
- ✅**广州-JAVA-蝴蝶落于指尖**
- ✅**西安-后端-刘欢**
- ✅**上海-Java-carl**
- ✅**珠海-java-yellowb**
- ✅**北京-java-西希家**
- ✅**北京-Java-小信**
- ✅**南京-java-黄勇发**
- ✅**上海-Java-老三**
- ✅**厦门-java-张3**
- ✅**北京-研发-鲍尔**
- ✅**杭州-后端-ZMM**
- ✅**杭州-java半年-浪里个浪**
- ✅**广州_java_wen头**
- ✅**南京-JAVA-曹炜**
- ✅**厦门-java-無式**
- ✅**广州-后端-anker**
- ✅**广州-后端java-阿涩**
- ✅**西安-java-心程**
- ✅**北京-后端-hxy**
- ✅**南京-java-戴强**
- ✅**深圳-Java-深秋**
- ✅**石家庄-Java-高俭**
- ✅**武汉-java-千年**
- ✅**北京-后端-青松**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## 周报 No.69（2019年）

### 1.  类没有被加载，能访问对应的Annotation信息吗？ 

> 后端圈①
>
> Java  [2019-05-20] 



**[北京-后端-Better]**  类没有被加载，能访问对应的Annotation信息吗？



➤ 问题解答



**[杭州-后端-小马哥]**  可以的，自我推荐我的书籍[《](https://item.jd.com/12570242.html)[Spring Boot编程思想（核心篇）](https://item.jd.com/12570242.html)[》](https://item.jd.com/12570242.html)有写到，它是通过 ASM 读取字节码来操作的



### 2.  支持任意时延的延迟队列，我们现在准备自己用多级时间轮leveldb，开源版本的rocketmq 在实现，不知道有没有什么更好的思路，除了用 redis zset 和 rabbitmq 以外。 

> 后端圈①
>
> MQ  [2019-05-21] 



**[广州-Java-挖坑的张师傅]**  支持任意时延的延迟队列我们现在准备自己用多级时间轮leveldb，开源版本的rocketmq 在实现，不知道有没有什么更好的思路，除了用 redis zset 和 rabbitmq 以外。用来做订单失效、支付网关回调业务接口等场景



➤ 问题解答



**[杭州-后端-梁桂钊]**  多级时间轮，应用蛮广的，目前应该算比较好的方案。哈哈，同求，大家还有没有其他好的思路。

**[北京-后端-程超]**  时间轮到是一个通用方案，但是需要将队列的任务能持久化恢复，其实可以考虑分布式调度的思路，我把时间轮的数据会持久到表中，当重启的时候会从表中重新加载时间轮的数据，但不用的是时间轮格子中的队列。我是放到表中的，利用时间轮来帮我做定时，利用数据表帮我做持久，但用时间轮也有复杂的情况，就是我的定时有很多种场景，我要定1秒的，要定1分钟的，要定1天的，要定一周的，这种场景，时间轮的算法就复杂的多了，那要分N级了。我做的可以持久化到多个版本，可以持久到redis，也可以放到es，也可以放到mysql，根据并发情况自己决定。还要做到分片和集群的场景，还有客户端多通道的场景，可以有广播，first，random等。这个自己造轮子的话不容易，需要考虑的多些。

**[上海-Java-知秋]**  自己不要轻易造中间件轮子。你会发现后期维护全是大坑，如果紧紧是为了自己的业务，实在需要写，那么，功能越简单越好。摒弃花哨

**[北京-后端-程超]**  嗯 ，根据自己的需要考虑吧，我是想做个通用的。这里我有一个定时任务，布到了五个实例中，到底要通知哪一个，这个就是客户端多通道的问题，是说每次只通知那一台服务器，还是轮询，或者随机，但每次只通知一台的话，一旦这台服务器重启或者宕机，就会出现问题。所以就有一个路由策略和一个失败重试策略



### 3.  请教下Spring大神：(环境：Spring boot 2.0 , spring framework 5.0.12)我这边自定义HttpMessageConverter不生效，初步排查是由于：先初始化RequestMappingHandlerAdapter完毕，才装载自定义的HttpMessageConverter 所导致自定义的未加载到RequestMappingHandlerAdapter中。如何解决自定义不生效情况 

> 后端圈①
>
> Spring  [2019-05-21] 



**[广州-后端－柴码]**  请教下Spring大神：(环境：Spring boot 2.0 , spring framework 5.0.12)我这边自定义HttpMessageConverter不生效，初步排查是由于：先初始化RequestMappingHandlerAdapter完毕，才装载自定义的HttpMessageConverter 所导致自定义的未加载到RequestMappingHandlerAdapter中。如何解决自定义不生效情况



➤ 问题解答



**[深圳-Java-eumji]**  实现WebMvcConfigurer，重写extendMessageConverters方法，加进去就可以了



### 4.  请问，为什么 HashMap 扩容之后，hashtable 是原来的两倍，而不是1.5倍呢？跟计算 hash 值有什么直接原因吗？这个是 hash 函数 

> 后端圈①
>
> Java [2019-05-22] 



**[深圳-后端-lyning]**  请问，为什么 HashMap 扩容之后，hashtable 是原来的两倍，而不是1.5倍呢？跟计算 hash 值有什么直接原因吗？这个是 hash 函数



➤ 问题解答



**[深圳-后端-lyning]**  还是为了刚好可以扩容到 2^31 - 1，避免出现内存溢出？

**[深圳-JAVA-Null]**  要保证数组的大小是2的次方，所以不能是1.5倍

**[深圳-后端-lyning]**  为什么要保证是2的次方呢？

**[江苏-java-匠心零度]**  本质map扩容一次代价要大些

**[深圳-JAVA-Null]**  方便找到对应的索引啊，而且也会让Entry分布得更均匀。如果不是2的次方，hash又是随机分布得话，就会造成某些索引位置的链表很长，查找性能受到影响

**[上海-Java-知秋]**  2的n次方CPU计算起来最快

**[福州-Java-王波]**  取下标的方式，根据位运算来的，2的次幂减去1 刚好二进制表示全部都是1，做与运算，结果完全取决于key的哈希值

**[北京-后端-每天晒白牙]**  [https://blog.csdn.net/dam454450872/article/details/80376661](https://www.yuque.com/server_mind/answer/question69)

**[闵豪]**  方便resize



### 5.  hystrixCommand 执行同步方法时 感觉就是类似 CompletableFuture.supplyAsync(()->{}).get()，这样创建一个future 然后立马阻塞获取的意义何在啊，个人理解这样还会涉及到线程切换 

> 后端圈②
>
> 框架  [2019-05-23] 



**[北京-后端-安然]**  hystrixCommand 执行同步方法时 感觉就是类似 CompletableFuture.supplyAsync(()->{}).get()，这样创建一个future 然后立马阻塞获取的意义何在啊，个人理解这样还会涉及到线程切换



➤ 问题解答



**[长沙-后端-陈同学]**  在hystrix线程池隔离下，可以隔离流量，例如A服务响应速度很慢，在不隔离情况下访问A，当前应用线程很快就消耗殆尽，然后无法响应任何请求。但隔离后，对A服务的访问都交给了专门的线程组(可以设置最大线程数)来处理，可以使用熔断、降级等策略，不会拖垮当前应用(例如网关)

**[北京-后端-安然]**  嗯，明白了，是为了搭配使用hystrix的线程池隔离所以才这么写，如果不考虑这种情况，这样写是不是就很诡异了

**[长沙-后端-陈同学]**  hystrix的信号量模式和你说的类似，两种不同的隔离策略



### 6.  能问问大佬 如何提高设计思想这方面的东西吗 

> 后端圈④
>
> 设计  [2019-05-20] 



**[上海-java-小石头]**  能问问大佬 如何提高设计思想这方面的东西吗，在思想这一块 感觉好捉急 不是在填坑就是在埋坑的路上



➤ 问题解答



**[福建-后端-望重]**  这个没有捷径，只有把该看的书都看了，在项目中积累经验呗，而且所谓设计思想，在现实工作中很难直观的说明一个人设计水平高，填多了也有心得了。

另外碰到坑可以多查查资料，看看其他人是怎么解决的，其实就是多看看其他的思路，太阳底下没新鲜事，看多了，你会发现，其实大牛的思路总体是差不多的，就是所谓的最佳实践。



### 7.  话说我更想知道大家是怎么学前端的

> 后端圈④
>
> MyBatis  [2019-05-21] 



**[福建-后端-望重]**  话说我更想知道大家是怎么学前端的[呲牙]



➤ 问题解答



**[上海-Java-知秋]**  你直接刷前端视频就好，书都是落后的，更注重系统学习和实操，这些很多书根本就做不到，我自己带前端就是给他们视频，然后大量练习，扒不错的项目代码

**[福建-后端-望重]**  其实看书效率会高一些，不过前端和后端不太一样的地方是，前端视频也好，看书也好，经常是告诉你这样做就好了，按着写也能写出来，但是为啥这么写很多时候莫名其妙。 jsp时代或者还在使用jquery时候，我们是搞的明白的 。用amd cmd之后我就开始搞不懂了



### 8.  问一下大家 如果使用dubbo + Jpa 如果是自动生成表的情况 这个 domain如何共享出来

> 后端圈④
>
> Dubbo [2019-05-22] 



**[上海-java-小石头]**  问一下大家 如果使用dubbo + Jpa 如果是自动生成表的情况 这个 domain如何共享出来



➤ 问题解答



**[福建-后端-望重]**  我的理解就是把这个pojo分发出去，当然另外再封装下细节再分发更好？处于安全性考虑，rpc嘛，目的是为了远程调用和本地调用感觉是没区别存在的，所以你按照本地调用理解就行了，本地调用时候该这么做，rpc其实也差不多

**[北京-java-犀利豆]**  我理解最好封装一层再向外提供，否则你的表结构和下游绑定了。发生表结构变化的时候需要调用方一起调整。



### 9.  为什么要用rpc呢？ 

> 后端圈④
>
> RPC  [2019-05-22] 



**[上海_java_小星]**  为什么要用rpc呢？我在项目中用http，他们之间比较，有啥优势？



➤ 问题解答



**[济南~java~modificial]**  Rpc效率高于HTTP，并且Rpc基于tcp/ip

**[福建-后端-望重]**  不是同一类，不过我觉得把，使用这些目的差不多。。另外rpc外网调用有问题的，考虑公网调用当然就http简单了

**[深圳-后端-lin]**  rpc不是可以通过多种协议实现吗，异构系统要调，最好还是http接口吧

**[福建-后端-望重]**  是，扔个json报文给对方，省事多了

**[福建-王波-Java]**  rpc只是一个概念，具体实现方式很多啊，http方式也可以当做是rpc的一种实现，spring cloud的rpc方案不就是http的？

**[深圳-后端-lin]**  协议层面的性能差异基本可以忽略的

**[福建-后端-望重]**  嗯，对于普通系统来说可以忽略这个问题

**[福建-王波-Java]**  反正不是什么顶级性能要求的业务场景，http简单又使用方便。

**[上海-Java-知秋]**  @福建-王波-Java 一个明白人，rpc只是一个概念，可是很多人非要将这个概念定式

**[杭州-java-健]**  别人面试问我 rpc是啥。 我说是个架构风格，项目分为 consumer api provider , 消费端调用 服务端提供的api，可以实现像调用本地方法的效果，底层支持的协议可以使 rmi dubbo http 等。 但是感觉他们都认为rpc是个协议



### 10.  一个netty框架设备连接多了，就容易出现设备断网断连状态，这个怎么处理呢？（200台），Linux句柄已配置好了 

> 后端圈⑤
>
> Netty [2019-05-22] 



**[北京-Java-小磊]**  一个netty框架设备连接多了，就容易出现设备断网断连状态，这个怎么处理呢？（200台），Linux句柄已配置好了



➤ 问题解答



**[上海-Java-知秋]**  如何创建的连接，有没有复用，有没有做好释放，是因为gc问题还是什么，有没有日志。设备间因为gc时间过长，同样会出现所谓的断连。你最好看下gc日志，因为我之前有给一家企业解决过类似问题，就是我讲到的gc时间过长



### 11.  mysql的批量插入，如果使用insert ignore into，怎样才能知道哪些数据被ignore了？ 

> 后端圈④
>
> MySQL  [2019-05-23] 



**[北京-java-z]**  mysql的批量插入，如果使用insert ignore into，怎样才能知道哪些数据被ignore了？



➤ 问题解答



**[兰小伟-《TypeScript实战》]**  查询show warning可知，show warnings语句实际查询的是mysql的错误日志，mysql的错误日志本质是一个csv文件，对应于mysql的CSV存储引擎，你的数据存在于错误日志表中message字段中，你需要自己处理字符串即可提取出你想要的数据，这并不难做到。

你insert ignore之后并不是不报错，只是报错信息改为写入错误日志CSV文件中，看起来对用户更友好，但CSV文件数据没有任何压缩，所以高并发场景下错误日志文件体积会迅速膨胀，浪费硬盘空间，要定时归档清理，所以慎用。



### 12.  mysql中where条件只有二级索引 是update语句 加锁得话 是先加二级索引再加一级索引得吧？ 

> 后端圈⑤
>
> MySQL  [2019-05-23] 



**[南京_java_戴强]**  mysql中where条件只有二级索引 是update语句 加锁得话 是先加二级索引再加一级索引得吧？



➤ 问题解答



**[广州-java-阿涩]**  如果用到了非主键索引，msyql会先锁定非主键索引，再锁定主键索引。 如果两条sql执行间隔时间非常短的话，会出现资源争夺的情况，可能死锁， 做update的话，（并发量高的情况？）先把update的数据先条件查询出来，再做主键id的更新



### 13.  maven依赖报错怎么解决？

> 后端圈⑤
>
> Maven  [2019-05-23] 



**[北京-Java-小强]**  maven依赖报错怎么解决？排除后，我在启动项目时报错 redisTemplate不能用

![image.png](后端圈问答全集.assets/1558886673094-689c6c83-8436-441a-8831-612fe2121ffa.png)



➤ 问题解答



**[上海-基础架构-luiz]**  本地仓库删除掉这个依赖 重新刷一下，mvn dependency:tree -Dverbose -Dincludes=asm:asm，Maven类包冲突终极三大解决技巧 [mvn dependency:tree](https://blog.csdn.net/sun_wangdong/article/details/51852113)

**[武汉-后端-危大可]**  用Maven Helper 这个idea插件, 最简单，还可以右键直接排, 都不用写exclude代码



### 14.  有没有人遇到过这种情况， 通过jmap观察堆几乎没怎么使用， 但是top命令看到java进程占用了12%内存，总内存64G。 java进程启动的时候没有配置最大最小堆内存。 

> 后端圈⑤
>
> Java  [2019-05-22] 



**[西安-java-行政]**  有没有人遇到过这种情况， 通过jmap观察堆几乎没怎么使用， 但是top命令看到java进程占用了12%内存，总内存64G。 java进程启动的时候没有配置最大最小堆内存。



➤ 问题解答



**[上海-大数据java-木公]**  看下有没有输出日志文件，Tomcat输出日志文件会占用内存不释放，你看有没有这种情况

**[上海-JAVA开发]**  是不是用了nio大量网络读写产生大量堆外内存。这个用jmap看不出来的



### 15.  假设我用版本号对比单条数据，但是如果钉钉这下新增修改了比较多的数据，那我本地的数据库应该如何和钉钉的同步呢，把钉钉的数据全部覆盖掉我的数据库？这个好像不好吧 

> 后端圈⑤
>
> 解决方案  [2019-05-22] 



**[广州-java-阿涩]**  假设我用版本号对比单条数据，但是如果钉钉这下新增修改了比较多的数据，那我本地的数据库应该如何和钉钉的同步呢，把钉钉的数据全部覆盖掉我的数据库？这个好像不好吧



➤ 问题解答



**[北京-Java-小磊]**  你这个要看业务需求

**[上海-Java-知秋]**  参加git设计

------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**北京-后端-程超（书籍：《可伸缩高可用微服务架构》）**
- ✅**上海-Java-知秋（书籍：《**Java编程方法论：响应式RxJava与代码设计实战**》）**
- ✅**杭州-后端-小马哥（书籍：《**Spring Boot编程思想（核心篇）**》）**
- ✅**兰小伟 (书籍：《TypeScript实战》)**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**杭州-后端-梁桂钊**
- ✅**北京-后端-张帆**
- ✅**长沙-后端-陈同学**
- ✅**南京-后端-祁晓波**
- ✅**江苏-java-匠心零度**
- ✅**北京-后端-Better**
- ✅**广州-Java-挖坑的张师傅**
- ✅**广州-后端－柴码**
- ✅**深圳-Java-eumji**
- ✅**深圳-后端-lyning**
- ✅**深圳-JAVA-Null**
- ✅**上海-java-小石头**
- ✅**福州-Java-王波**
- ✅**北京-后端-每天晒白牙**
- ✅**闵豪**
- ✅**北京-后端-安然**
- ✅**福建-后端-望重**
- ✅**上海java小星**
- ✅**济南javamodificial**
- ✅**深圳-后端-lin**
- ✅**福建-王波-Java**
- ✅**杭州-java-健**
- ✅**北京-java-z**
- ✅**北京-Java-小磊**
- ✅**北京-Java-小强**
- ✅**武汉-后端-危大可**
- ✅**上海-基础架构-luiz**
- ✅**广州-java-阿涩**
- ✅**南京java戴强**
- ✅**上海-大数据java-木公**
- ✅**西安-java-行政**
- ✅**上海-JAVA开发**

## 周报 No.70（2019年）

### 1. 单一职责原则

> 后端圈①  [2019-06-03] 



**[后端-宝宝]** mybatis是在什么时候去解析entity上标注的注解？我想自定义一个加密的注解，标注在password等敏感字段上，然后在mybatis上去做加密。例如：

```
@TableField(select = false, update = "%s")
private String password;
```



➤ 问题解答



**[上海-java-金河]** 可以自定义注解，然后写个拦截器去解析。

**[深圳-Java-xcb]** 也可以在spring mvc前置做。

**[深圳-JAVA-Null]** 没有必要耦合在mybatis这层做，加密属于业务层的。我是用Advisor拦截Mapper接口，匹配方法入参带有这个注解的Method，然后给这个字段加密，查询的时候，如果需要可以做解密

**[上海-Java-知秋]** 不要做超出自己职能的东西，其实你的代码很容易就能反映出你的管理水平。如果你喜欢在不合时宜的地方写不属于这块儿管理的东西，那就说明你这个人喜欢多管闲事，很是随意。



### 2. 常用的HttpClient

> 后端圈①  [2019-06-07] 



**[北京-JAVA-孙大圣]** HTTP 网络请求大家都是怎么处理的？目前项目代码有 HttpClient、HttpUrlConnection，想要统一化。HttpUrlConnection是JDK自带的，用它的话灵活度应该是最高的，但是需要写很多代码。

 OkHttp、HttpClient版本升级经常不兼容，但是屏蔽掉了很多内部实现细节。



➤ 问题解答



**[北京-java-犀利豆]** RestTemplate，RestTemplate是基于HttpClient的封装。

**[杭州-后端-小聂]** Feign是解决http服务调用，任何使用httpClient 和OKhttp的地方，均可以替换为feign 。

**[杭州-后端-梁桂钊]** vert.x也很不错，可以实现异步。

附：关于响应式的交流。

**[上海-后端-sion]** 提到vertx 那么大家怎么看vertx 和 project reactor，spring默认reactor ，那vertx 会流行起来吗？

**[杭州-后端-梁桂钊]** vertx+rxjava，我觉得也会流行。事实上，我觉得不冲突，verxt定位是工具集，不是框架，我们可以利用它做一些能力扩展。

**[上海-Java-知秋]** RxJava2之后我推荐2.2以后的，这之前有些地方的小bug也比较明显，我与开发者沟通过，对方并没有改，只是改了代码注释。

不过我更建议Reactor3 各种新增的功能特性，它的拓展库里也有很多新奇的工具，reactor-core将很难的东西都移到扩展库里了。

主要还是看jdk版本，jdk8之后，推荐reactor，里面的很多代码比较简洁，拓展库也多，而且结合Spring可以有更多的收益，看个人选择吧，Spring基础库反正也已经支持Rxjava2了，以后也不需要单独引Rxjava和Reactor的包了。



### 3. JDK源码方法命名中0的含义

> 后端圈②  [2019-06-06] 



**[北京-后端-long]** 我看jdk源码里面有不少方法后面带个0，这是出于什么目的呢？例如：

```
private static synchronized void setSecurityManager0() {}
```



➤ 问题解答



**[上海-Java-知秋]** 其实我觉得这东西+个0你更能知道它是什么意思，这个0更代表是核心逻辑，是需要我们注意的地方。因为synchronized 代码块的原因，实在是没办法抽取出一个同用方法，否则，就好产生多个操作因为同一个封装而造成阻塞，但还想做特殊抽取，就使用了xxx0来做这个特殊操作。

![image.png](后端圈问答全集.assets/1560088000122-75258b8c-2487-453c-88e8-13a9970c80d5.png)

比如这个addFirst，我们更关心的是它的核心添加逻辑。



### 4. 架构图的层次

> 后端圈④  [2019-06-04] 



**[广州-后端-张乘辉]** 分享支付平台架构设计的一些思考，[原文链接](https://mp.weixin.qq.com/s?__biz=MzU3MjQ1ODcwNQ==&mid=2247483952&idx=1&sn=4f9bab36798bbcbc7839e898097563f1)

![image.png](后端圈问答全集.assets/1560088538627-a5038ef9-cba7-429f-bad1-1fb3f2be3d6d.png)



➤ 问题解答



**[程超]** 这个图可以再美化下，前面是类、中间是模块，后面就是服务了。

支付平台架构图需要层次，这个图看似流程画出来了，但缺乏分层，比如支付前端，交易，核心，路由渠道，对账，分润，分账，结算。

还有聚合支付属于哪个分层、收银台在哪里，第三方支付不仅有退款，支付，鉴权，差错，冲正，代付代发等。



### 5. 接口排序参数设计

> 后端圈④  [2019-06-05] 



**[杭州-java-健]** 大家平时设计接口时候，遇到某些字段需要传到后台升序降序的，怎样设计这个请求实体呢



➤ 问题解答



**[福建-后端-望重]** 扔json结构里，例如：

```
{ "sort": [ {"field1":"asc"}, {"field2":"desc"}] }
```

接口上是这么设计，至于后台如何识别是后台的问题，后台需要考虑，前端传递给后端的数据是否足够能识别根据那个表的哪个字段排序。

一般来说，我们提供给前端的数据会按照主要业务逻辑来排序，比如日期倒序等等。

**[杭州-后端-梁桂钊]** 我个人觉得唷，接口设计的灵活是必须的。但是，绝大多数自定义排序是伪需求，这个能卡需求就卡需求，让产品先把业务需求说清楚了，毕竟不合理的排序也是影响性能的。



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅北京-后端-程超（书籍：《可伸缩高可用微服务架构》）
- ✅上海-Java-知秋（书籍：《Java编程方法论：响应式RxJava与代码设计实战》）
- ✅北京-java-犀利豆（公众号 ：犀利豆的技术空间）
- ✅后端-宝宝
- ✅上海-java-金河
- ✅深圳-Java-xcb
- ✅深圳-JAVA-Null
- ✅北京-JAVA-孙大圣
- ✅杭州-后端-小聂
- ✅上海-后端-sion
- ✅北京-后端-long
- ✅广州-后端-张乘辉
- ✅杭州-java-健
- ✅福建-后端-望重
- ✅杭州-后端-梁桂钊（公众号 ：服务端思维）

## **周报 No.71（2019年）**

### 1.  关于Rx的落地

> 后端圈①  [2019-06-11] 



**[北京-java-犀利豆]** 知秋大佬，最近研究了一下 [vertx](https://vertx.io/)，发现基于 rxjava 似乎没有一个一个很好的 orm 框架。开发效率不高。如果在 vertx 里面用上 hibernate，好像性能优势不大。不知道我理解的对不对。我的理解是：现在 api 接口是阻塞的，jdbc 也是阻塞的，主流数据库也是阻塞的。要把rxjava 用起来，场景有限。



➤ 问题解答



**[上海-java-知秋]** 

- 有 orm 框架的，就是都不开源，17年底我有参与过一个，本来打算去年自己也撸一个开源版的，想想还是算了，自己辛辛苦苦一年，可能也没什么人用，还不如推广知识了。
- 其实 rxjava 不是特别适合后端开发的，以前没有接触 spring reactor 倒还没觉得有什么，在接触之后，顿时觉得 reactor 太良心，提供了大量新特性。代码设计也更加简洁，细节处理上更加完善，而不是和 rxjava 一样，提的问题更多在注释上提醒大家注意。使用rx(此处指反应式，并非指rxjava)进行编程，就意味着我们要抛弃ThreadLocal的玩法，Rxjava并没有提供一个很好的解决方案，但[Spring Reactor](https://projectreactor.io/)给出了，并基于此方案演化出了现在的Spring 的响应式事务处理。
- rx(此处指反应式，并非指rxjava)国外用的很成熟的就数netflix了，一套完整的解决方案。当下reactor-netty真的是做了极大的努力，对架构设计做了极大的调整，新版本下的 [reactor-netty](https://github.com/reactor/reactor-netty) 已经做到了性能的大幅优化，rx在使用上的落地请参考我6.6的分享**「**[Java编程方法论 Reactor解读补充](https://www.bilibili.com/video/av53280864/?p=7)**」(**2019-06-06 我的一些项目开发感悟以及如何将响应式与函数式落地到我们的开发中**)**



### 2.  为什么Tomcat要用同步的nio

> 后端圈④  [2019-06-11] 



**[To0R]** 为什么Tomcat要用同步的nio？



➤ 问题解答



**[上海-java-知秋]** 可参考我的文章**「**[tomcat从启动到接轨Servlet二三事](https://juejin.im/post/5c244cf4e51d457454699505#heading-16)**」**



### 3.  关于源码阅读

> 后端圈⑤  [2019-06-11] 



**[大二-剑主]** hashmap是不是分析增删改查就好了，平常工作也就用到这些？2千行源码看得我是心累。

**[北京-Java-小强]** 想要读懂源码，应该怎么搞？



➤ 问题解答



**[大二-剑主]** **@北京-Java-小强** 我会分三步走，首先了解这个类所涉及的相关知识，先了解这些知识，然后就对这个类做个大概的了解，了解所需要学习的方面，包括面试问到的知识点，最后在做细一步的分析，然后就可以阅读分析源码了

![image.png](后端圈问答全集.assets/1560691022302-4a8c85ca-9041-49c9-937d-363de2003c62.png)

以hashmap为例：

![image.png](后端圈问答全集.assets/1560691054177-198bc794-a7d7-4721-90ef-de87eed07fc8.png)

![image.png](后端圈问答全集.assets/1560691125751-e9f39680-cceb-4363-a32b-f499abdd8615.png)

![image.png](后端圈问答全集.assets/1560691186927-c5c1c6d9-5647-4e2a-a327-2bae722e63da.png)

分析完这三步，下一步才开始分析源码去了。

**[上海-java-知秋]** 你有没有想过为什么要设计这个类呢。我自己撸源码从来不为面试为出发点，而以生活为出发点，以需求为出发点，和写文章首先要确定中心思想，然后大纲走起，确立上下文关系，然后丰富血肉是一个道理

**[大二-剑主]** **@上海-java-知秋 👍**阅读源码能学习算法思想，设计模式等。我有个毛病，没行代码都要填上注释，除非是非常简单的

![image.png](后端圈问答全集.assets/1560691402486-8cc29b65-5bdc-416c-99b7-c8f96e37769c.png)

**[上海-java-知秋]** 

- **@大二-剑主** 这个就很有问题了，我读源码更多是把握脉络，抓主线，以自己的思维去抓作者的思路，注释很少，因为英文类名字和方法名字已经表达的很清楚了，不需要我来做这些事情。

![image.png](后端圈问答全集.assets/1560691475793-0976b190-deba-4e9d-8d68-5cd77e3c20f5.png)

- 我带了好多大学生了，很多接触的时候都是为了读源码而读源码，纯粹为了应付面试，而不是从里面吸收思想。以一个过来人的经验，读源码这个事情确实是需要一直坚持下去的，慢慢就会发现，你是在玩源码，接近作者的思想，更多是一种思想的交流。就好比我下图这里的一个小细节，对于`outboundHttpMessage()`是不是要派生实现，其实就是基于netty两端对于消息的认定不同：

![image.png](后端圈问答全集.assets/1560691817071-a31d825c-d94e-4531-a68c-8ab5ed1115af.png)



![image.png](后端圈问答全集.assets/1560691868507-d55436e5-0f49-44e1-b2af-924ffdccd8fe.png)

当你对于netty真的玩的很6的时候，自然就想到这些而不需要刻意去思考它为什么要这么做，包括我上面源码截图里的那一句注释，其实就是在强调做事要前后照应

![image.png](后端圈问答全集.assets/1560691927035-a0015a0d-98f1-47d0-b7ea-063e39dd9364.png)

从接口层就设定了Mono.empty()，那么它在做与之相关的都应该基于这个方式进行 

![image.png](后端圈问答全集.assets/1560691961544-2ae5b8c8-3590-47b0-b35f-95d7e0465440.png)

- 我的源码解读分享系列：**「**[知秋源码解读分享系列](https://juejin.im/post/5cbedf2b5188250a5224677c)**」**



### 4.  关于技术栈迁移

> 后端圈①  [2019-06-13] 



**[北京-java-张颖康-马蜂窝]** 

**分享了一篇文章「**[马蜂窝大交通业务质量体系建设初步实践](https://mp.weixin.qq.com/s/Enr2It-3jCToej71TcdUQQ)**」**

**我们进行了技术栈迁移，**之前是php的，去年开始进行java的尝试 现在已经有一定规模。



➤ 相关讨论



**[上海-java-知秋]** 转起来很快，表基本不需要动，可以上微服务架构了

**[杭州-后端-梁桂钊]** **@上海-java-知秋** 其实不那么简单，这种技术栈重构成本还是非常非常高的

**[北京-java-张颖康-马蜂窝]** **@杭州-后端-梁桂钊**是的 交通业务还是很复杂的，表设计、状态机、交易消息解耦、搜索聚合，都要做微服务。迁移过程中业务一致性保证，还是费了一番功夫的。

**[北京-java-犀利豆] “**迁移过程中业务一致性保证，还是费了一番功夫的”相当费劲 **@北京-java-张颖康-马蜂窝**

**[上海-java-知秋]** 你转JAVA，说明业务量确实到瓶颈，业务复杂程度需要你做些改变了，但是也是要抽的，釜底抽薪也不行，只能慢慢弱化主线，使用新线来替代，微服务架构完全可以进行一个过渡

**[北京-java-犀利豆]** **@上海-java-知秋** 老业务都乱麻了，这个服务难拆

**[北京-java-张颖康-马蜂窝]** **@北京-java-犀利豆** 是的，是一个慢慢抽的过程

**[上海-java-知秋]** 这其实比在老项目上面开发相对简单了，老代码已经不行了

**[北京-java-张颖康-马蜂窝]** 搜索类服务还好些，基本可以重写。交易场景的服务，由于设计数据完整性和业务完整性的问题，需要结合业务本身的特性和原有系统的架构一点点地进行剥离，改造老代码还有新代码。同时一些老的功能也可以抹掉，新的业务功能也可以考虑着加进去。兼顾着业务本身的发展需要

**[上海-java-知秋]** 么办法，慢慢来了，阵痛的过程肯定的，但收获也是很多的

**[北京-java-犀利豆]** 最麻烦的是业务不能停，边迭代边重构

**[北京-java-张颖康-马蜂窝]** 是的，还有很多业务线要改，注定是个大工程。业务不能停，很多时候这是老板允许重构的大前提。这是一个重要约束

**[北京-java-犀利豆]** 还有一个比较蛋疼的是，团队之间节奏不一致。不合理的接口，没法改变。明知不合理，还是要实现

**[北京-java-张颖康-马蜂窝]** 是啊 如果再需要其它团队配合，那就更头疼了

**[上海-java-知秋]** 基础微服务以表为基础进行设计，微服务内可以紧耦合，不要一直强调松耦合



### 5.  关于夏令时

> 后端圈④  [2019-06-13] 



**[厦门-Java-蓝梦]** 请教个问题，mysql数据库有个date类型字段，发现一个诡异情况：例如有个值是1988-08-16， 通过 binlog 转出来的时间戳是 587660400000，这个时间戳通过 Java（东八区）转出来后少了一个小时，初步判断数据库可能是东九区的，但是不是所有行都存在这个问题，这个是什么原因导致的呢？



➤ 问题解答



**[北京-java-犀利豆]** 差一个小时，是不是可能是夏冬令时

**[北京-后端-可乐]** 夏令时比冬令时（标准时）快一个小时。

**[南京-后端-祁晓波]** 

我记得国内实行过夏令时92年之后停掉的。之前碰到js和java转出来时间有差距

> 1986年4月，中国中央有关部门发出“在全国范围内实行夏时制的通知”，具体作法是：每年从四月中旬第一个星期日的凌晨2时整（北京时间），将时钟拨快一小时，即将表针由2时拨至3时，夏令时开始；到九月中旬第一个星期日的凌晨2时整（北京夏令时），再将时钟拨回一小时，即将表针由2时拨至1时，夏令时结束。从1986年到1991年的六个年度，除1986年因是实行夏时制的第一年，从5月4日开始到9月14日结束外，其它年份均按规定的时段施行。在夏令时开始和结束前几天，新闻媒体均刊登有关部门的通告。1992年起，夏令时暂停实行。

**[北京-java-犀利豆]** @南京-后端-祁晓波 是中国没有了。但是比如mysql 的默认时间cst就是有冬夏零时的。我的意思只是提供一个思路，主要是只差一个小时就很有可能是冬夏令时的问题

**[南京-后端-祁晓波]** @北京-java-犀利豆 赞，我之前碰到过js和java时差的，也是86年到92年的一个时间

**[厦门-Java-蓝梦]** @南京-后端-祁晓波 是的，确实是时令问题。

**[北京-java-犀利豆] 可参考「**[一次 JDBC 与 MySQL 因 “CST” 时区协商误解导致时间差了 14 或 13 小时的排错经历](https://juejin.im/post/5902e087da2f60005df05c3d)**」**



### 6.  Dubbo找不到接口

> 后端圈④  [2019-06-13] 



**[北京-java-西希家]** 问个问题，我的接口已经注册到zookeeper上了，为啥调用的时候说找不到。这是完整的错误：



```
java.lang.IllegalStateException: Failed to check the status of the service com.tynet.api.PlatToHisApiInterface. No provider available for the service client_11454545/com.tynet.api.PlatToHisApiInterface:1.0 from the url zookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?application=jyjc_provider&dubbo=2.5.3&group=client_11454545&interface=com.tynet.api.PlatToHisApiInterface&methods=bizExec&organization=hztywl&owner=yup&pid=1956&revision=1.0.0-SNAPSHOT&side=consumer&timeout=10000&timestamp=1560426601714&version=1.0 to the consumer 192.168.227.1 use dubbo version 2.5.3
```



➤ 问题解答



**[南京-后端-祁晓波]** 看看你的注册中心有没有设置group，zk如果设置了 group也要一样设置，因为注册中心的group影响查找的路径，都不设置没问题 不要一边设置一边没设置就行



### 7.  关于Redis事务

> 后端圈④  [2019-06-14] 



**[福州-后端-叶平平]** Redis 事务和关系数据库事务相结合 和预想的不太一样。方法有开启事物 redis会空指针，没有开启事物的方法 可以正常。是否有人碰到类似的，有解决方案吗？ 



➤ 问题解答



**[深圳-Java-阿飞]** 为什么要用redis事务？redis事务又不能回滚~

**[北京-打杂-火柴]** @福州-后端-叶平平 空指针异常，是redisTemplate吗？我觉得，redis事务只是个无语法错误才能有序运行的队列吧，配合上 [watch](https://www.jianshu.com/p/361cb9cd13d5) 也勉强算是事务。只要数据库没有 [redo log 和 undo log](http://www.importnew.com/28039.html) 都无法称为真正的原子。



------

**非常感谢「后端圈」小伙伴们的高质量技术交流。如果对您有帮助的话，可以帮忙转发与分享。同时，欢迎加入「后端圈」共同探讨，让所有孤军奋战的研发人员都找到属于自己的圈子，一起交流、探讨。在这里，我们可以认知升级，连接顶级的技术大牛，连接优秀的思维方式，连接解决问题的最短路径，连接一切优秀的方法，打破认知的局限，探索业务与技术交融下产生的无限可能。。**（PS ：如果参与分享的小伙伴，有相关博客、公众号、书籍，欢迎私信我添加和补充~）



- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**上海-Java-知秋（书籍：《Java编程方法论：响应式RxJava与代码设计实战》）**
- ✅**To0R**
- ✅**大二-剑主**
- ✅**北京-Java-小强**
- ✅**北京-java-张颖康-马蜂窝**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**
- ✅**厦门-Java-蓝梦**
- ✅**北京-后端-可乐**
- ✅**南京-后端-祁晓波**
- ✅**北京-java-西希家**
- ✅**福州-后端-叶平平**
- ✅**深圳-Java-阿飞（公众号 ：阿飞的博客）**
- ✅**北京-打杂-火柴**

## 周报 No.72（2019年）

### 1.  redis应用



**[武汉-java-前年]** 请问各位大佬们 假设在并发量大的情况下我要统计一个网站中所有文章的点击量，并且做排行和分页，我直接使用redis 的有序set存一个set集合 将文章信息id作为member 然后将文章点击量作为score 然后每次文章被点击时使用zsetincreby方法自增这样的形式好吗



➤ 问题解答



**[上海-开发-张南南]** hyperloglog了解一下

![image.png](后端圈问答全集.assets/1561947078514-3e611ca5-41ff-4866-a8e0-5ce6bec90ec3.png)



### 2.  大数据量设计方案



**[武汉-java-hopkins]** 我有一个需求  需要从10亿的照片数据中，获取指定的10个坐标信息，让你设计一个api，照片数据包括有拍摄坐标信息，和拍摄时间，拍摄人，设备号等。这个该如何设计啊？用什么



➤ 问题解答

**[无锡-java-何大葱]** 先从照片文件头信息里提取信息，然后存起来，然后做个查询接口,难点是怎么快速提取

**[武汉-java-hopkins]** 数据量这么大，直接查询 会不会挂 还有10亿数据怎么存储比较合理可以搞个程序提取照片的头信息然后只存储照片的头信息，不需要存所有的照片数据 

分解成三个问题

1快速提取头信息

2存储头信息

3查询

光保存坐标信息和文件名的映射的话存储就会少很多



### 3.  Spring Annotation



**[北京-java-aspen]** 大佬们，有人在项目中，使用过spring定义的全局异常处理吗？这个是给controller层使用的吧？还需要自己定义一个handler去处理吗？就是捕获异常以后，打印日志或者做其他的业务处理



➤ 问题解答

**[成都-后端-陈十一]**是给Controller用的,你写一个handler处理，处理类加上这个注解,controller抛出异常后就会到那个handler去了

![image.png](后端圈问答全集.assets/1561947440118-577cdb49-e842-421d-ae50-9af01e8f0b0e.png)

**[杭州-java-健]**先用 ControllerAdvice 标记是个 controller层的切面。   RestControllerAdvice 是说明这个切面所有方法返回值都是json。    切面里面你通过 ExceptionHandler 捕获不同异常就行，从子类捕获，假如你有   RuntimeException和 Throwable 会默认执行 runtimeException逻辑



### 4.  物联网



**[合肥-java-freeter]** 物联网需要一般研究什么 动环监控  服务器设备的温度 电压



➤ 问题解答

**[广州-java-wen头]**看你们业务咯 你们实际业务有哪些硬件设备 mqtt了解一下

**[上海-开发-老三]**你说的这些早就有了 现在的设备都具备温度 湿度 电压之类的 最具特色的 就是火车上的 连接处的监控 坐火车不知道你注意到没有

**[重庆-java-crossoverjie]**mqtt可以保证协议层的低耗稳定 应用层的扩展还是得要自己做



### 5.  Spring源代码



**[杭州-java-健]** 今天遇到了个问题，就是spring 注入的。启动的时候，服务一直启动不起来，貌似是循环依赖。  后来找了下代码里面有多个InitlizeBean，怀疑可能是在这里面有问题。  搜了下 ，网上说推荐 set方法注入，这样就可以避免这种问题的产生



➤ 问题解答

**[上海-java-神驱一梦]**

尽量避免用构造方法注入…… 构造方法是最容易产生依赖循环的 现在不是都习惯直接在field上注入么？用构造方法注入，对象正在实例化的发现自己需要另一个对象 然后去实例化B对象，结果B对象在构造时发现自己又需要A对象 A和B在构造的过程中互相依赖，最后就是两个都构造不出来  这个就成死依赖了 field和set我试过，普通情况下不会产生依赖循环的问题，我测试过的  2个bean到多个bean互相循环依赖都没事。因为它注入的时候对象已经构造好了，就不会出现构造方法注入同样的问题 我用springboot 2.0.1测试过

**[成都-找工作中-懒癌正患者]**

![img](../../../WINDOWS/system32)![image.png](后端圈问答全集.assets/1561947787318-2b72bb7d-ff02-48d6-8f98-09de3a19cb1c.png)

Spring 推荐使用构造方法注入 Idea 提示得很清楚

**[上海-后端-李威]**

你看spring的代码就知道了哇，field 的注入用空构造方法帮你搞定了，构造器注入如果循环依赖了就直接挂了

**[杭州-java-健]**我们也在 field上面注入的，  结果循环依赖。  那应该是spring版本太低吧。  我们才3.+

**[上海-java-神驱一梦]**field上面注入也有问题？我想起了spring 哪个版本加入了依赖循环的检查验证 哪个版本忘了，就是可以解决set和field的依赖循环问题

我记得我debug过源码，它好像会在容器初始化的时候，构造一张map，里面记录了bean之间的依赖关系

**[成都-找工作中-懒癌正患者]**https://www.vojtechruzicka.com/field-dependency-injection-considered-harmful/

![img](../../../WINDOWS/system32)![image.png](后端圈问答全集.assets/1561947906872-ca359ddf-0af8-46c4-8016-3fee02edf176.png)

**[上海-java-神驱一梦]**官方的考虑应该是直接在field上注入，侵入性太大了吧 

**[北京-java-犀利豆]**我记得 避免 field injection是为了避免 迁移 依赖注入框架造成的成本。 问题在于 我们基本不会不用spring的  lombok @Data  我的做法就是默默的关掉了 idea 的警告，继续用 field inject

**[北京-后端-张帆]**知乎上有这个的讨论 https://www.zhihu.com/question/52220502



- ✅杭州-java-健
- ✅北京-java-犀利豆
- ✅北京-后端-张帆
- ✅上海-java-神驱一梦
- ✅无锡-java-何大葱
- ✅上海-开发-张南南
- ✅武汉-java-hopkins
- ✅成都-后端-陈十一
- ✅广州-java-wen头
- ✅上海-开发-老三
- ✅重庆-java-crossoverjie
- ✅上海-后端-李威
- ✅成都-找工作中-懒癌正患者
- ✅武汉-java-前年
- ✅北京-java-aspen
- ✅合肥-java-freeter

## 周报 No.73（2019年）

### 1.  api接口安全性



**[**深圳-后端-lyning**]** 想使用一些 api 接口管理平台或框架，考虑接口的安全性，有什么推荐?



➤ 问题解答



**[**深圳-后端-忍者**]** 接口的安全可以借助网关。

**[杭州-后端-梁桂钊**] 鉴权需要自己做，网易的 NEI 可能比较适合你。https://github.com/NEYouFan/nei-toolkit



### 2.  Query 超过两个参数的查询禁止用Map来传输



**[**厦门-NLP&Java-AK48**]** 为啥 Query 超过两个参数的查询禁止用 Map 来传输？



➤ 问题解答



**[**北京-后端-Qzzz**]** Map 的 key 很容易写错，也没有编译检查。

**[杭州-后端-梁桂钊] 补充，作为 API 的设计者，这个对外接口的友好性特别差，对于调用方就是一个黑盒子。**



### 3.  Docker 的一个问题



**[**深圳-后端-lyning **]** 假设我要 copy 的 jar 在 /a/b/c 中，实际上 docker 去了 /dockerData/xxx/xxx/xxx 中去找了，加了相对路径也找不到，路径前面 + / 也是定位到 /dockerData/xxx/xxx/a/b/c 去找了，排查后确定 docker copy 的路径确实是不对的，就是不知道怎么解决



➤ 问题解答

**[**深圳-Java-Ryan**]** docker copy 根目录的是 context，就是最后的那个点,使用 copy --from=build 。



### 4.  rest doc 有什么值得推荐的地方



**[**深圳-Java-Ryan**]**  rest doc有什么值得推荐的地方吗。比swagger



➤ 问题解答

**[**深圳-后端-lyning**]** 定位不一样，spring rest doc 是测试驱动 API 文档，接口发布之前，必须通过API测试，测试通过了才会生成 API 文档，这样可以达成一种契约——接口格式是准确的，接口是通过测试的，可以放心使用；swagger 是配置什么就是什么，无法保障一部分接口契约，例如无法保证接口调用没问题。



### 5.  VO的序列化



**[**杭州-Java-hexsmith**]** 返回给前端的那种 VO 你们会实现 serializable 接口吗？



➤ 问题解答

**[**北京-补位-火柴**]** 需要用的时候，实现呗。JDK大部分的类，都已经实现了序列化接口。

**[**深圳-Java-深秋**]**实现序列化是有安全问题的，没必要就不用实现它。

**[**杭州-后端-咸鱼**]** 而且序列化的使用场景是需要反序列化吧，返回给前端也不需要反序列化成对象。

**[**北京-java-犀利豆**]**现在基本不 jdk 的序列化了,现在的工程里面，序列化基本都是会用 json、protobuf,又跨语言，又快。所以基本不太实用 jdk 的序列化了。

**[**太原-后端-郝先生**]** https://cloud.tencent.com/developer/news/240756

**[杭州-后端-梁桂钊] json 就是序列化的一种方式。**



### 6.  分布式事务



**[**北京-后端java-互联网**]** 分布式事务怎么解决（多个项目之间，不同库（IP不同）的数据一致性解决方案）



➤ 问题解答



**[**厦门-后端-罗号**]**最终一致性是王道

**[**杭州+开发+undefined**]** 蚂蚁有开源的！

**[杭州-后端-梁桂钊]** 消息队列发生消息后，可能消费者宕机而无法消费。绝大多数消息中间件对于这种情况，例如 RabbitMQ、RocketMQ 等引入了 ACK 机制。注意的是，默认的情况下，采用自动应答，这种方式中消息队列会发送消息后立即从消息队列中删除该消息。所以，为了确保消息的可靠投递，我们通过手动 ACK 方式，如果消费者因宕机等原因没有发送 ACK，消息队列会将消息重新发送，保证消息的可靠性。从业务服务处理完相关业务后通过手动 ACK 通知消息队列，消息队列才从消息队列中删除该持久化消息。那么，消息队列如果一直重试失败而无法投递，就会出现消息主动丢弃的情况，我们需要如何解决呢？主业务服务将要发送的消息持久化到本地数据库。从业务服务消费成功后，它也会向消息队列发送一个通知消息，此时它是一个消息的生产者。消费者接收到消息后，最终把本地的持久化消息标志状态为“完成”状态。说到这里，我们应该可以理解到使用“正反向消息机制”确保了消息队列可靠事件投递。当然，补偿机制也是必不可少的。定时任务会从数据库扫描在一定时间内未完成的消息并重新投递。



### 7.  HashMap 的源码实现



**[**北京-Java-Julian**]** jdk1.8 起 hashmap 中链表长度大于 8 时，为啥是红黑树，不是平衡二叉树,  64 是怎么起作用。不是超过 8 就变红黑树了？



➤ 问题解答



**[北京-java-犀利豆]** 红黑树 插入的时候，最多翻转两次,最差是 全部都要翻转,红黑树的增删改查的复杂度显然是O(logn)级别的，通常说红黑树是统计性能更优的树结构。为什么说统计性能更优呢？因为若是单纯的读操作，AVL树的性能比红黑树强一些，红黑树不是严格的平衡树，它是保持“黑平衡”的树。对于红黑树，最坏的情况，是树中最左侧的节点的左子树都是红色的节点，即对应2-3树中的“3节点”，所以这时红黑树的高度就是2logn（除了logn个黑色节点外，还有logn个红色节点），红黑树要比AVL树要高一些。所以从单纯的查询性能来说，红黑树的性能并没有AVL树强。对于插入删除操作来说，红黑树相比于AVL树减少了左旋转或右旋转的次数，所以红黑树的插入删除的性能比AVL树强一些。综合增删改查各方面的性能，红黑树的综合性能比较高。

**[杭州-后端-梁桂钊]** 减少写冲突的等待时间,如果桶数量小于 64，直接扩容而不用树化，扩容之后，链表会分化成两个链表，达到减少元素的作用。

[杭州-java-健] 我记得 hashmap 的时间复杂度，在链表情况下是n/2 红黑树情况下是log2n。 只有8的时候，性能大幅度增加，6的时候变化不大，如果转换还需要时间，不划算。其次就是链表长度超过6的概率是10万分之一，超过8的概率是千万分之一，8的话也不会频繁变树和恢复。 具体数值记不太清了，可以看下hashmap类上注解,而且不光长度8啊，还有个64; 数据结构式红黑树，是因为不管插入删除，通过左旋和右旋，至多不超过三次还是四次就可以实现平衡。 性能稳定。

**[上海-后端-知秋]** 还有一点，树的容量还是要和hashMap的容量做综合考虑的，所以要进行table容量的阈值设定,也是有hash策略的考虑的。



### 8. aop拦截问题



**[北京-JAVA-Waters]**什么原因导致的 jdk 代理的情况，使得 controller 注入失败呢？



➤ 问题解答



**[北京-java-犀利豆]** jdk的代理要实现接口,记得spring是自动选择的，有接口用jdk没有用cglib

![image.png](后端圈问答全集.assets/1562495606013-6d5c6284-d96f-4043-b1fd-fcaf43fb48f7.png)

![image.png](后端圈问答全集.assets/1562495624925-57689bda-1ce4-447f-9197-b74dad85f30a.png)

![image.png](后端圈问答全集.assets/1562495649541-5e5a58d8-f818-4312-b076-f0562fb92274.png)





### 9. 如何知道翻译中部分文字和原文的对应关系



**[**福州-java-龍**]**有没有办法知道翻译中部分文字和原文的对应关系？比如截图中，英文翻译哪些对应的是 西北干旱半干旱区 的翻译。

![image.png](后端圈问答全集.assets/1562495853373-8d9a84a0-b732-47c4-80a1-1cd77d440192.png)



➤ 问题解答



**[**上海-java-神驱一梦**]**翻译的过程就生成一个映射啊, A端对应翻译出来的A`段,非要用外部接口的话，我想到可以自己做个词法分析器拆词，然后将拆散的词组一个个传过去单独翻译，最后将整体翻译结果和词组的翻译结果对照。



### 10. 前后端分离把用户存哪去呀，怎么判断登陆不登陆



**[**济南—后端—释怀**]**前后端分离把用户存哪去呀，怎么判断登陆不登陆呀。前台纯静态的页面, jwt 如何续约？



➤ 问题解答



**[杭州-后端-梁桂钊]**用户中心，然后，通过 token, 如果用现有的框架，你看下 spring security oauth 框架,不然，就自己实现; 无非就是 token 存在 redis 里面，去 redis 里面修改超时时间啦。每次请求都分配一份新的 token，这种是mac token 的设计;一般，我们用的是bearer token; spring security oauth也是基于 后者; 前者主要是为了解决防重防请求。



**[**上海-开发-老三**]** token就行, 就是要搞一个凭证 ,证明 你来过 我还要记住你;不断续约 不续约 对不起 过期作废; 主要修改过期时间就行,你的凭证就是会员卡号; 过期了 要给你重新开卡号 ; 你每次来我都要给你开新会员卡。累死我

前端存 用cookie 用其他都行; 过期不过期 后端判断的; 所有的可靠验证都是后端判断。



### 11. mysql查询问题



**[**西安-后端-刘欢**]** 如何查找任意连续30天的数据，只要不间断就好(三月份入住的商户到现在 只要有连续30天交易 就可以t+0提现 ,任意一段时间满足连续三十天)



➤ 问题解答



**[**南京-java-山丘**]**一个笨的方法是 随机数 生成年月日 再+ 30天。

**[**武漢-JAVA-花卷**]**感觉你们有这个业务，应该在数据表中多加一个字段就搞定了。

**[**北京-Java后端-cxwang**]** 存储一个连续天数,考虑下起始时间减去截止时间等于30天了。

**[**北京_程序员_冷咖啡**]** 从3月份开始日期第增，每个日期往后30天，日期去重再count，虽然比较麻烦，但也能查到;

每个月化整为30天，取个位数拼接，拿正则表达式匹配或截取都行，可以得到断点，31号的几个月单独判断，逻辑放在java里，数据库只要取数就行，会比较快如果要长期使用的话就加个字段，然后写个存储加工一下数据，如果只是临时的，就用java，sql写逻辑运算能搞死。

**[**广州-java-柳健**]** 算最小日期与最大日期距离天数当中随机选一个，然后向前推或者向后推，随便够30天就行了,date_add()函数可以随意加减天数。

**[**珠海-java-z4zr**]** 增加一个字段 m，类型number 问题限定了每月为30天 m默认值为0。每次取当前用户前一次记录的m字段，将前一次的日期到今日日期之间的标志位置零 然后当前日标志位置1 。这样查询时查询每个用户在某个时间点前的的最后记录，如果数值是30位都为1 即30日签到满。sql 查询 指定日期 m字段数值为1,073,741,823 即为符合的记录。

**[**上海-java-董董**]** 打标记法 ; 31未二进制，有交易至1, 没有交易算不位至0, 全部位。

**[**上海-开发-老三**]**Java计算开始 结束日期 between and一下，group by 日期和商户 id 的统计，sql 写不出来 那就 Java代码处理。



### 12. PreparedStatement预编译是只能提高查询性能吗



**[**上海-大数据-酸菜鱼**]** PreparedStatement预编译是只能提高查询性能吗

➤ 问题解答



**[**上海-后端-**表情]** 最主要的是能预防sql注入的问题 将参数与SQL语句分离出来，这样就可以方便对程序的更改和延续，同样，也可以减少不必要的错误。

**[**java-刘锦**]** 他只是在查询只编译一次，不管你是多次执行的。这个和查询性能没有太大关系吧。性能还是主要优化sql 语句和所以它能够减少掉对同一句sql解析成查询逻辑的时间吧, 我试了一万条数据i/u耗时并没减少, select快了一倍, 就在想这玩意是不是就只对查询有用。

**[**北京_程序员_冷咖啡**]** 可以提高查询效率，性能得从 SQL 优化入手。



### 13. springcloud 中 feign 的通讯采用的是 RPC 么



**[**武漢-JAVA-花卷**]** springcloud 中 feign 的通讯采用的是 RPC 么？

➤ 问题解答



**[**上海-后端-钱杉杉**]** 是http请求。TCP 和 HTTP 是网络传输协议，而 RPC 远程调用，不区分协议。

**[**武汉-小童**]** http是基于tcp的上层封装。http是应用层协议，tcp是传输层协议，osi七层模型springcloud不是resful吗？

**[**南京-java-戴强**]** 这两天也在看RPC和rest的区别 rest一般都是基于http协议 直接调用服务端 看一下RPC 这是一个简单的RPC框架 https://juejin.im/post/5a0ae97d6fb9a0450a66df2e 直接利用Socket去通信。可以说http rest是RPC的一种 基于http协议 但是我感觉在说RPc的时候 更倾向于底层一点 直接和Socket tcp打交道。

**[**南京-Java-节奏**]**  我理解远程过程调用都可以叫RPC和用什么协议是无关的，根据公司情况和业务来选择吧。RPC需要做到服务注册发现，负载均衡，限流等等面向服务的。

**[**上海-JAVA-知秋**]**  有什么可底层的，本来你一家人在家，一起决定一件事，不需要这么多麻烦，现在分开到各个地方了，同样是这一件事，就需要远程调用一下，这个远程就需要一个协议，你用微信还是QQ，还是电话还是短信，全都随你对比到项目中，原本在一个大项目里快乐生活的小伙伴。逐渐长大，因体量复杂度的原因，被拆分到别的地方去了，各自还离不开彼此，只能找个三方交流工具，没事交流一波心得

**[**北京-Java-威虎山王政委**]**  所谓的协议就是协商、讨论做一件事儿的规范、规则。目的就是大家做事时，效率更高。



- ✅北京-java-犀利豆（公众号 ：犀利豆的技术空间）
- ✅上海-Java-知秋（书籍：《Java编程方法论：响应式RxJava与代码设计实战》）
- ✅上海-开发-老三
- ✅深圳-Java-Ryan
- ✅杭州-java-健
- ✅深圳-后端-lyning
- ✅上海-后端-钱杉杉
- ✅深圳-后端-忍者
- ✅北京-后端-Qzzz
- ✅北京-补位-火柴
- ✅深圳-Java-深秋
- ✅杭州-后端-咸鱼
- ✅太原-后端-郝先生
- ✅厦门-后端-罗号
- ✅杭州+开发+undefined
- ✅上海-java-神驱一梦
- ✅南京-java-山丘
- ✅武漢-JAVA-花卷
- ✅北京-Java后端-cxwang
- ✅北京_程序员_冷咖啡
- ✅广州-java-柳健
- ✅珠海-java-z4zr
- ✅上海-java-董董
- ✅上海-后端-表情
- ✅java-刘锦
- ✅南京-java-戴强
- ✅南京-Java-节奏
- ✅北京-Java-威虎山王政委
- ✅厦门-NLP&Java-AK48
- ✅杭州-Java-hexsmith
- ✅北京-后端java-互联网
- ✅北京-Java-Julian
- ✅北京-JAVA-Waters
- ✅福州-java-龍
- ✅济南—后端—释怀
- ✅西安-后端-刘欢
- ✅上海-大数据-酸菜鱼
- ✅杭州-后端-梁桂钊（公众号 ：服务端思维）

## **周报 No.74（2019年）**

**[深圳-后端-lyning]** 请教一个问题，很多类型的系统都会有地址管理，地址包含了省市区，可能还提供了通过关键字查询等，通常这些数据应该是自己创建并管理，还是通过一些第三方的渠道获取呢？而且这个地址组件，可能很多功能还会用得上，更像是一个全局通用的组件?



➤ 问题解答



**[杭州-后端-梁桂钊]** 第三方绝大多数是付费的，因为省市区会略有变化，所以是动态更新的。不过，一般变化不大的。一般是做法还得自己维护居多。

**[广州-Java-挖坑的张师傅]** 我们是从国家统计局爬取的。

**[北京-java-犀利豆]** 先找地图api看看？

**[深圳-后端-lyning]** 我以前都是这么做的，现在觉得，那样子有点傻，换个项目或产品，又得重新导一次数据，难到做成微服务比较方便。

**[杭州-后端-梁桂钊]** 可以考虑做成富客户端。就是你把核心能力抽离出二方包，由这个二方包去屏蔽业务细节，底层可以去自己读数据库或者接口调用，利用宿主服务的计算资源。也不一定就是数据库，如果内容固定不变，你自己生存本地的json文件就好。

**[厦门-后端-石头]** 前端缓存要考虑更新问题，如果前端更新简单，直接改数据文件；如果前端更新成本高（比如app），那就要考虑弄个更新接口

**[北京-java-犀利豆]** 富客服端，指的应该是服务的调用方是富的，不是前端。先用起来，等不满足了再自己搞。



### 2. 单元测试探讨



> 后端圈① [2019-07-09]



**[深圳-后端-lyning]** 做一个小调查，大家在开发过程中，有写单元测试，且单元测试没有荒废的，举手？



➤ 问题解答



**[上海-后端-知秋]** 如果需求变动过多，测试驱动直接无视。需求频繁变动，那就不要讲测试，浪费感情。同时，团队的协作度，很多人是没有这种培训机会的。绝大多数团队的需求分析阶段太短，导致他们的需求变动十分频繁，单测只会让团队觉得鸡肋。测试用例是我们的开发工具，而不是我们的负担，是我们提高代码质量的一道保障。我们开发过程中往往会衍生出一些新的需求，这些需求加入敏捷管理里面，而不是随便接收外来需求，敏捷动的是小手术。当下已经是微服务，模块化开发了，灵活性很足，假如你的需求依然变动很大，真的要想想自己对这个项目的认知了。

**[广州-后端-米豆腐]** 维护成本高，而且接口设计不规范的话。测试一个方法光 Mock 都得大半天。测试会跑自动回归代码。所以开发接口变动，测试的自动化代码也得维护一遍

**[北京-java-犀利豆]** 单测的左右，就发挥在，改代码的时候，能够收敛测试的时间。我有一个观点就是强制单测，可以强迫 rd 写小类，小方法，写可测的代码。历史原因，以前没有单测，要慢慢加，我们逼着中台开发了一个功能就是统计增量代码的单测覆盖率。改有单测覆盖的代码，心智负担小很多。也减少 qa 回归到工作量。

**[深圳-Java-Ryan]** 以前，单元覆盖率必须达到80，然后不行就打回，大概一天写一个 API 吧。现在，几乎不写单测，一会儿写一个 API 吧。是的，但是很多时候变成政治性任务了，所以我是提倡分阶段分场景考虑这个问题。

**[杭州-后端-梁桂钊]** 大家有考虑实现或者使用第三方单元测试代码生成吗，然后自己再补一补？其实，市面上有这样的工具，不过是付费的。底层h2，外部mock，搞起来。

**[福州-后端-郑臣]** 单测和 API 文档也经常列入，开发计划时间评估里面，就是有时候时候容易被砍掉时间。认真写单测和文档的程序员都是业界良心，前人栽树后人乘凉，接手的兄弟可能就不会哭着喊着背锅侠了。

**[Snake]** 我觉得单元测试，在互联网企业里，dao 层如果写 sql，是有必要加。到时候切换数据库，比如oracle -> mysql ， 可以起很大作用。

**[北京-后端-张帆]** 单测不单测放一边，反正 spring-data-jpa 真心好用，简单的 crud 不用写，复杂的可以 QBC Spring 封装的清晰简洁，写起来也不容易出错。



### 3. spring data r2dbc 探讨



> 后端圈① [2019-07-09]



**[上海-后端-知秋]** https://docs.spring.io/spring-data/r2dbc/docs/1.0.x/reference/html/#reference



➤ 问题解答



**[小马哥]** 就是典型的 Rx API 封装。其实流式编程，还是要在网络层做，数据部分推送部分操作。它这个还是通过 ResultSet 来实现，数据已经 ready。相当于把 Iterator 变成了 Stream。

**[上海-后端-知秋]** Spring webflux 只是针对 Spring web 在 Reactor-Netty 上做的妥协的产物。不够精简，反而拖累了系统。

**[北京-java-犀利豆]** 后端应用最耗时的在数据库调用，结果这一步却是阻塞的。所以用上了rx，提升不明显。这样理解对不对

**[小马哥]** 差不多，主要的症结在于客户端需要等待服务端的结果。

**[上海-后端-知秋]** 阻塞不可避免，但在全局来看它是异步就成，将必要的资源用在对的地方，这就是调度存在的意义。

**[小马哥]** 只要是同步，所有的套路都没用。

**[上海-后端-知秋]** 假如你使用的是同步，而且访问量又不大，用 webflux 没什么意义，而且还会有拖累。在 Spring Framework 5.2 发行版出来前，更是不建议，没有一个好的事务管理机制在保护。



### 4. mysql 数据库的 wait_timeout 参数



> 后端圈① [2019-07-10]



**[福州-后端-王翌丞]** 问下各位大佬，mysql 数据库的 wait_timeout 参数，默认是 8 个小时，大家在做项目时，有对它进行调整吗？



➤ 问题解答



**[杭州-DBA 杨一]** [浅析interactive_timeout和wait_timeout : http://mp.weixin.qq.com/s?__biz=MzI4NjExMDA4NQ==&mid=2648450722&idx=1&sn=7c1d7db861dc53ca3aa4d4c95772d5c6&chksm=f3c97e48c4bef75e18c4dd5a53635dd4c449a4a73e71ef31dae67a9c155f2f946224d65e45ad&mpshare=1&scene=1&srcid=#rd]。一般建议 大于 dal 层面设置的时间 ，8h 是有点长的 ，连接数量大了，会占用大量内存。比如我们推荐设置 3min - 5min。

**[福州-后端-王翌丞]** mysql 服务器内存和连接数一般是个怎么样的比例关系，有实际测试过吗？比如 8g 内存，支撑 1000 个连接数，会有问题吗？

**[杭州-DBA 杨一]** 一个链接按照 5-10m 好了。



### 5. threadpoolexecutor异常



> 后端圈① [2019-07-12]



**[上海-后端-sion]** 调用代码构造 threadpoolexecutor 的时候 coresize 根据 cpu核数*2 和 maxsize 指定为 20 到生产部署后，运行起来 core size 最终结果大于 maxsize 然后异常了？



➤ 问题解答



**[北京-后端-张帆]** 抛出 NoClassDefFoundError 得一种情况是在 Java 虚拟机在执行 <init> 时在 <init> 中抛出了异常，导致 <init> 失败。而作者是在创建 一个静态 final 量时出的异常，静态 final 量的创建是包括在 <init> 里得，因此匹配了这种情况，可以看这个文章 https://www.baeldung.com/java-classnotfoundexception-and-noclassdeffounderror

**[harry]** 好几种情况呢，主要是 coresize 大于 maxsize 这是个坑。



### 6. 集群监控



> 后端圈② [2019-07-10]



**[北京-后端-ren]** 写一个 jar 起一个程序，定时调用 yarn 去获取 spark 状态，来监控 spark 程序，但是，如何保证自身进程不停，有没有好的方案？我能想到的，就是类似于 redis 集群模式，起三个同样的程序，不同端口，三个程序互相通信，有一个程序停了，就重新启动一次。



➤ 问题解答



**[北京-后端-张帆]** 使用 pm2 来保证 Spring Boot 应用稳定运行。https://www.ddhigh.com/2017/07/31/spring-boot-pm2.html。https://www.zhaokeli.com/article/8312.html nodejs 使用 pm2 进行进程管理,自动重启,袒护其它命令行程序。

**[北京-java-犀利豆]** 直接写在 tomcat里面 定期 ping 一下 ip，就知道还或者没有了。



### 7. DDD探讨



> 后端圈④ [2019-07-10]



**[深圳-后端-yee]** 想问各位大佬一个问题，在自己的业务中明确定义几个领域模型：VO、BO、DO、DTO 了吗？



➤ 问题解答



**[北京-后端-程超]** 首先纠正一下啊，DDD 中并没有明确说有 VO，BO，DO 等，这些不管是领域驱动，还是 Spring 似乎形成的一个规则而已，并不是用来建模用的。mvc 分层架构用的非常多。DDD 真正有说明的是实体和值对象的定义。实体和值对象都是针对场景的，不同场景下互相转化。address 对象也不能完全定义为值对象，如果对于订单来说可能是值对象，因为订单不关注地址到底是哪个人，如果是配送部门需要区分不同的收获人地址的时候就是实体。ddd需要做大量的训练才能玩，只是按照概念去套，最后就四不像。而且 ddd 出来这么多年了，为什么到了微服务才真正火起来？单体分布式时代，就有很多人搞了，但 ddd 对团队要求较高，而且实践起来较复杂，尤其 spring 出来后用的贫血模型，大家发现这种模型对于中小项目非常适用，分层简单，扩展方便，所以就火了。但是现在微服务时代，很多公司其实也并没有用 ddd 的战术模型，也就是实体值对象这些，而是大量使用了战略模型，通过问题域和事件风暴的方式，找到了核心域和限界上下文，从而帮助我们拆分微服务。

**[上海-后端-知秋]** 简单问题复杂化，这才是常见病，最关键的是喜欢拿自己拿捏不准或者根本不理解的东西来束缚自己，反而更不会写代码。把抽象的东西放回到现实层面，很多其实就是管理，比如公司管理，公司大了就要分层级，上下职责的边界，职位的定义等等。每个人所处的职位就是一个微服务，他所具备的能力要有他的独特性，其次也要有他在组织里的定位，上下文与接口设计，是否可拆卸，微服务思想不仅仅用于分布式架构设计，同样适用于底层库的开发。

**[杭州-java-健]** 以前只有前后台，一个公司相关的业务平台，每次都需要重新创建后台应用。现在话就是把DAO那些沉淀成一些共用的基础服务。 每个中台可以快速根据基础服务实现业务。 感觉有点面向api编程的感觉。差距肯定有的。 你soa架构项目。你新开个业务系统，你可以复用的东西基本没有。如果做的好，以前dao层可能有部分用。soa和中台，考察的不是代码，更多的是底层数据库模型。 你soa，多个系统各自表库给别人用。中台就是整出一个通用的模型，然后提供针对模型操作的一些服务。然后不同业务系统和条线根据这些系统提供的服务实现自己的需求。中台是业务，中台和基础平台交互。 基础平台的数据库多个系统通用一份。基础服务类似于dao，中台类似于service。你soa关注的是，两个系统之间的调用，两个系统的数据库是自己建的，表和模型都属于自己系统。 SOA 是因为每个项目混乱各种 http webservice 这种调用。将这些调用统一起来，统一配超时时间，异常处理，负载均衡。在SOA的背景，每个系统都是自己单独维护，自己建数据库 ，服务A和服务B 可能都管理商品或者物流，自己管理自己的。中台 是将商品和物流抽数据，服务A 和服务B，统一去基础商品中心维护商品。SOA关注点是服务治理，是项目中散落的各种服务调用，和调用失败，超时，异常处理的处理。这些东西乱七八糟的。为了是解决这个问题。 中台是为了解决，多个系统同时维护一共共用的业务数据，就像天猫，淘宝，1688 可能都要维护用户，商品这些信息。将这些抽取出来，大家维护到一块。指导谈不上，就是简单切磋，技术的边界很难划分，每种技术和其他技术都多多少少沾点边，非要靠也能沾上。 更多的我们要理解这种技术所要解决的业务场景，在不理解业务场景的情况下，光扯技术有点不切实际。以阿里为例，阿里商城有天猫，有淘宝，有1688。如果每个商城都自己维护用户，维护商品，维护收货地址，那么三个系统之间要无限的同步数据。 最好的办法就是将共用的数据抽取出来，类似的功能和模型抽取出来。 就是一个求同存异的架构。 如果有类似场景的可以再考虑中台这种模式。大部分SOA架构的关注点并不在多个系统的数据需要同步的问题。 而且有时候也只是部分数据的同步，没必要在数据库底层抽取到一块，而且很大概率也抽不了。他们关注点更多的是不同系统之间的调用，就是关于RPC的一些点，负载均衡，限流熔断。 但是中台架构，可能默认包含SOA的一些技术功能，但是他们的业务关注点并不在调用。而是将多个业务类似、有关联的系统，抽出一份可以共用的数据模型和底层，共同访问和维护。更多关注数据统一，避免同步的问题。技术这东西边界太模糊了，我们经常讨论起来3.5天没结果，仁者见仁智者见智吧。 可以理解为中台是 soa 的衍进和未来趋势，但是不是每个每个 soa 项目都需要向中台发展的的。soa如果说是技术架构，那么中台更偏业务架构。中层实现功能模块复用，底层实现数据共用，而且可以在复用的基础上实现求同存异，这才是一个好的架构。



### 8. on duplicate key update



> 后端圈④ [2019-07-12]



**[北京-打杂-火柴]** 现在遇到一个线程安全问题 就是我前端或者接口传来一批数据(List) 插入的时候需要根据这个数据的 factoryId 进行判断,如果这个id存在说明是更新操作,如果不存在则进行插入.但是问题是,如果这个地方,如果有两个线程同时往里写入,A 执行判断是否存在 factoryId,不存在,向里面插入数据,线程B此时也判断是否存在factoryId,如果不存在,也向里面插入数据,那么自然就会连续插入两次.实际上后进入的数据应该执行update操作而不是insert操作.这个地方如果不使用分布式锁,如何处理比较好?如果对这个地方使用synchronize的话,如果能将锁粒度细化,尽可能减少阻塞其他线程.使用JCP?



➤ 问题解答



**[上海-后端-myths]** 不用 generator，手写个sql好了。insert xx on duplicate key update ...



### 9. 读写分离如何实现



> 后端圈⑤ [2019-07-09]



**[上海-全栈-我的代码有毒]** 有同学了解 mysql 的读写分离是怎么做到读请求都打到从节点上的吗？



➤ 问题解答



**[深圳-后端-钟惠雄]** 有兴趣可以看看源码，工作流程大概是中间件读取启动配置文件和其它配置并启动，监听客户端请求；2.收到客户端新建连接请求后，中间件经过用户鉴权和连接池判断连接数是否达到上限，确定是否新建连接；3.连接建立和认证通过后，接收客户端发送来的SQL语句，并进行词法和语义分析，对SQL语句进行解析，分析SQL的请求类型，必要时改写SQL，然后选取相应的DB并转发；4.等待后端处理查询，接收处理查询结果集，进行合并和修改，然后转发给客户端；5.如收到客户端关闭连接的请求，判断是否需要关闭后端连接，关闭连接。

**[上海-全栈-我的代码有毒]** 你说的这个应该一个sql语句的执行流程呀，这个属于db proxy做的事情，但是感觉好像不是读写分离的

**[深圳-后端-钟惠雄]** db proxy要做到读写分离也是要去解析sql，转发到后端的db去执行的

**[南京-后端-关河]** aop注解，自己决定走哪个库，但是这个不通用，解析 sql 来的比较通用。





- ✅**上海-Java-知秋（书籍：《Java编程方法论：响应式RxJava与代码设计实战》）**
- ✅**北京-后端-张帆 （博客 ：Since1986 https://since1986.github.io）**
- ✅**北京-后端-程超（书籍：《可伸缩高可用微服务架构》）**
- ✅**小马哥（书籍：《Spring Boot编程思想》）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**上海-后端-myths（博客 ：https://blog.mythsman.com/）**
- ✅**上海-全栈-我的代码有毒**
- ✅**杭州-DBA 杨一（公众号 ：yangyidba）**
- ✅**广州-Java-挖坑的张师傅（掘金小册 ：JVM 字节码从入门到精通）**
- ✅**北京-打杂-火柴**
- ✅**深圳-后端-钟惠雄**
- ✅**福州-后端-郑臣**
- ✅**Snake**
- ✅**深圳-后端-lyning**
- ✅**harry**
- ✅**上海-后端-sion**
- ✅**深圳-Java-Ryan**
- ✅**福州-后端-王翌丞**
- ✅**厦门-后端-石头**
- ✅**杭州-java-健**
- ✅**广州-后端-米豆腐**
- ✅**深圳-后端-yee**
- ✅**南京-后端-关河**
- ✅**北京-后端-ren**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## 周报 No.75（2019年）

### 1.  页面打开比较慢如何排查 

> 云原生后端技术圈①
>
> 前端  [2019-07-16] 



**[北京-Java-刘新]**  大佬们，请教个问题哈。我们一个内部商城首页打开将近10多秒非常难，这个问题该从哪些地方排查啊。用什么方式么



➤ 问题解答



**[深圳-Java-Ryan]**  webpagetes，统计静态文件和API的耗时，然后就是的分别优化了，该合并的合并，该延迟的延迟。首页白屏了解下，解决方案是减少tti，使用类似SSR的方式

**[北京-java-犀利豆]**  Chrome 不就能看





### 2.  mysql 是否应该部署到docker中呢？

> 云原生后端技术圈①
>
> Docker  [2019-07-16] 



**[深圳-后端-lyning]**  请教一个问题，我刚刚通过 docker 安装和启动 mysql，docker 内的容器都可以访问运行在 docker 中的 mysql；如果 mysql 单独安装在主机上，那么 docker 容器中的服务要访问 mysql 就变得很繁琐，网上很多解决方案，头疼的是不同操作系统、不同 docker 版本解决起来可能还不太一样。 就 mysql 应不应该独立于 docker，还是交给 docker 管理这个问题，有人调研过吗？方便讲讲吗？



➤ 问题解答



**[深圳-Java-Ryan]**  我们两个云，一个电信的，一个aliyun，用VPN打通，然后买的aliyun的rds，比如IP是192.168.10.12，docker的网络也许是10.1.10.2，可以配置网络打通，都是内网，不用担心公网带宽

**[上海-Java-老三]**  数据库扔docker 生产上 绝对禁止，docker仅建议部署轻量级的应用，soa的那种或者所谓的阿里的中台的玩法，不建议。我维护的项目改一个东西 都要发布几十个应用，没有改成微服务端的设计，service层共用一套，这个要严重避免，可以参考阿里的四层设计原则：dao manager service  controller，尽可能的分四层吧。我是体会到舒服的感觉了，网上找下阿里的四层分法 严格遵守规则 必须要严控review 代码，不让会乱七八糟 五花八门

**[上海-架构-ak47]**  o2o 看你的业务和数据量复杂度啊，简单不用上什么微服务啊，mvc，就可以了

**[无锡-Java-何大葱]**  关于架构分层《高可用可伸缩微服务架构》这本书上有讲





### 3.  网页刷新很慢，现在定位到一个文件加载的慢，但是再进一步怎么查，是哪里的问题呀 

> 云原生后端技术圈①
>
> 前端  [2019-07-17] 



**[北京-Java-刘新]**  大佬们，请教个问题。我们网页刷新也很慢。现在定位到一个文件加载的慢，但是再进一步怎么查，是哪里的问题呀？



➤ 问题解答



**[上海-imhere]**  才24kb怎么要9s，是不是引cdn文件了？ cdn文件加载的慢？

**[北京-Java-刘新]**  怎么看加载了cdn呀

**[上海-imhere]**  看看你页面里有没有引用带完整连接的文件

**[深圳-后端-忍者]**  如果走了CDN缓存，请求的地址会被替换成CDN里配置的，你这个应该是没走CDN

**[北京-Java-刘新]**  没有用cdn

**[深圳-后端-lyning]**  可以去后端排查了

**[西安 后端 elinkm]**  查配置文件





### 4.  你们脚手架怎么做的? 

> 云原生后端技术圈①
>
> Tools  [2019-07-16] 



**[深圳-Java-Ryan]**  你们脚手架怎么做的？



➤ 问题解答


**[深圳-Java-Ryan]**  我现在公司 暂无脚手架，纯人力

**[上海-架构-ak47]** slife 和 JHipster 可以了解一下





### 5.  fastjson null转换问题

> 云原生后端技术圈①
>
> Json  [2019-07-17] 



**[杭州-Java-菜鸟]**  大佬们fastjson 能不能在json转对象的时候把这个"null" 转为null 而不是字符串"null"



➤ 问题解答



**[深圳-物联网-浅色杀]**  你可以自定义解析类，自己设置为null，ValueFilter PropertyFilter





### 6.  两个单向链表链节点查找问题

> 云原生后端技术圈②
>
> 数据结构  [2019-07-16] 



**[北京-后端-ren]**  刚才去滴滴面试，两个单向链表分别是l1和l2，有一个连接点，代码如何找到这个node？



➤ 问题解答



**[北京-java-犀利豆]**  最简单的办法就是写两个 for 暴力查

**[杭州Java开发工作的小菜鸡]**  找到了node的怎么比较呢？地址？值？还是？

**[上海-后端-知秋]**  比较地址就好，这是同一个对象，值比较那就涉及到链表查找，比较了





### 7.  zk的watcher通知丢失问题

> 云原生后端技术圈④
>
> zookeeper  [2019-07-15] 



**[北京-Java-MichaelFreeman]**  各位大佬，请教个问题，zk的watcher每次通知后需要重新注册，这会导致发生通知丢失的概率，请问这个问题有什么好的解决思路？



➤ 问题解答



**[福建-王波-Java]**  有个netflix写好的客户端，它内部帮你重新注册了，忘记叫什么名字了，很好用的

**[北京-Java-MichaelFreeman]**  问题的产生是重新注册期间如果有通知

**[福建-王波-Java]**  你的变更会这么频繁的吗，那就你重新注册的时候请求再请求一次，反正zk的通知接口也是告诉你一个路径，不告诉你内容的，这样可以保证拿到的是最新值

**[北京-Java-MichaelFreeman]**  感觉要写一个轮训去做补偿才能解决这个问题





### 8.  List lamba 求平均值

> 云原生后端技术圈④
>
> Java  [2019-07-18] 



**[广州-java-veronah]**  List lamba 求平均值怎么写？



```
OptionalDouble averageSalary = ids.stream().mapToDouble(c->c.doubleValue()).average();
```



➤ 问题解答



**[北京-java-犀利豆]**  toDouble不又损失精度了。先算出总数，再除，这样是有问题的，用double 算平均数

**[广州-java-veronah]**  BigDecimal的doubleValue() 可以转为 double

**[北京-java-犀利豆]**  问题出在，使用double运算，会丢失精度，除的时候要指定精度，否则除不尽还会抛异常

**[杭州-java-健]**  bigdecimal 构造方法 传string和double也不一样呢





### 9.  String不传或者传null，后台如何处理？ 

> 云原生后端技术圈⑤
>
> Java  [2019-07-16] 



**[北京-java-Sam]**  咨询大家一个问题 前端创建对象的时候 如果String不传就会为null 但是数据库String 写入null就会报错 你们一般怎么解决 后台对null 全部进行null判断吗？



➤ 问题解答



**[武汉-小童]**  数据库忽略为null的字段更新

**[北京-java-犀利豆]**  既然数据库不支持null，就是要必须存值？

**[北京-后端-张帆]**  你的业务要不允许这个字段存空值，那为什么要让前端传空值过来呢，我觉得可以让前端加个验证从前端解决掉空值，后端同样加个验证，如果由于某种原因前端的验证未生效那么就直接抛出异常，也就是后端 fail-fast

**[广州-java-柳健]**  用mybatis的话，sql中字段判空一下





### 10.《UNIX网络编程》应该怎么学？

> 云原生后端技术圈⑤
>
> 网络编程  [2019-07-19] 



**[北京_后端_石将从]**  我想问下大家怎么学习网络编程的，最近在看《UNIX网络编程》卷一，你们是直接执行源码还是手动再敲一遍？



➤ 问题解答



**[上海-Java-老三]**  手敲，这样有感觉；还有基于纯净的Linux系统，macos去写这个，太多库不兼容，目录也会不一样，坑死

**[北京_后端_石将从]**  之前学过一点，确实发现了你说的不兼容[捂脸]后面忙于其他事就不学了，现在想重新开始，这书这么厚，得好几个月才学完吧？

**[上海-Java-老三]**  用不了多久，满打满算撑死一个月，时间自我规划好吧。里面主要还是函数式的的调用，api的介绍





### 11.  多线程环境下指令重排问题

> 云原生后端技术圈⑤
>
> 多线程  [2019-07-19] 



**[java-刘锦]**  不是在多线程环境下，会不会出现指令重排？



➤ 问题解答



**[上海-后端-钱杉杉]**  会出现的，如果没有数据的依赖，编译器和CPU缓存会做指令重排序优化，但是重排序的结果，多线程下会跟单线程保持一致

**[重庆-后端-谭鹏]**  会出现 指令重排是操作系统的优化 提升程序执行效率但是不会影响程序的执行结果 所以单线程下没有线程不安全的说法





### 12.  微服务中，技术与业务权重探讨 

> 云原生后端技术圈
>
> MyBatis  [2019-07-20] 



**[杭州-后端-梁桂钊 ]**  大家觉得微服务中，技术权重大，还是业务权重大？



➤ 问题解答



**[上海-后端-知秋]**  业务

**[上海-架构-ak47]**  业务权重>技术权重

**[上海 后端 sion]**  为什么不是技术权重大？ 微服务、单体应用、分布式，都是技术问题，不是业务问题吧。 当然，技术是服务于业务的，业务规模起来了，往往单体应用不够抗，性能问题、开发协调问题、发布问题等等就出来了，所以微服务化改造。

**[广州-Java-Chris]**  @上海 后端 sion 同意你的观念

**[上海-后端-知秋]**  @上海 后端 sion 业务都实现不了，谈什么技术

**[上海-Java-老三]**  @上海 后端 sion 还是业务主导，拆分首先考虑是业务场景，而后是技术问题

**[上海 后端 sion]**  技术是服务于业务的，但是微服务这个是属于技术范畴的，业务理论上不关心我们技术是怎么做到的。理论上，仅仅理论上，如果有足够强悍的硬件成本和人员成本，是不是可以不为服务化呢？

**[上海-架构-ak47]**  关键你的微服务化，需要解决的是什么痛点，如何改造，我的经验是逐步迁移对于老的系统，可以非微服务和微服务并存！逐步改造这样子

**[上海-Java-老三]**  能适应到公司的拆分力度 个人觉得是最好的。我也在公司这周讨论过这样的问题：人手局限、机器、成本，很多时候 我们不得不去妥协方案，其实用了sc不见得一定是微服务了，这样的演变需要过程

![91c38d90abc3226109ec45930ba211b7.jpg](后端圈问答全集.assets/1563753994535-b83c29d1-dca1-434d-8e4a-ca3e7e2dec79.jpeg)**[上海-后端-知秋]**  这是Kong这家公司CTO的分享片段。无论是国内还是国外，大家的认知其实都是一致的





### 13.  单体项目过渡到微服务架构的探讨

> 云原生后端技术圈
>
> 微服务  [2019-07-20] 



**[杭州-后端-梁桂钊]**  在实际开发过程中，我们该如何从已经存在的单体项目过渡到微服务架构，有具体的落地实践方法没，落地过程中会遇到哪些困难，该如何解决，技术选型的依据是什么？大家可以一起探讨下。



➤ 问题解答



**[上海-后端-知秋]**  假如一个企业想要落地云原生，这就是你必须要经过的路

**[广州-Java-Chris]**  我们现在都是单体架构，一直被吐槽卡，用户量上来直接加机子的那种，现在都是一台机子跑两个API接口服务tomcat，8核16G

**[北京-后端-Wayne]**  我的经验是大多数项目会死得很早，微服务？不存在的，我们已经快把去年做的所有业务都淘汰了，或者都更新迭代了，尤其是对创业型小公司，有钱有闲的可以夯实了走

**[福建-Java-峰]**  先实现业务 再考虑性能吧，估计都这样

**[杭州-后端-小黑]**  单体->Dubbo->SpringCloud，独立应用->中台化，痛并快乐着

**[上海-后端-知秋]**  千万注意，不要觉得自己会用个工具（比如sc），就觉得自己掌握了微服务架构，自己就是一个架构师了，当下很多失败的案例就是自己的底子不够，还喜欢玩，然后玩脱的

**[深圳-后端-lyning]**  我个人认为，不考虑迁移，直接搞一个微服务开发环境，测试环境、运维环境，就有够受的，更何况还要碰没有写测试的代码，sql 解耦，数据库迁移，代码库迁移，基础设施搭建，运维设施搭建（大块头），监控，测试，发布。可以做，前提是，要先把业务梳理清楚，再梳理现状，看看怎么抽，是先迁移核心业务（可能风险很大），还是先把非核心业务迁移出去，或者把因某些瓶颈而需要独立演化的业务抽出去，真得一点点来，前提要把要做什么搞清楚，再思考怎么做；还有一点，微服务很多人对这个词的理解完全没对齐，就像如图所示

​        ![f3ef196cdd6a9183c5dfc3e8d459fe6d.jpg](后端圈问答全集.assets/1563752274281-07990308-011d-423c-846c-f714496418e6.jpeg)

**[深圳-后端-lyning]**  对了，服务治理 也是大块头，不是搞搞 docker 就行的

**[上海-后端-知秋]**  微服务看似是在针对代码，它更注重的是人，对人员的职责与管理都要求比较多，如果这块儿过不了，首先你团队都是混乱的，微服务看似是独立分开的，其实依然是全局里的一个轴承，往往是牵一发而动全身，我们的SPI的设计就要求有比较高的素质

**[阿飞哥]**  单体转微服务架构的改造，难度最大的还是数据的划分(服务边界基本就是数据边界)和在线迁移，最终还是基本功。

**[深圳-后端-lyning]**  迁移的实施对象是人，注重人是很正确的

**[上海-后端-知秋]**  @阿飞哥 基本功还是要落到人员素质上

**[杭州-后端-梁桂钊]**  我觉得素质这个比较虚，更多可以理解为边界上，边界的合理性和利益的均衡性

**[深圳-后端-lyning]**  服务边界它的难度在于，你没办法说什么就是正确的，什么就是错误的，只能凭经验说目前这样比较适合自己的业务，之后可能还会变，它属于架构层面要考量的，非常重要，架构本身就是高度抽象，高度抽象本应该更安全，稳定的，变动带来的成本可能非常高

**[阿飞哥]**  人的能力素质在任何地方都是最正确的，我只不过从做这件事本身的角度

**[杭州-后端-梁桂钊]**  不同的服务可能由不同的团队开发与维护，实际场景下，微服务的便利性更多的在于团队内部能够产生闭环，换句话说，团队内部可以易于开发与维护，便于沟通与协作，但是对于外部团队就存在很大的沟通成本与协作成本。如图所示，团队 A 对于服务 C 的了解是一个黑盒，我们不知道它是单体服务还是微服务，它部署了几台服务器，需要依赖哪些下游服务，是否存在限流、熔断和降级策略，以及如何接入。如果我们需要确认这些问题，通常情况下，都需要人工协作和确认。

有的时候，团队对项目具有绝对的所有权，从而因为团队利益上的考虑而出现生产上的微服务是一个“半成品”。笔者相信这种情况并非个例，而是绝大多数的常态。 现在，我们来看一个案例。团队 A 考虑到功能的复用性而开发了一个“互动组件”，其中包括 “评论模块”功能。此时，团队 B 并不知情也开发了一个类似的“互动组件”。而团队 C 也有这个需求，它知道团队 A 有这个“互动组件”，希望可以复用，但是由于这个“互动组件”在设计的时候更多地考虑了团队 A 的当前业务，没有很好的复用性，例如不支持“评论盖楼”功能，而由于团队 A 出于当前其他项目的进度原因无法马上提供支持，团队 C 评估后决定花一周时间自己开发一个符合自己业务需求的“互动组件”。此时，各个项目团队各自维护了一个“互动组件”。 这个案例中，由于团队之间的职责与边界导致了服务的复用存在局限性，甚至造成各自为战的局面，这种情况一般需要公司层面进行规划和统筹。无独有偶，团队 A 和团队 B 都在做工单系统，但是两者需要融合，为了保证两个团队的既有利益，他们并不是将原来的架构打破进行融合，而是在原有的基础上确定领域边界。 此外，假设外部一个 RPC 接口不太稳定，一般的做法就是去分析不稳定的原因，但是跨团队合作的情况下，外部服务可能就是一个黑盒，并且团队之间可能就是一堵隐形的墙，那么沟通协作成本是非常大的，此时需要有人来全链路牵头让大家的利益达成一致。那么，当下最高效的方式可能就是团队内部通过其他手段来规避这个问题，例如冗余缓存或者接口适配。因此，它也许就是当前组织结构和环境下业务价值的最大化的较优方案，我们需要适应当下，展望未来。说到接口适配，其实还有一个非常常见的微服务架构设计：适配器服务模式。通常情况下，外部服务给我们的消息体格式和我们所需要的不一致，此时，我们去推动他们改造显得不太现实，那么，为了保障我们的业务逻辑不引入大量的业务适配逻辑，我们就会引入适配层 （适配器服务），它将外部服务的消息体适配成统一的标准格式，然后再向上暴露服务，例如退款适配、物流适配等。 因此，公司组织在很大程度上影响了服务边界的确定。通常情况下，我们在自身团队的边界内做领域划分，尽可能的满足业务需求，虽然从技术层面来看这个是一个“半成品”，但是它也许就是当前环境下业务价值的最大化的较优方案。所谓分久必合，当大家看到它有足够大的价值后，在考虑进一步融合也是一个不错的主意。

**[深圳-后端-lyning]**  冰山理论，能力是看得到的，能力不行可以通过很多手段来提高；素质，态度，价值观这种隐藏比较深，很难发生变化，但也直接影响到一个人的行为。 你说他虚吧，确实很虚，因为很难改变，你说他不重要的吧，但又确实很重要

**[阿飞哥]**  我们现在做一次迁移微服务的操作，深刻意识到:以前假如把单体设计的更优秀是多么重要

**[深圳-后端-lyning]**  @阿飞哥 应该是，人的基本功有多重要

**[阿飞哥]**  人的重要性 在任何场景下的讨论 都是100%正确的

**[上海-后端-知秋]**  团队的能力往往体现在自己leader这块儿了，但leader到底能不能驾驭，其实一个人往往还是不行的，某些方面他需要一个团队的人来共同决定，所谓群策群力，当事情都压在一个人身上，而其他成员又得不到任务的分配或者无法取得信任，那这个情形，会造成微服务开发形成架构级别的阻塞，有点类似于分布式事务，其他地方需要你这个团队的服务，但你久久提供不了，如果一个团队还好，多个团队并发出现这类的问题，那就是一个超级复杂的问题

擒贼先擒王，一旦王忙的不可开交，那就废了，所以管理者要更加倾向于人员管理与功能设计上的管理，而不是轻易切入到代码细节的开发中。

我们有我们的代码标准，合理的review和合理的测试驱动开发，也应该是微服务开发具备的基本功，因为功能粒度足够小，也足够明确，如果此时，你的测试驱动还不能落地，那说明你的需求做的是多么稀烂，程序员切忌不要自己凭空造需求，这样只会增加项目耦合

**[上海-java-hu]**  按业务功能拆分，网关负责鉴权，我们用的SRPING CLOUD。至于选选 dubbo 还是spring cloud ，我不太清楚

**[上海-后端-知秋]**  这个只是技术选型而已

​    ![0cbf95b5f1998a7922686917efc33a58.jpg](后端圈问答全集.assets/1563752938306-314361b2-d0d1-4cda-aaf8-a10b5dcddb1f.jpeg)

**[上海-后端-知秋]**  这张图可以给你解释，这张图里表达了一个，重标准，标准之后，你想怎么玩都可以，协议，再快能快到哪里，就和服务器后面的网线一样，你布的和蜘蛛网一样，和布置的很条理，最后在打理的时候，能一样么，多种实现的背后，其实大家的设计思想是一致的

**[福州-创元同锐-王小刺]**  团队目标要一致，大家都觉得要

**[上海-后端-知秋]**  括号里是我补充的一点

​    ![faf7370b5ed75daccad7128ed188d682.jpg](后端圈问答全集.assets/1563753233970-de1afc4a-76d4-4157-a696-57d019cd24fe.jpeg)

**[上海-后端-知秋]**  这个复杂性不仅仅是我们自身管理上的，同样对于操作系统自身内部调度上

**[杭州-java-健]**  首先看有没有微服务的必要，我们上家公司，初创。没有用户，业务变化极快，用了微服务，整个系统臃肿的很。 改个小功能都改半天

其次微服务的时候，业务上如果划分，也就是边界的划分是特别重要也特别头疼的事，把握好划分的界限和颗粒度也是最难做的

**[深圳-php-小飞]**  先抽象好业务吧，然后做拆分。微服务是一套部署方式

**[上海-JAVA开发]**  难点在沟通上。原则上都同意改造。开始干了，各个团队协调配合问题来了。技术选型上找 看不同团队的技术最大公共子集

**[深圳-后端-木木]**  上层领导不看重，只看得业务，难落地。新来的都只想着把以前的丢弃重新开发

**[北京-Java-LWL]**  像我们传统软件行业，微服务很难推动

**[上海-后端-知秋]**  当你的领导不行的话，就压根不要提微服务的事情了

**[深圳-后端-木木]**  哈哈，领导通知就好了。我们新来空降的领导，直接ppt把老板说服了，新开发的微服务，很多基础服务和服务治理都没做好，就急着要上线，上线后，服务治理就够头疼了，微服务容易，服务治理难啊

**[上海-后端-知秋]**  微服务其实很不容易的，业务边界的界定就很需要实力。尤其是对于一个单体系统抽取到一个微服务架构，如何抽，确实需要一个方法论的，包括在抽取过程中形成的微服务治理，也是有一套管理策略的。

一个函数就可以认为是微服务，麻雀虽小，五脏俱全，其实也是在讲微服务

首先我们要在认知上不去将它作为抽象概念，不就是个微小的服务么，能有什么大不了的。你看我们Linux系统中一个个的命令，不就是一个个的微服务，多个命令间的组合可以得到一个全新的服务

✅**上海-Java-知秋（书籍：《Java编程方法论：响应式RxJava与代码设计实战》）**

✅**北京-后端-张帆 （博客 ：Since1986 https://since1986.github.io）**

✅**北京-后端-程超（书籍：《可伸缩高可用微服务架构》）**

✅**小马哥（书籍：《Spring Boot编程思想》）**

🔲**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**

✅**北京-Java-刘新**

✅**深圳-Java-Ryan**

✅**深圳-后端-lyning**

✅**上海-Java-老三**

✅**上海-架构-ak47**

✅**无锡-Java-何大葱**

✅**上海-imhere**

✅**深圳-后端-忍者**

✅**西安 后端 elinkm**

✅**杭州-Java-菜鸟**

✅**深圳-物联网-浅色杀**

✅**北京-后端-ren**

✅**杭州Java开发工作的小菜鸡**

✅**北京-Java-MichaelFreeman**

✅**福建-王波-Java**

✅**广州-java-veronah**

✅**杭州-java-健**

✅**北京_后端_石将从**

✅**java-刘锦**

✅**上海-后端-钱杉杉**

✅**重庆-后端-谭鹏**

✅**上海 后端 sion**

✅**北京-java-Sam**

✅**武汉-小童**

✅**北京-后端-张帆**

✅**广州-java-柳健**

✅**广州-Java-Chris**

✅**北京-后端-Wayne**

✅**福建-Java-峰**

✅**杭州-后端-小黑**

✅**阿飞哥**

✅**上海-java-hu**

✅**福州-创元同锐-王小刺**

✅**深圳-php-小飞**

✅**上海-JAVA开发**

✅**深圳-后端-木木**

✅**北京-Java-LWL**

✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**

## 周报 No.76（2019年）

### 1. Redis watch dog 续租锁

> 云原生后端技术圈①
> Redis  [2019-07-22] 



**[杭州-java-菜鸟]** 使用redisson获取分布式锁，设置了锁的超时时间为10秒，如果实际业务时间超过了10秒，那么watch dog 会续租锁吗？



➤ 问题解答



**[杭州-后端-小聂]** 可以，你无需设置超时时间，默认超时时间是30s，业务执行到1/3时间时，若线程仍在执行加锁业务，故watch dog再次延迟时间到30s，如果你业务执行完，那么你应该手动释放锁，即使没有手动释放锁，到期后，锁自动失效。



### 2. 领域驱动设计

> 云原生后端技术圈②
> 技术设计  [2019-07-22] 



**[北京-后端-ren]** 针对不同支付渠道，接口参数不一致，如何统一数据模型。

例如，支付A渠道使用data字段标识结果集字段，支付B渠道使用result字段标识结果集字段，支付C渠道使用result字段标识结果集字段，那么你在设计一个通用的model时需要如何做？



➤ 问题解答



**[深圳-Java-深秋]** 分成不同的type，配置在动态字段表中，一个配置数据库字段一个配置映射字段，然后用list加载循环mapping成map或者json，页面上一样通过这个配置进行加载。





### 3. 原子写操作

> 云原生后端技术圈④
> Java  [2019-07-22] 



**[北京-打杂-火柴]** 什么样的场景才需要考虑写操作需要是原子的？为什么要这么做？例如 Long和Double 写操作就不是原子的。



➤ 问题解答



**[北京-Java-犀利豆]**Java是跨平台的，所以写代码就要按照jvm规范来，jvm里面 long 和 double 就不是原子的。具体不同平台，具体怎么实现，不用去关注吧。



**[上海-后端-知秋]**jvm给我们适配了各平台的差异性，让我们数据得以统一。我觉得是要使用，而不是你一直纠结于这些。

底层粒度我们真不需要去考虑，我们往往需要考虑的是线程操作级别的粒度。你整这些只会让自己变得越头大，然后也记不住多少。

你既然要研究jvm，那就依据参数去找对应源码，一探便知。



### 4. RESTful 表达动作操作

> 云原生后端技术圈④
>
> REST  [2019-07-23] 



**[杭州-java-健]** restful 接口中，可以很好的解释像新增、修改、查询和列表。那么像一些行为和动作怎么表达呢？比如login。



➤ 问题解答



**[长沙-后端-陈同学]** 通常会开放一些专用接口来操作资源，比如：冻结用户、解冻用户。可将对资源的操作抽象为actions，这样通过HTTP Method + actions 就可以表示多种操作。

例如：冻结用户 PATCH /users/1/actions/freeze。

团队内保持同一规范即可，也可不用actions，例如直接用 PATCH /users/1/freeze



### 5. 数据聚合

> 云原生后端技术圈⑤
>
> 数据聚合  [2019-07-24] 



**[武汉-java-花卷]** 前端需要查后台的数据，先需要去华为云上的A服务里查询到id，然后把id去  azure上面的B服务查到数据,AB服务的代码都是我们自己写的，现在我们有两个方案。

方案1：前端调用A服务接口，然后A服务里去调用B服务。  

方案2：前端两个ajax，先去调用A服务，拿到id以后，再去调用B服务。

这两个方案有很大优缺点么？哪个更好啊



➤ 问题解答



**[上海-后端-知秋]** 你们的第一个服务相当于平台耦合了，这样以后更换云平台的时候会有很大的工作量。我很建议在网关层进行解耦，这样也不会在前端进行不必要的服务暴露，也方便后续的开发。



方案二我不是说了么，你在前端层公开暴露自己的服务，而且两次长http操作，不如内部网的通信稳定。最关键你前端暴露那么多后台服务，一旦迭代，那对应客户端的升级也会更加频繁，也就会产生更多的迭代需求，客户体验极差。



✅**上海-Java-知秋（博客 ：一叶知秋** [**https://muyinchen.github.io**](https://muyinchen.github.io/)**）**

✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**

✅**长沙-后端-陈同学（公众号 ：陈一乐）**

✅**杭州-java-菜鸟**

✅**杭州-后端-小聂**

✅**北京-后端-ren**

✅**深圳-Java-深秋**

✅**杭州-java-健**

✅**武汉-java-花卷**

✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**



## **周报 No.76（2019年）**

### 1. Redis watch dog 续租锁

> 云原生后端技术圈①
> Redis  [2019-07-22] 



**[杭州-java-菜鸟]** 使用redisson获取分布式锁，设置了锁的超时时间为10秒，如果实际业务时间超过了10秒，那么watch dog 会续租锁吗？



➤ 问题解答



**[杭州-后端-小聂]** 可以，你无需设置超时时间，默认超时时间是30s，业务执行到1/3时间时，若线程仍在执行加锁业务，故watch dog再次延迟时间到30s，如果你业务执行完，那么你应该手动释放锁，即使没有手动释放锁，到期后，锁自动失效。



### 2. 领域驱动设计

> 云原生后端技术圈②
> 技术设计  [2019-07-22] 



**[北京-后端-ren]** 针对不同支付渠道，接口参数不一致，如何统一数据模型。

例如，支付A渠道使用data字段标识结果集字段，支付B渠道使用result字段标识结果集字段，支付C渠道使用result字段标识结果集字段，那么你在设计一个通用的model时需要如何做？



➤ 问题解答



**[深圳-Java-深秋]** 分成不同的type，配置在动态字段表中，一个配置数据库字段一个配置映射字段，然后用list加载循环mapping成map或者json，页面上一样通过这个配置进行加载。





### 3. 原子写操作

> 云原生后端技术圈④
> Java  [2019-07-22] 



**[北京-打杂-火柴]** 什么样的场景才需要考虑写操作需要是原子的？为什么要这么做？例如 Long和Double 写操作就不是原子的。



➤ 问题解答



**[北京-Java-犀利豆]**Java是跨平台的，所以写代码就要按照jvm规范来，jvm里面 long 和 double 就不是原子的。具体不同平台，具体怎么实现，不用去关注吧。



**[上海-后端-知秋]**jvm给我们适配了各平台的差异性，让我们数据得以统一。我觉得是要使用，而不是你一直纠结于这些。

底层粒度我们真不需要去考虑，我们往往需要考虑的是线程操作级别的粒度。你整这些只会让自己变得越头大，然后也记不住多少。

你既然要研究jvm，那就依据参数去找对应源码，一探便知。



### 4. RESTful 表达动作操作

> 云原生后端技术圈④
>
> REST  [2019-07-23] 



**[杭州-java-健]** restful 接口中，可以很好的解释像新增、修改、查询和列表。那么像一些行为和动作怎么表达呢？比如login。



➤ 问题解答



**[长沙-后端-陈同学]** 通常会开放一些专用接口来操作资源，比如：冻结用户、解冻用户。可将对资源的操作抽象为actions，这样通过HTTP Method + actions 就可以表示多种操作。

例如：冻结用户 PATCH /users/1/actions/freeze。

团队内保持同一规范即可，也可不用actions，例如直接用 PATCH /users/1/freeze



### 5. 数据聚合

> 云原生后端技术圈⑤
>
> 数据聚合  [2019-07-24] 



**[武汉-java-花卷]** 前端需要查后台的数据，先需要去华为云上的A服务里查询到id，然后把id去  azure上面的B服务查到数据,AB服务的代码都是我们自己写的，现在我们有两个方案。

方案1：前端调用A服务接口，然后A服务里去调用B服务。  

方案2：前端两个ajax，先去调用A服务，拿到id以后，再去调用B服务。

这两个方案有很大优缺点么？哪个更好啊



➤ 问题解答



**[上海-后端-知秋]** 你们的第一个服务相当于平台耦合了，这样以后更换云平台的时候会有很大的工作量。我很建议在网关层进行解耦，这样也不会在前端进行不必要的服务暴露，也方便后续的开发。



方案二我不是说了么，你在前端层公开暴露自己的服务，而且两次长http操作，不如内部网的通信稳定。最关键你前端暴露那么多后台服务，一旦迭代，那对应客户端的升级也会更加频繁，也就会产生更多的迭代需求，客户体验极差。



------



- ✅**上海-Java-知秋（博客 ：一叶知秋** [**https://muyinchen.github.io**](https://muyinchen.github.io/)**）**
- ✅**北京-java-犀利豆（公众号 ：犀利豆的技术空间）**
- ✅**长沙-后端-陈同学（公众号 ：陈一乐）**
- ✅**杭州-java-菜鸟**
- ✅**杭州-后端-小聂**
- ✅**北京-后端-ren**
- ✅**深圳-Java-深秋**
- ✅**杭州-java-健**
- ✅**武汉-java-花卷**
- ✅**杭州-后端-梁桂钊（公众号 ：服务端思维）**